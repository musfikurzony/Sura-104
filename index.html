<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quran Grammar Viewer — Sura</title>
  <style>
    :root{
      --bg: #071226;
      --card: #071827;
      --muted: #9fb1c9;
      --accent: #56b5ff;
      --arabic-size: 2.0rem;
      --bangla-size: 1.0rem;
      --notes-size: 1.02rem;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      width:100%;
      overflow-x:hidden;
    }
    body{
      font-family: "Noto Sans Bengali", system-ui, sans-serif;
      background: linear-gradient(180deg,#081226,#02101a);
      color:#e6f0fb;
      padding:12px;
    }
    .wrap{
      max-width:940px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .brand{font-weight:700}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .select-sura{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);
      color:inherit;
      max-width:180px;
    }
    .settings{
      display:flex;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,0.02);
      padding:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.03);
      flex-wrap:wrap;
    }
    .settings label{
      font-size:0.9rem;
      display:flex;
      align-items:center;
      gap:6px;
    }
    input[type="checkbox"]{width:16px;height:16px}

    .sliders{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    main{margin-top:8px}

    .bismillah{
      padding:10px;
      border-radius:10px;
      background:linear-gradient(180deg,#071726,#041224);
      border:1px solid rgba(120,150,190,0.06);
      text-align:center;
      margin-bottom:10px;
    }
    .bismillah .ar{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:1.25rem;
      direction:rtl;
      text-align:center;
      line-height:1.7;
    }
    .bismillah .bn{
      color:var(--muted);
      margin-top:4px;
    }

    .ayah{
      background:linear-gradient(180deg,#071226,#041018);
      padding:12px;
      border-radius:12px;
      margin-bottom:10px;
      border:1px solid rgba(120,150,190,0.04);
    }
    .ayah-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:8px;
    }
    .ayah-no{
      background:rgba(255,255,255,0.02);
      padding:6px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:0.95rem;
    }
    .ayah-mode{
      color:var(--muted);
      font-size:0.9rem;
      text-align:right;
      flex:1;
    }
    .ayah-line{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:var(--arabic-size);
      direction:rtl;
      text-align:right;
      line-height:1.6;
      margin-bottom:8px;
      word-wrap:break-word;
      overflow-wrap:break-word;
    }
    .translation{
      font-size:var(--bangla-size);
      color:var(--muted);
      margin-bottom:8px;
      text-align:right;
      line-height:1.6;
    }

    /* words grid - full RTL alignment */
    .words-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      justify-content:flex-end;  /* right aligned row */
      direction:rtl;
    }
    .word-block{
      min-width:76px;
      max-width:180px;
      padding:8px;
      border-radius:10px;
      background:rgba(255,255,255,0.01);
      border:1px solid rgba(255,255,255,0.03);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      direction:rtl;
    }
    .word-ar{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:1.25rem;
      text-align:right;
      line-height:1.4;
      word-wrap:break-word;
    }
    .word-bn{
      font-size:0.95rem;
      color:var(--muted);
      text-align:right;
      margin-top:6px;
      line-height:1.4;
      word-wrap:break-word;
    }

    .word-block.active{
      border-color:var(--accent);
      box-shadow:0 6px 20px rgba(86,181,255,0.06);
      transform:translateY(-2px);
    }

    /* grammar panel */
    .grammar-panel{
      position:fixed;
      left:0;
      right:0;
      bottom:12px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:20;
    }
    .grammar-inner{
      pointer-events:auto;
      max-width:940px;
      width:calc(100% - 24px);
      background:#021426;
      border-radius:12px;
      padding:10px;
      border:1px solid rgba(0,0,0,0.5);
      box-shadow:0 8px 40px rgba(0,0,0,0.6);
    }
    .g-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:8px;
    }
    .g-word{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:1.3rem;
      direction:rtl;
      text-align:right;
      line-height:1.5;
    }
    .g-meaning{
      font-size:1rem;
      color:var(--muted);
      text-align:right;
      margin-top:3px;
    }
    .g-notes{
      font-size:var(--notes-size);
      color:#e6f0fb;
      background:#021726;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.03);
      max-height:220px;
      overflow:auto;
      line-height:1.6;
      word-wrap:break-word;
      overflow-wrap:break-word;
      text-align:right;
      direction:rtl;
    }

    .hidden{display:none}

    @media(max-width:640px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .controls{
        width:100%;
        justify-content:space-between;
      }
      .word-block{
        min-width:60px;
      }
      .bismillah .ar{
        font-size:1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        Quran Grammar — Mobile Preview
      </div>

      <div class="controls">
        <select id="suraSelect" class="select-sura"></select>
        <div class="settings" title="View options">
          <label><input type="checkbox" id="cbTranslation" /> বাংলা অনুবাদ</label>
          <label><input type="checkbox" id="cbWordByWord" /> শব্দে-শব্দে</label>
          <label><input type="checkbox" id="cbGrammar" /> ব্যাকরণ নোট</label>
        </div>
      </div>
    </header>

    <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
      <div class="sliders" style="gap:14px">
        <div>
          <label style="font-size:0.85rem;color:var(--muted)">আরবি ফন্ট: <span id="arabicLabel">2.0rem</span></label><br>
          <input id="arabicSlider" type="range" min="1.2" max="3.0" step="0.1" value="2.0" />
        </div>
        <div>
          <label style="font-size:0.85rem;color:var(--muted)">বাংলা ফন্ট: <span id="banglaLabel">1.0rem</span></label><br>
          <input id="banglaSlider" type="range" min="0.8" max="1.8" step="0.05" value="1.0" />
        </div>
        <div>
          <label style="font-size:0.85rem;color:var(--muted)">নোট ফন্ট: <span id="notesLabel">1.02rem</span></label><br>
          <input id="notesSlider" type="range" min="0.8" max="1.6" step="0.02" value="1.02" />
        </div>
      </div>
    </div>

    <main id="content">
      <section class="bismillah" id="bismillah">
        <div class="ar" id="bismillahAr"></div>
        <div class="bn" id="bismillahBn"></div>
      </section>

      <div id="ayahContainer"></div>
    </main>
  </div>

  <!-- grammar panel -->
  <div id="grammarPanel" class="grammar-panel hidden">
    <div class="grammar-inner" role="dialog" aria-modal="false">
      <div class="g-top">
        <div>
          <div id="gWord" class="g-word">—</div>
          <div id="gMeaning" class="g-meaning">—</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="closeG" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer">Close</button>
        </div>
      </div>
      <div id="gNotes" class="g-notes">নির্বাচিত শব্দের ব্যাকরণগত পরিচিতি এখানে দেখাবে।</div>
    </div>
  </div>

  <script>
    const TOTAL_SURA = 114;

    const suraSelect = document.getElementById('suraSelect');
    const cbTranslation = document.getElementById('cbTranslation');
    const cbWordByWord = document.getElementById('cbWordByWord');
    const cbGrammar = document.getElementById('cbGrammar');

    const arabicSlider = document.getElementById('arabicSlider');
    const banglaSlider = document.getElementById('banglaSlider');
    const notesSlider = document.getElementById('notesSlider');
    const arabicLabel = document.getElementById('arabicLabel');
    const banglaLabel = document.getElementById('banglaLabel');
    const notesLabel = document.getElementById('notesLabel');

    const bismillahAr = document.getElementById('bismillahAr');
    const bismillahBn = document.getElementById('bismillahBn');
    const ayahContainer = document.getElementById('ayahContainer');

    const grammarPanel = document.getElementById('grammarPanel');
    const gWord = document.getElementById('gWord');
    const gMeaning = document.getElementById('gMeaning');
    const gNotes = document.getElementById('gNotes');
    const closeG = document.getElementById('closeG');

    let currentSurah = 104;
    let currentData = null;

    function buildSuraList(){
      fetch('surah_list.json').then(r=>r.json()).then(list=>{
        for(let i=1;i<=TOTAL_SURA;i++){
          const li = list.find(x=>x.number===i);
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = li ? `${i} — ${li.nameBn || li.nameAr || 'সূরা '+i}` : `সূরা ${i}`;
          suraSelect.appendChild(opt);
        }
        suraSelect.value = currentSurah;
      }).catch(_=>{
        for(let i=1;i<=TOTAL_SURA;i++){
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = `সূরা ${i}`;
          suraSelect.appendChild(opt);
        }
        suraSelect.value = currentSurah;
      });
    }
    buildSuraList();

    function applyFontSizes(){
      const a = parseFloat(arabicSlider.value);
      const b = parseFloat(banglaSlider.value);
      const n = parseFloat(notesSlider.value);
      document.documentElement.style.setProperty('--arabic-size', a+'rem');
      document.documentElement.style.setProperty('--bangla-size', b+'rem');
      document.documentElement.style.setProperty('--notes-size', n+'rem');
      arabicLabel.textContent = a.toFixed(2)+'rem';
      banglaLabel.textContent = b.toFixed(2)+'rem';
      notesLabel.textContent = n.toFixed(2)+'rem';
      localStorage.setItem('quran_font', JSON.stringify({a,b,n}));
    }

    arabicSlider.addEventListener('input', applyFontSizes);
    banglaSlider.addEventListener('input', applyFontSizes);
    notesSlider.addEventListener('input', applyFontSizes);

    (function loadFonts(){
      try{
        const raw = localStorage.getItem('quran_font');
        if(raw){
          const o = JSON.parse(raw);
          if(o.a) arabicSlider.value = o.a;
          if(o.b) banglaSlider.value = o.b;
          if(o.n) notesSlider.value = o.n;
        }
      }catch(e){}
      applyFontSizes();
    })();

    (function loadToggles(){
      try{
        const raw = localStorage.getItem('quran_view');
        if(raw){
          const o = JSON.parse(raw);
          cbTranslation.checked = !!o.trans;
          cbWordByWord.checked = !!o.wbw;
          cbGrammar.checked = !!o.grammar;
        } else {
          cbTranslation.checked = false;
          cbWordByWord.checked = false;
          cbGrammar.checked = false;
        }
      }catch(e){}
    })();

    function saveToggles(){
      localStorage.setItem('quran_view', JSON.stringify({
        trans: cbTranslation.checked,
        wbw: cbWordByWord.checked,
        grammar: cbGrammar.checked
      }));
    }

    [cbTranslation, cbWordByWord, cbGrammar].forEach(cb=>{
      cb.addEventListener('change', ()=>{
        saveToggles();
        renderCurrent();
      });
    });

    suraSelect.addEventListener('change', ()=>{
      const val = parseInt(suraSelect.value,10) || 1;
      currentSurah = val;
      loadSurah(val);
    });

    function loadSurah(num){
      const path = `surah_${num}.json`;
      ayahContainer.innerHTML = '';
      bismillahAr.textContent = '';
      bismillahBn.textContent = '';
      currentData = null;
      fetch(path).then(r=>{
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      }).then(data=>{
        currentData = data;
        if(data.hasBismillah && data.bismillah){
          bismillahAr.textContent = data.bismillah.arabic || '';
          bismillahBn.textContent = data.bismillah.bangla || '';
        } else {
          bismillahAr.textContent = '';
          bismillahBn.textContent = '';
        }
        renderCurrent();
      }).catch(err=>{
        console.error('surah load error',err);
        ayahContainer.innerHTML =
          `<div style="padding:14px;background:#081722;border-radius:10px;border:1px solid #21323f;color:#f8d7da">
            সুরা ডাটা লোড করা যায়নি: ${path}. ফাইলটি same folder এ আছে কিনা চেক করুন।
          </div>`;
      });
    }

    function renderCurrent(){
      if(!currentData) return;
      ayahContainer.innerHTML = '';
      const showTranslation = cbTranslation.checked;
      const showWordByWord = cbWordByWord.checked;

      currentData.ayahs.forEach(ayah=>{
        const container = document.createElement('div');
        container.className = 'ayah';

        const head = document.createElement('div');
        head.className = 'ayah-head';
        const no = document.createElement('div');
        no.className = 'ayah-no';
        no.textContent = ayah.ayahNumber;
        const modes = document.createElement('div');
        modes.className = 'ayah-mode';
        let modeTxt = 'শুধু আরবি';
        if(showTranslation || showWordByWord){
          const parts=[];
          if(showTranslation) parts.push('অনুবাদ');
          if(showWordByWord) parts.push('শব্দে-শব্দে');
          modeTxt = 'আরবি + ' + parts.join(' + ');
        }
        modes.textContent = modeTxt;
        head.appendChild(no);
        head.appendChild(modes);
        container.appendChild(head);

        const arabicLine = document.createElement('div');
        arabicLine.className = 'ayah-line';
        arabicLine.textContent = ayah.arabic || '';
        container.appendChild(arabicLine);

        // তেলাওয়াত মোডে কোনো শব্দে ট্যাপ করলে word-by-word অন করব
        arabicLine.addEventListener('click', ()=>{
          // যদি word-by-word অফ থাকে, অন করে দিই
          if(!cbWordByWord.checked){
            cbWordByWord.checked = true;
            saveToggles();
            renderCurrent();
          }
        });

        const trans = document.createElement('div');
        trans.className = 'translation';
        trans.textContent = ayah.bangla || '';
        if(!showTranslation) trans.style.display='none';
        container.appendChild(trans);

        const grid = document.createElement('div');
        grid.className = 'words-grid';
        grid.style.display = showWordByWord ? 'flex' : 'none';

        const words = Array.isArray(ayah.words) && ayah.words.length
          ? ayah.words
          : parseFallbackWords(ayah.arabic);

        words.forEach(w=>{
          const block = document.createElement('div');
          block.className = 'word-block';

          const ar = document.createElement('div');
          ar.className = 'word-ar';
          ar.textContent = w.text || '';

          const bn = document.createElement('div');
          bn.className = 'word-bn';
          bn.textContent = w.meaningBn || '';
          if(!showTranslation) bn.style.display='none';

          block.appendChild(ar);
          block.appendChild(bn);

          block.addEventListener('click', ()=>{
            // word-by-word auto-on if off (আরবি থেকে সরাসরি এইটার উপরও কাজ করবে)
            if(!cbWordByWord.checked){
              cbWordByWord.checked = true;
              saveToggles();
              renderCurrent();
              return;
            }

            document.querySelectorAll('.word-block').forEach(el=>el.classList.remove('active'));
            block.classList.add('active');

            if(cbGrammar.checked && (w.notes || w.meaningBn)){
              showGrammar(w);
            } else {
              // grammar বন্ধ থাকলে, শুধু অর্থ show/hide
              if(bn.style.display === 'none'){
                bn.style.display = 'block';
              } else {
                if(!cbTranslation.checked) bn.style.display = 'none';
              }
            }
          });

          grid.appendChild(block);
        });

        container.appendChild(grid);
        ayahContainer.appendChild(container);
      });

      if(!cbGrammar.checked){
        grammarPanel.classList.add('hidden');
      }
    }

    function parseFallbackWords(line){
      if(!line) return [];
      const parts = line.split(/\s+/).filter(Boolean);
      return parts.map(p=>({text:p,meaningBn:''}));
    }

    function showGrammar(wordObj){
      if(!wordObj) return;
      gWord.textContent = wordObj.text || '';
      gMeaning.textContent = wordObj.meaningBn || '';
      gNotes.textContent = wordObj.notes || wordObj.meaningBn || '';
      grammarPanel.classList.remove('hidden');
      closeG.focus();
    }

    closeG.addEventListener('click', ()=>{
      grammarPanel.classList.add('hidden');
      document.querySelectorAll('.word-block').forEach(el=>el.classList.remove('active'));
    });

    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape'){
        grammarPanel.classList.add('hidden');
        document.querySelectorAll('.word-block').forEach(el=>el.classList.remove('active'));
      }
    });

    (function init(){
      suraSelect.value = currentSurah;
      loadSurah(currentSurah);
    })();
  </script>
</body>
</html>
