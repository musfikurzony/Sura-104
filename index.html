<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Qur'an ‚Ä¢ Word-by-Word ‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---------- Root / basics ---------- */
    :root{
      --bg:#071021;
      --card:#0b1220;
      --muted:#9ca3af;
      --accent:#22c55e;
      --glass: rgba(255,255,255,0.02);
      --panel:#0f1724;
      --text:#e6eef0;
      --danger:#fb7185;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans Bengali",sans-serif;background:linear-gradient(180deg,#020617 0%,#071021 60%);color:var(--text);}
    a{color:inherit}
    button{font-family:inherit;cursor:pointer}
    .container{max-width:1140px;margin:12px auto;padding:12px;display:grid;grid-template-columns:320px 1fr;gap:14px;align-items:start}

    /* ---------- Sidebar ---------- */
    .sidebar{background:linear-gradient(180deg,var(--panel),#071022);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);height:calc(100vh - 48px);overflow:auto}
    .logo{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .logo .dot{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#22c55e,#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042e2a}
    .logo .title{font-weight:700}
    .panel-title{font-size:13px;color:var(--muted);margin-bottom:6px;display:flex;align-items:center;gap:8px}
    .search{position:relative;margin-bottom:8px}
    .search input{width:100%;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text)}
    .sura-list{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .sura-item{padding:6px;border-radius:10px;display:flex;flex-direction:column;gap:2px;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .sura-item:hover{transform:translateY(-2px);border-color:rgba(255,255,255,0.04)}
    .sura-item.active{background:linear-gradient(90deg,#072f2a, #06182b);border-color:rgba(34,197,94,0.28)}
    .last-read-box{margin-top:10px;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(34,197,94,0.06), rgba(6,7,10,0.2));border:1px solid rgba(255,255,255,0.02)}
    .mini-list{margin-top:10px;display:flex;flex-direction:column;gap:6px}
    .mini-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px;background:rgba(255,255,255,0.01);font-size:13px}

    /* ---------- Main ---------- */
    .main{min-height:80vh}
    .header-card{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:12px;border-radius:12px;background:linear-gradient(90deg,#061226,#081b2a);border:1px solid rgba(255,255,255,0.03)}
    .sura-meta{display:flex;flex-direction:column;gap:4px}
    .sura-name{font-size:18px;font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#06b6d4);border:none;color:#042e2a}
    .view-toggle{display:inline-flex;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .view-toggle button{padding:6px 10px;background:transparent;border:none;color:var(--muted);font-size:13px}
    .view-toggle button.active{background:rgba(255,255,255,0.02);color:var(--text)}

    /* ---------- Aya list ---------- */
    .aya-card{margin-top:12px;padding:10px;border-radius:12px;background:linear-gradient(180deg,#071226,#061427);border:1px solid rgba(255,255,255,0.03)}
    .aya-list{margin-top:8px;border-radius:8px;overflow:auto;max-height:calc(100vh - 260px);padding-bottom:60px}
    .aya-row{display:grid;grid-template-columns:44px 1fr 150px;gap:10px;padding:10px;border-bottom:1px dashed rgba(255,255,255,0.02);align-items:start}
    .aya-row:last-child{border-bottom:none}
    .aya-check{display:flex;align-items:center;justify-content:center}
    .aya-number{font-size:12px;color:var(--muted);padding:4px 6px;border-radius:999px;background:rgba(255,255,255,0.02)}
    .aya-text{overflow:hidden}
    .aya-ar{font-family:"Scheherazade New","Amiri",serif;font-size:22px;direction:rtl;text-align:right;line-height:1.8;margin-bottom:6px}
    .word-token{display:inline-block;padding:4px 6px;margin:0 4px;border-radius:999px;cursor:pointer}
    .word-token:hover{background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.12)}
    .aya-bn{font-size:14px;color:var(--muted);line-height:1.8}

    /* actions column */
    .aya-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .icon-chip{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01);cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .icon-chip.active{background:linear-gradient(90deg,#fff5d1,#ffedd5);color:#5b3b07;border-color:#f59e0b}
    .icon-chip.fav{background:linear-gradient(90deg,#fff0f6,#fff1f2);color:#7f1d1d;border-color:#fb7185}
    .icon-chip.main{background:linear-gradient(90deg,#0b1220,#071226);color:var(--text);border:1px solid rgba(255,255,255,0.03)}

    /* multi-select toolbar */
    .multi-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;padding:8px 12px;border-radius:999px;background:linear-gradient(90deg,#061426,#071226);border:1px solid rgba(255,255,255,0.03);display:none;gap:8px;z-index:60;display:flex;align-items:center}
    .multi-bar.show{display:flex}
    .multi-bar .count{font-size:14px}

    /* modals & popup */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,12,0.6);display:none;align-items:center;justify-content:center;z-index:70}
    .modal-backdrop.show{display:flex}
    .modal{background:#fff;color:#0b1220;border-radius:12px;max-width:900px;width:96%;max-height:88vh;overflow:auto;box-shadow:0 30px 80px rgba(2,6,12,0.6)}
    .modal .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eef2f7}
    .modal .modal-body{padding:12px 16px}
    .modal .modal-footer{padding:12px 16px;border-top:1px solid #eef2f7;display:flex;justify-content:flex-end;gap:8px}

    /* word-popup */
    .word-popup{position:fixed;z-index:80;min-width:260px;background:linear-gradient(180deg,#020617,#071226);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.03);color:var(--text);box-shadow:0 20px 50px rgba(2,6,12,0.8);display:none}
    .word-popup .arabic{font-family:"Scheherazade New","Amiri",serif;font-size:18px;text-align:right}
    .word-popup .meaning{margin-top:6px;font-size:14px}
    .word-popup .notes{margin-top:8px;font-size:13px;color:var(--muted);max-height:180px;overflow:auto}

    /* responsive */
    @media (max-width:980px){
      .container{grid-template-columns:1fr; padding:8px}
      .sidebar{order:2;height:auto}
      .main{order:1}
      .aya-row{grid-template-columns:40px 1fr 120px}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <div class="dot">ŸÇ</div>
        <div>
          <div class="title">Qur'an ‚Ä¢ Word-by-Word</div>
          <div style="font-size:13px;color:var(--muted)">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶∞‡ßç‡¶• ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü</div>
        </div>
      </div>

      <div class="panel-title">‡¶∏‡ßÇ‡¶∞‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
      <div class="search">
        <input id="suraSearch" placeholder="‡¶®‡¶æ‡¶Æ / ‡¶®‡¶Ç ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
      </div>
      <div id="suraList" class="sura-list" aria-live="polite"></div>

      <div style="margin-top:12px" class="panel-title">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ</div>
      <div id="lastReadBox" class="last-read-box">‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶¨‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶®‡ßá‡¶á‡•§</div>

      <div style="margin-top:12px" class="panel-title">‡¶™‡¶ø‡¶® ‡¶ì ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü (‡¶∂‡¶∞‡ßç‡¶ü‡¶ï‡¶æ‡¶ü)</div>
      <div id="miniPins" class="mini-list"></div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="header-card">
        <div class="sura-meta">
          <div class="sura-name" id="currentSuraName">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
          <div style="font-size:13px;color:var(--muted)" id="currentSuraInfo">‚Äî</div>
        </div>
        <div class="controls">
          <div class="view-toggle" id="viewToggle">
            <button data-view="both" class="active">‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
            <button data-view="ar">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</button>
            <button data-view="bn">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <label style="font-size:13px;color:var(--muted)">‡¶´‡¶®‡ßç‡¶ü</label>
            <input id="fontRange" type="range" min="14" max="28" step="1" value="18" />
          </div>
          <button id="openSettings" class="btn">‚öôÔ∏è ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡ßÉ‡¶§ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
          <button id="openPinsModal" class="btn">üìå ‡¶™‡¶ø‡¶® / ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</button>
        </div>
      </div>

      <section class="aya-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">‡¶Ü‡ßü‡¶æ‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
          <div id="ayaCount" style="color:var(--muted)"></div>
        </div>

        <div id="ayaList" class="aya-list" tabindex="0" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <!-- Multi-select toolbar -->
  <div id="multiBar" class="multi-bar" role="toolbar" aria-hidden="true">
    <div class="count" id="multiCount">0 ‡¶ü‡¶ø ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§</div>
    <div style="display:flex;gap:8px">
      <button id="multiCopy" class="btn">üìã ‡¶ï‡¶™‡¶ø</button>
      <button id="multiShare" class="btn primary">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
      <button id="multiClear" class="btn">‚úñ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
    </div>
  </div>

  <!-- Word popup -->
  <div id="wordPopup" class="word-popup" role="dialog" aria-hidden="true">
    <div class="arabic" id="wpArabic"></div>
    <div class="meaning" id="wpMeaning"></div>
    <div class="notes" id="wpNotes"></div>
    <div style="text-align:right;margin-top:8px">
      <button id="wpClose" class="btn">‚úï</button>
    </div>
  </div>

  <!-- Modals -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div id="modalWindow" class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div id="modalTitle">Title</div>
        <div><button id="modalClose" class="btn">‡¶¨‡¶®‡ßç‡¶ß</button></div>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>

  <!-- Load suras.js (must be present in same folder) -->
  <script src="suras.js"></script>

  <script>
  (function(){
    /* ===========================
       State & Storage helpers
       =========================== */
    if(!window.suras || !Array.isArray(window.suras)){
      document.getElementById('currentSuraName').textContent = 'suras.js ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø ‚Äî ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ì ‡¶≠‡ßç‡¶Ø‡¶æ‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ‡¶®‡¶æ‡¶Æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®';
      document.getElementById('ayaList').innerHTML = '<div style="padding:12px;color:#fb7185">suras.js ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø‡•§</div>';
      return;
    }

    const storage = {
      get(key, fallback){
        try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; }
      },
      set(key, val){
        try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){}
      }
    };

    const STATE = {
      currentSuraIndex: 0,
      currentSurahData: null,
      view: storage.get('q_view','both'),
      fontSize: storage.get('q_fontSize',18),
      lineHeight: storage.get('q_lineHeight',1.8),
      pins: storage.get('q_pins', []),      // array of {key, surahIndex, ayahIndex, note, name, createdAt}
      favs: storage.get('q_favs', []),
      lastRead: storage.get('q_lastRead', null),
      selected: new Set()
    };

    // Helpers
    const suraListEl = document.getElementById('suraList');
    const suraSearchEl = document.getElementById('suraSearch');
    const currentSuraNameEl = document.getElementById('currentSuraName');
    const currentSuraInfoEl = document.getElementById('currentSuraInfo');
    const ayaListEl = document.getElementById('ayaList');
    const ayaCountEl = document.getElementById('ayaCount');
    const miniPinsEl = document.getElementById('miniPins');
    const lastReadBoxEl = document.getElementById('lastReadBox');

    const viewToggle = document.getElementById('viewToggle');
    const fontRange = document.getElementById('fontRange');
    const multiBar = document.getElementById('multiBar');
    const multiCount = document.getElementById('multiCount');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalWindow = document.getElementById('modalWindow');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalFooter = document.getElementById('modalFooter');
    const modalClose = document.getElementById('modalClose');

    const wordPopup = document.getElementById('wordPopup');
    const wpArabic = document.getElementById('wpArabic');
    const wpMeaning = document.getElementById('wpMeaning');
    const wpNotes = document.getElementById('wpNotes');
    const wpClose = document.getElementById('wpClose');

    /* ========== Utility ========== */
    function ayahKey(sIdx,aIdx){ return `${sIdx}:${aIdx}`; }
    function findIndexByKey(list,key){return list.findIndex(i=>i.key===key);}
    function isPinned(sIdx,aIdx){ return findIndexByKey(STATE.pins, ayahKey(sIdx,aIdx)) !== -1; }
    function isFav(sIdx,aIdx){ return findIndexByKey(STATE.favs, ayahKey(sIdx,aIdx)) !== -1; }
    function savePins(){ storage.set('q_pins', STATE.pins); }
    function saveFavs(){ storage.set('q_favs', STATE.favs); }
    function saveLastRead(){ storage.set('q_lastRead', STATE.lastRead); renderLastRead(); }
    function saveSettings(){ storage.set('q_view', STATE.view); storage.set('q_fontSize', STATE.fontSize); storage.set('q_lineHeight', STATE.lineHeight); }

    /* ========== Render sura list (sidebar + modal copy) ========== */
    function renderSuraList(filter=''){
      const ft = filter.trim().toLowerCase();
      suraListEl.innerHTML = '';
      window.suras.forEach((s, idx)=>{
        const bn = s.nameBn || s.name_bn || s.name || '';
        const ar = s.nameAr || s.name_ar || '';
        const id = String(s.number || (idx+1));
        if(ft && !(bn.toLowerCase().includes(ft) || ar.toLowerCase().includes(ft) || id===ft)) return;
        const btn = document.createElement('button');
        btn.className = 'sura-item' + (idx===STATE.currentSuraIndex? ' active':'');
        btn.dataset.index = idx;
        btn.innerHTML = `<div style="font-weight:600;font-size:13px">${id}. ${bn}</div><div style="font-size:12px;color:var(--muted)">${(s.ayahCount|| (s.ayahs? s.ayahs.length : '?'))} ‡¶Ü‡ßü‡¶æ‡¶§</div><div style="font-family:Scheherazade, Amiri; font-size:16px;text-align:right;margin-top:4px">${ar}</div>`;
        btn.addEventListener('click',()=> setCurrentSura(idx));
        suraListEl.appendChild(btn);
      });
    }

    suraSearchEl.addEventListener('input', ()=> renderSuraList(suraSearchEl.value));

    /* ========== Load & render current sura JSON ========== */
    async function setCurrentSura(idx){
      STATE.currentSuraIndex = idx;
      // highlight sura list
      renderSuraList(suraSearchEl.value || '');
      const meta = window.suras[idx];
      currentSuraNameEl.textContent = `${meta.number || (idx+1)}. ${meta.nameBn || meta.name || ''} (${meta.nameAr||''})`;
      currentSuraInfoEl.textContent = `${meta.revelationPlace || meta.type || ''} ‚Ä¢ ${meta.ayahCount || (meta.ayahs ? meta.ayahs.length : '?')} ‡¶Ü‡ßü‡¶æ‡¶§`;
      // load file
      if(meta.file){
        try{
          const res = await fetch(meta.file);
          if(!res.ok) throw new Error('‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßá‡ßü‡ßá ‡¶®‡¶æ‡¶á');
          const data = await res.json();
          STATE.currentSurahData = data;
        }catch(e){
          console.error('surah load error',e);
          STATE.currentSurahData = null;
        }
      } else {
        // maybe sura stored inline in suras.js
        STATE.currentSurahData = meta;
      }
      renderAyaList();
    }

    /* ========== Render Aya list ========== */
    function renderAyaList(){
      ayaListEl.innerHTML = '';
      const sdata = STATE.currentSurahData || {};
      const ayas = Array.isArray(sdata.ayahs) ? sdata.ayahs : (sdata.ayas || []);
      ayaCountEl.textContent = ayas.length + ' ‡¶Ü‡ßü‡¶æ‡¶§';
      const fontSize = STATE.fontSize;
      const lineHeight = STATE.lineHeight;

      ayas.forEach((aya, idx)=>{
        const row = document.createElement('div');
        row.className = 'aya-row';
        row.id = `aya-${STATE.currentSuraIndex}-${idx}`;

        // checkbox col
        const ccol = document.createElement('div'); ccol.className = 'aya-check';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = STATE.selected.has(ayahKey(STATE.currentSuraIndex, idx));
        cb.addEventListener('change', ()=>{
          const key = ayahKey(STATE.currentSuraIndex, idx);
          if(cb.checked) STATE.selected.add(key); else STATE.selected.delete(key);
          updateMultiBar();
        });
        ccol.appendChild(cb);

        // text col
        const tcol = document.createElement('div'); tcol.className='aya-text';
        tcol.style.fontSize = fontSize + 'px';
        tcol.style.lineHeight = lineHeight;
        const meta = document.createElement('div');
        meta.style.display='flex';meta.style.justifyContent='space-between';meta.style.marginBottom='6px';
        const num = document.createElement('div'); num.className='aya-number'; num.textContent = `${STATE.currentSuraIndex+1}:${idx+1}`;
        meta.appendChild(num);

        const tagWrap = document.createElement('div');
        if(isPinned(STATE.currentSuraIndex, idx)){
          const t = document.createElement('span'); t.style.marginRight='6px'; t.style.fontSize='13px'; t.textContent='üìå ‡¶™‡¶ø‡¶®'; tagWrap.appendChild(t);
        }
        if(isFav(STATE.currentSuraIndex, idx)){
          const t2 = document.createElement('span'); t2.style.fontSize='13px'; t2.textContent='‚≠ê ‡¶™‡ßç‡¶∞‡¶ø‡ßü'; tagWrap.appendChild(t2);
        }
        meta.appendChild(tagWrap);

        // Arabic - either words tokens or whole arabic
        const ar = document.createElement('div'); ar.className='aya-ar';
        if(STATE.view === 'bn') ar.style.display='none';
        if(Array.isArray(aya.words) && aya.words.length>0){
          // render tokens
          aya.words.forEach((w, wi)=>{
            const span = document.createElement('span');
            span.className = 'word-token';
            span.textContent = w.text || (w.word||'');
            span.dataset.wmeaning = w.meaningBn || w.meaning || '';
            span.dataset.wnotes = w.notes || '';
            span.dataset.ayah = idx;
            span.addEventListener('click', (ev)=>openWordPopup(ev.currentTarget, w, idx));
            ar.appendChild(span);
          });
        } else {
          ar.textContent = aya.arabic || aya.ar || aya.text_ar || '';
        }

        // bn
        const bn = document.createElement('div'); bn.className='aya-bn';
        if(STATE.view === 'ar') bn.style.display='none';
        bn.textContent = aya.bangla || aya.bn || aya.text_bn || '';

        tcol.appendChild(meta);
        tcol.appendChild(ar);
        tcol.appendChild(bn);

        // actions col
        const acol = document.createElement('div'); acol.className='aya-actions';

        // top row: pin, fav, copy, share
        const top = document.createElement('div'); top.style.display='flex'; top.style.gap='6px';
        const pinBtn = document.createElement('button'); pinBtn.className='icon-chip'; pinBtn.innerHTML='üìå';
        if(isPinned(STATE.currentSuraIndex, idx)) pinBtn.classList.add('active');
        pinBtn.title = '‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
        pinBtn.addEventListener('click', ()=> {
          togglePin(STATE.currentSuraIndex, idx);
          renderAyaList();
          renderMiniPins();
        });
        top.appendChild(pinBtn);

        const favBtn = document.createElement('button'); favBtn.className='icon-chip';
        favBtn.innerHTML = '‚≠ê';
        if(isFav(STATE.currentSuraIndex, idx)) favBtn.classList.add('fav');
        favBtn.title='‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü';
        favBtn.addEventListener('click', ()=> {
          toggleFav(STATE.currentSuraIndex, idx);
          renderAyaList();
          renderMiniPins();
        });
        top.appendChild(favBtn);

        const copyBtn = document.createElement('button'); copyBtn.className='icon-chip'; copyBtn.innerHTML='üìã';
        copyBtn.title = '‡¶è‡¶á ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®';
        copyBtn.addEventListener('click', ()=> {
          const text = formatAyaForCopy(STATE.currentSuraIndex, idx, 'both');
          navigator.clipboard.writeText(text).then(()=> alert('‡¶Ü‡ßü‡¶æ‡¶§ ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§')).catch(()=>{ alert('‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø'); });
        });
        top.appendChild(copyBtn);

        const shareBtn = document.createElement('button'); shareBtn.className='icon-chip primary'; shareBtn.innerHTML='üîó';
        shareBtn.title='‡¶∂‡ßá‡ßü‡¶æ‡¶∞';
        shareBtn.addEventListener('click', ()=> {
          const text = formatAyaForCopy(STATE.currentSuraIndex, idx, 'both');
          doShare(text);
        });
        top.appendChild(shareBtn);

        acol.appendChild(top);

        // last-read button
        const lastBtn = document.createElement('button'); lastBtn.className='icon-chip main'; lastBtn.innerHTML='‚è± ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ';
        lastBtn.addEventListener('click', ()=> {
          STATE.lastRead = { surahIndex: STATE.currentSuraIndex, ayaIndex: idx, time: Date.now() };
          saveLastRead();
          alert('‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã: ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ');
        });
        acol.appendChild(lastBtn);

        // attach
        row.appendChild(ccol);
        row.appendChild(tcol);
        row.appendChild(acol);

        ayaListEl.appendChild(row);
      });

      // apply font size and line-height to tokens if needed (done above)
      updateMultiBar();
      renderMiniPins();
    }

    /* ========== Word popup ========== */
    function openWordPopup(targetElement, wordObj, ayahIndex){
      // position near element
      const rect = targetElement.getBoundingClientRect();
      wpArabic.textContent = wordObj.text || targetElement.textContent || '';
      wpMeaning.textContent = wordObj.meaningBn || wordObj.meaning || '‚Äî';
      wpNotes.textContent = wordObj.notes || '‚Äî';
      wordPopup.style.top = (rect.bottom + window.scrollY + 8) + 'px';
      // attempt to center horizontally; keep within window
      let left = rect.left + window.scrollX - 40;
      if(left + 320 > window.innerWidth) left = window.innerWidth - 340;
      if(left < 8) left = 8;
      wordPopup.style.left = left + 'px';
      wordPopup.style.display = 'block';
      wordPopup.setAttribute('aria-hidden','false');
    }
    wpClose.addEventListener('click', ()=>{ wordPopup.style.display='none'; wordPopup.setAttribute('aria-hidden','true'); });
    document.addEventListener('click', (ev)=>{
      if(wordPopup.style.display === 'block' && !wordPopup.contains(ev.target) && !ev.target.classList.contains('word-token')) {
        wordPopup.style.display = 'none';
        wordPopup.setAttribute('aria-hidden','true');
      }
    });

    /* ========== Pins / Favs logic ========== */
    function togglePin(sIdx,aIdx){
      const key = ayahKey(sIdx,aIdx);
      const i = findIndexByKey(STATE.pins, key);
      if(i>=0){
        STATE.pins.splice(i,1);
      } else {
        const meta = window.suras[sIdx] || {};
        STATE.pins.unshift({ key, surahIndex:sIdx, ayahIndex:aIdx, note:'', name:`${meta.nameBn||meta.name}`, createdAt: Date.now() });
      }
      savePins();
    }
    function toggleFav(sIdx,aIdx){
      const key = ayahKey(sIdx,aIdx);
      const i = findIndexByKey(STATE.favs, key);
      if(i>=0){
        STATE.favs.splice(i,1);
      } else {
        const meta = window.suras[sIdx] || {};
        STATE.favs.unshift({ key, surahIndex:sIdx, ayahIndex:aIdx, note:'', name:`${meta.nameBn||meta.name}`, createdAt: Date.now() });
      }
      saveFavs();
    }

    /* mini pins (sidebar) */
    function renderMiniPins(){
      miniPinsEl.innerHTML = '';
      const combined = [...STATE.pins.map(p=>({...p, kind:'pin'})), ...STATE.favs.map(f=>({...f, kind:'fav'}))].slice(0,12);
      if(combined.length===0){
        miniPinsEl.innerHTML = '<div style="color:var(--muted);font-size:13px">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶ø‡¶®/‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü ‡¶®‡ßá‡¶á‡•§</div>'; return;
      }
      combined.forEach(item=>{
        const wrap = document.createElement('div'); wrap.className='mini-item';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${item.kind==='pin' ? 'üìå ' : '‚≠ê '}${item.name} ${item.surahIndex+1}:${item.ayahIndex+1}</div><div style="font-size:12px;color:var(--muted);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${item.note || ''}</div>`;
        const right = document.createElement('div');
        const go = document.createElement('button'); go.className='btn'; go.textContent='‡¶Ø‡¶æ‡¶®'; go.addEventListener('click', ()=>{ setCurrentSura(item.surahIndex); setTimeout(()=>{ const el = document.getElementById(`aya-${item.surahIndex}-${item.ayahIndex}`); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}) }, 120); });
        const del = document.createElement('button'); del.className='btn'; del.textContent='üóë'; del.addEventListener('click', ()=>{ if(item.kind==='pin'){ STATE.pins = STATE.pins.filter(x=>x.key !== item.key); savePins(); } else { STATE.favs = STATE.favs.filter(x=>x.key !== item.key); saveFavs(); } renderMiniPins(); renderAyaList(); });
        right.appendChild(go); right.appendChild(del);
        wrap.appendChild(left); wrap.appendChild(right);
        miniPinsEl.appendChild(wrap);
      });
    }

    /* ========== Last read render ========== */
    function renderLastRead(){
      if(!STATE.lastRead){ lastReadBoxEl.innerHTML = '‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§‡¶ï‡ßá ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§'; return; }
      const s = window.suras[STATE.lastRead.surahIndex] || {};
      const suraName = s.nameBn || s.name || '';
      const ay = STATE.lastRead.ayaIndex + 1;
      lastReadBoxEl.innerHTML = `<div style="font-weight:700">${suraName} ‚Äî ‡¶Ü‡ßü‡¶æ‡¶§ ${ay}</div><div style="margin-top:6px"><button id="goLastBtn" class="btn primary">‚è± ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button> <button id="clearLastBtn" class="btn">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button></div>`;
      document.getElementById('goLastBtn').addEventListener('click', ()=>{ setCurrentSura(STATE.lastRead.surahIndex); setTimeout(()=>{ const el = document.getElementById(`aya-${STATE.lastRead.surahIndex}-${STATE.lastRead.ayaIndex}`); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}) }, 160); });
      document.getElementById('clearLastBtn').addEventListener('click', ()=>{ STATE.lastRead = null; storage.set('q_lastRead', null); renderLastRead(); });
    }

    /* ========== Multi-select toolbar ========== */
    function updateMultiBar(){
      const count = STATE.selected.size;
      if(count>0){
        multiCount.textContent = `${count} ‡¶ü‡¶ø ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§`;
        multiBar.classList.add('show');
      } else {
        multiBar.classList.remove('show');
      }
    }
    document.getElementById('multiCopy').addEventListener('click', ()=>{
      if(STATE.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§');
      const text = formatMultipleForCopy(Array.from(STATE.selected), 'both');
      openCopyModal(text);
    });
    document.getElementById('multiShare').addEventListener('click', ()=>{
      if(STATE.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§');
      const text = formatMultipleForCopy(Array.from(STATE.selected), 'both');
      doShare(text);
    });
    document.getElementById('multiClear').addEventListener('click', ()=>{
      STATE.selected.clear(); renderAyaList(); updateMultiBar();
    });

    /* ========== Copy/Share formatting ========== */
    function formatAyaForCopy(sIdx,aIdx,mode){
      const sdata = (window.suras[sIdx]) || {};
      // try to load current sura data if it's this sura and loaded
      let ayadata = null;
      if(STATE.currentSurahData && STATE.currentSuraIndex === sIdx){
        ayadata = (STATE.currentSurahData.ayahs || STATE.currentSurahData.ayas || [])[aIdx] || {};
      } else {
        // can't fetch other sura quickly ‚Äî try suras.js entry if contains ayah text
        const entry = window.suras[sIdx] || {};
        const ayas = entry.ayahs || entry.ayas || [];
        ayadata = ayas[aIdx] || {};
      }
      const ar = ayadata.arabic || ayadata.ar || ayadata.text_ar || '';
      const bn = ayadata.bangla || ayadata.bn || ayadata.text_bn || '';
      const head = `[${(sdata.nameBn||sdata.name||'')} ${sIdx+1}:${aIdx+1}]`;
      if(mode === 'ar') return `${ar}\n${head}`;
      if(mode === 'bn') return `${bn}\n${head}`;
      return `${ar}\n${bn}\n${head}`;
    }
    function formatMultipleForCopy(keys, mode){
      // keys are like 'sIdx:aIdx'
      const parts = keys.map(k=>{
        const [sIdx,aIdx] = k.split(':').map(Number);
        return formatAyaForCopy(sIdx,aIdx,mode);
      });
      return parts.join('\n\n');
    }
    function doShare(text){
      if(navigator.share){
        navigator.share({ text }).catch(()=>{ navigator.clipboard.writeText(text).then(()=>alert('‡¶ï‡¶™‡¶ø‡¶ï‡ßÉ‡¶§ ‚Äî ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§'))});
      } else {
        navigator.clipboard.writeText(text).then(()=> alert('‡¶ï‡¶™‡¶ø‡¶§‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á)‡•§')).catch(()=> alert('‡¶ï‡¶™‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
      }
    }

    /* ========== Modal helpers (generic) ========== */
    function openModal(title, bodyHtml, footerHtml){
      modalTitle.innerHTML = title;
      modalBody.innerHTML = bodyHtml || '';
      modalFooter.innerHTML = footerHtml || '';
      modalBackdrop.classList.add('show');
      modalBackdrop.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modalBackdrop.classList.remove('show');
      modalBackdrop.setAttribute('aria-hidden','true');
    }
    modalClose.addEventListener('click', ()=> closeModal());
    modalBackdrop.addEventListener('click', (ev)=>{ if(ev.target === modalBackdrop) closeModal(); });

    /* ========== Pins / Favs modal (full management) ========== */
    document.getElementById('openPinsModal').addEventListener('click', ()=>{
      const body = `<div style="display:flex;gap:8px;margin-bottom:8px"><button id="pinsTab" class="btn primary">üìå ‡¶™‡¶ø‡¶®</button><button id="favsTab" class="btn">‚≠ê ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</button><input id="pinsFilter" placeholder="‡¶∏‡ßÅ‡¶∞‡¶æ/‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef0" /></div><div id="pinsListFull"></div>`;
      const footer = `<button id="clearAllPins" class="btn">‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button><button class="btn" id="closePins">‡¶¨‡¶®‡ßç‡¶ß</button>`;
      openModal('‡¶™‡¶ø‡¶® ‡¶ì ‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞', body, footer);
      setTimeout(()=>{ renderPinsModal('pins'); document.getElementById('pinsTab').addEventListener('click', ()=>renderPinsModal('pins')); document.getElementById('favsTab').addEventListener('click', ()=>renderPinsModal('favs')); document.getElementById('closePins').addEventListener('click', closeModal); document.getElementById('clearAllPins').addEventListener('click', ()=>{ if(!confirm('‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return; STATE.pins=[]; STATE.favs=[]; savePins(); saveFavs(); renderPinsModal('pins'); renderMiniPins(); renderAyaList(); }); document.getElementById('pinsFilter').addEventListener('input', ()=> renderPinsModal(currentPinsTab)); }, 50);
      var currentPinsTab = 'pins';
      function renderPinsModal(tab){
        currentPinsTab = tab;
        const list = (tab==='pins' ? STATE.pins.slice() : STATE.favs.slice());
        const cont = document.getElementById('pinsListFull');
        cont.innerHTML = '';
        if(list.length===0){ cont.innerHTML = '<div style="color:var(--muted)">‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á</div>'; return; }
        list.forEach(item=>{
          const s = window.suras[item.surahIndex] || {};
          const ayText = ( (item.surahIndex === STATE.currentSuraIndex && STATE.currentSurahData && STATE.currentSurahData.ayahs) ? (STATE.currentSurahData.ayahs[item.ayahIndex] || {}) : ( (s.ayahs || s.ayas || [])[item.ayahIndex] || {} ) );
          const wrapper = document.createElement('div'); wrapper.style.padding='8px'; wrapper.style.borderBottom='1px solid #eef2f7';
          wrapper.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${s.nameBn||s.name||''} ${item.surahIndex+1}:${item.ayahIndex+1}</strong><div style="font-size:13px;color:#6b7280">${item.note || ''}</div></div><div style="display:flex;gap:6px"><button class="btn" data-go>‡¶Ø‡¶æ‡¶®</button><button class="btn" data-copy>üìã</button><button class="btn" data-edit>‚úè</button><button class="btn" style="background:#fee2e2;color:#b91c1c" data-del>üóë</button></div></div><div style="margin-top:8px;color:#334155">${(ayText.bangla||ayText.bn||'').slice(0,180)}</div>`;
          cont.appendChild(wrapper);
          wrapper.querySelector('[data-go]').addEventListener('click', ()=>{ setCurrentSura(item.surahIndex); closeModal(); setTimeout(()=>{ const el=document.getElementById(`aya-${item.surahIndex}-${item.ayahIndex}`); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}); },120); });
          wrapper.querySelector('[data-copy]').addEventListener('click', ()=>{ const t = formatAyaForCopy(item.surahIndex, item.ayahIndex, 'both'); navigator.clipboard.writeText(t).then(()=> alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§')); });
          wrapper.querySelector('[data-del]').addEventListener('click', ()=>{ if(!confirm('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return; if(tab==='pins'){ STATE.pins = STATE.pins.filter(x=>x.key!==item.key); savePins(); } else { STATE.favs = STATE.favs.filter(x=>x.key!==item.key); saveFavs(); } renderPinsModal(tab); renderMiniPins(); renderAyaList(); });
          wrapper.querySelector('[data-edit]').addEventListener('click', ()=>{ const newNote = prompt('‡¶®‡ßã‡¶ü/‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', item.note || ''); if(newNote!==null){ item.note = newNote; if(tab==='pins') savePins(); else saveFavs(); renderPinsModal(tab); renderMiniPins(); } });
        });
      }
    });

    /* ========== Copy modal helper for multi-copy case ========== */
    function openCopyModal(prefillText){
      const body = `<div style="margin-bottom:8px"><label style="font-weight:700">‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü</label><div style="display:flex;gap:8px;margin-top:6px"><label><input type="radio" name="copyFormat" value="both" checked /> ‡¶Ü‡¶∞‡¶¨‡¶ø + ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label><label><input type="radio" name="copyFormat" value="ar" /> ‡¶∂‡ßÅ‡¶¶‡ßç‡¶ß ‡¶Ü‡¶∞‡¶¨‡¶ø</label><label><input type="radio" name="copyFormat" value="bn" /> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label></div></div><textarea id="copyPreview" style="width:100%;min-height:140px;padding:8px;border-radius:8px;border:1px solid #eef2f7">${prefillText||''}</textarea>`;
      const footer = `<button id="copyToClipboard" class="btn primary">üìã ‡¶ï‡¶™‡¶ø</button><button id="shareText" class="btn">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button><button class="btn" id="closeCopy">‡¶¨‡¶®‡ßç‡¶ß</button>`;
      openModal('‡¶ï‡¶™‡¶ø / ‡¶∂‡ßá‡ßü‡¶æ‡¶∞', body, footer);
      setTimeout(()=>{
        document.getElementById('copyToClipboard').addEventListener('click', ()=>{
          const txt = document.getElementById('copyPreview').value;
          navigator.clipboard.writeText(txt).then(()=> alert('‡¶ï‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
        });
        document.getElementById('shareText').addEventListener('click', ()=>{
          const txt = document.getElementById('copyPreview').value;
          doShare(txt);
        });
        document.getElementById('closeCopy').addEventListener('click', closeModal);
      }, 40);
    }

    /* ========== Small helpers ========== */
    function formatAyaForCopyLocal(sIdx,aIdx, mode){
      // wrapper calls earlier function
      return formatAyaForCopy(sIdx,aIdx,mode);
    }

    /* ========== Initial setup & events ========== */
    // view toggle
    viewToggle.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        viewToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        STATE.view = btn.dataset.view;
        saveSettings();
        renderAyaList();
      });
      if(btn.dataset.view === STATE.view) btn.classList.add('active'); else btn.classList.remove('active');
    });

    // font
    fontRange.value = STATE.fontSize;
    fontRange.addEventListener('input', ()=> {
      STATE.fontSize = Number(fontRange.value);
      saveSettings();
      renderAyaList();
    });

    // export settings button (opens a minimal settings modal to adjust line height)
    document.getElementById('openSettings').addEventListener('click', ()=> {
      const body = `<div class="settings-row"><label style="font-weight:700">‡¶≤‡¶æ‡¶á‡¶® ‡¶π‡¶æ‡¶á‡¶ü</label><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" data-lh="1.6">‡¶ï‡¶Æ‡¶´‡ßã‡¶∞‡ßç‡¶ü</button><button class="btn" data-lh="1.8">‡¶∞‡¶ø‡¶≤‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏</button><button class="btn" data-lh="2.0">‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡¶æ</button></div></div>`;
      const footer = `<button id="saveSettingsBtn" class="btn primary">‡¶∏‡ßá‡¶≠</button><button class="btn" id="closeSettings">‡¶¨‡¶®‡ßç‡¶ß</button>`;
      openModal('‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏', body, footer);
      setTimeout(()=>{
        modalBody.querySelectorAll('[data-lh]').forEach(el=> el.addEventListener('click', ()=> { modalBody.querySelectorAll('[data-lh]').forEach(x=>x.classList.remove('active')); el.classList.add('active'); STATE.lineHeight = Number(el.dataset.lh); }));
        document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{ saveSettings(); renderAyaList(); closeModal(); });
        document.getElementById('closeSettings').addEventListener('click', closeModal);
      }, 40);
    });

    // initial render: sura list and load first sura
    renderSuraList();
    setCurrentSura(0);

    // restore lastRead and pins
    renderLastRead();
    renderMiniPins();

    /* expose some helpers on window for debugging */
    window.QURAN_APP = {
      STATE,
      setCurrentSura,
      renderAyaList,
      renderSuraList
    };

    // small safety: if suras.js includes 'file' values that are relative, they must exist
  })();
  </script>
</body>
</html>
