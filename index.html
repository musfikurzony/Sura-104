<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Qur'an ‚Ä¢ Word-by-Word ‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#020a1a;
      --panel-soft:#050f25;
      --muted:#a8b3c7;
      --text:#f9fafb;
      --accent:#22c55e;
      --gold:#fbbf24;
      --soft-border:rgba(148,163,184,0.3);
      --radius:12px;
      --shadow:0 12px 28px rgba(0,0,0,0.75);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Noto Sans Bengali",sans-serif;
      background:radial-gradient(circle at top,#020c1f 0,#020617 45%,#000 100%);
      color:var(--text);
    }
    button{font-family:inherit;cursor:pointer}
    a{color:inherit;text-decoration:none}

    .app{max-width:1150px;margin:8px auto 14px;padding:6px}

    /* SINGLE TOP BAR (mobile-friendly) */
    .topbar{
      position:sticky;top:0;z-index:120;
      display:flex;align-items:center;justify-content:space-between;gap:6px;
      padding:6px 8px;
      border-radius:12px;
      background:linear-gradient(90deg,rgba(15,23,42,0.98),rgba(15,23,42,0.92));
      border:1px solid rgba(148,163,184,0.4);
      box-shadow:var(--shadow);
      backdrop-filter:blur(8px);
      transform:translateY(0);
      transition:transform .25s ease;
    }
    .topbar.hidden{transform:translateY(-110%);}
    .topbar.visible{transform:translateY(0);}

    .top-left{display:flex;align-items:center;gap:8px}
    .hamburger{
      font-size:22px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--soft-border);
      background:rgba(15,23,42,0.6);
      color:#e5e7eb;  /* brighter */
    }
    .app-title{display:flex;flex-direction:column;}
    .app-main-title{font-weight:700;font-size:14px}
    .app-sub-title{font-size:11px;color:var(--muted)}

    .top-right{display:flex;align-items:center;gap:6px}
    .btn{
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--soft-border);
      background:rgba(15,23,42,0.8);
      color:var(--text);
      font-size:12px;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--accent),#16a34a);
      border:none;
      color:#022c22;
      font-weight:700;
    }

    .card{
      margin-top:8px;
      padding:8px;
      border-radius:14px;
      background:radial-gradient(circle at top,rgba(15,23,42,0.9),rgba(15,23,42,0.95));
      border:1px solid rgba(148,163,184,0.35);
      box-shadow:var(--shadow);
    }

    .sura-header{
      display:flex;justify-content:space-between;align-items:center;gap:6px;
      margin-bottom:4px;
    }
    .sura-title{font-size:16px;font-weight:700;}
    .sura-sub{font-size:11px;color:var(--muted)}

    .view-chips{display:flex;gap:4px;align-items:center}
    .chip{
      padding:3px 7px;font-size:11px;border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.7);
      color:var(--muted);
      cursor:pointer;
    }
    .chip.active{
      background:linear-gradient(90deg,var(--accent),#16a34a);
      color:#022c22;
      border:none;
      font-weight:600;
    }

    .aya-list{
      max-height:calc(100vh - 170px);
      overflow:auto;
      padding-right:6px;
    }
    .aya-row{
      display:grid;
      grid-template-columns:1fr 40px;
      gap:4px;
      padding:6px 4px;
      border-bottom:1px dashed rgba(148,163,184,0.25);
    }
    .aya-row:last-child{border-bottom:none;}

    @media(min-width:900px){
      .aya-row{grid-template-columns:26px 1fr 46px;}
      .aya-check-desktop{display:flex;}
    }
    @media(max-width:899px){
      .aya-check-desktop{display:none;}
    }

    .aya-check-desktop{
      align-items:flex-start;justify-content:center;padding-top:4px;
    }
    .aya-check-desktop input{width:16px;height:16px;accent-color:var(--accent);}

    .aya-text{overflow:hidden}
    .aya-meta{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;
    }
    .ayah-num{
      font-size:10px;
      padding:3px 6px;border-radius:999px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.4);
      color:var(--muted);
    }
    .tags{font-size:11px;color:var(--gold)}

    .aya-ar{
      font-family:"Scheherazade New","Amiri",serif;
      text-align:right;direction:rtl;
      margin-bottom:4px;
    }

    /* word tokens ‚Üí rounded square */
    .word-token{
      display:inline-block;
      padding:3px 7px;
      margin:2px 2px;
      border-radius:8px;       /* square with rounded edge */
      cursor:pointer;
      background:rgba(15,23,42,0.75);
      border:1px solid rgba(148,163,184,0.45);
    }
    .word-token:hover{background:rgba(34,197,94,0.12);}

    .aya-bn-block{
      margin-top:4px;
      padding:5px 6px;
      border-radius:10px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(148,163,184,0.36);
    }
    .aya-bn-label{font-size:10px;color:var(--muted);margin-bottom:2px}
    .aya-bn-text{font-size:13px;line-height:1.6}

    .aya-actions{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .dots-btn{
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:18px;
      padding:0 4px;
      border-radius:6px;
    }
    .dots-btn:hover{background:rgba(15,23,42,0.7);}
    .mini-menu{
      position:absolute;
      right:4px;top:26px;
      min-width:160px;
      background:var(--panel-soft);
      border-radius:10px;
      border:1px solid var(--soft-border);
      padding:4px;
      box-shadow:var(--shadow);
      display:none;
      z-index:140;
    }
    .mini-menu.show{display:block}
    .mini-menu button{
      display:block;width:100%;text-align:left;
      padding:5px 7px;
      font-size:12px;
      background:transparent;border:none;color:var(--text);
      border-radius:6px;
    }
    .mini-menu button:hover{background:rgba(148,163,184,0.12);}

    /* word popup */
    .word-popup{
      position:fixed;
      z-index:200;
      min-width:230px;
      max-width:320px;
      background:var(--panel-soft);
      border-radius:12px;
      border:1px solid var(--soft-border);
      padding:8px 8px 6px 8px;
      display:none;
      box-shadow:var(--shadow);
    }
    .word-popup-header{
      display:flex;justify-content:space-between;align-items:flex-start;gap:6px;
    }
    .word-popup .arabic{
      font-family:"Scheherazade New","Amiri",serif;
      text-align:left;   /* left side for comfort */
    }
    .word-popup .meaning{
      margin-top:4px;font-size:13px;
    }
    .word-popup .notes{
      margin-top:4px;font-size:12px;color:var(--muted);
      max-height:150px;overflow:auto;
    }
    .word-popup-close{
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:16px;
      padding:0 2px;
      cursor:pointer;
    }

    /* drawer */
    .drawer{
      position:fixed;
      left:-320px;top:0;
      height:100vh;width:280px;
      background:var(--panel-soft);
      box-shadow:8px 0 28px rgba(0,0,0,0.8);
      border-right:1px solid var(--soft-border);
      padding:8px;
      z-index:160;
      transition:left .25s ease;
    }
    .drawer.open{left:4px;}
    .drawer h3{margin:4px 0 6px;font-size:14px}
    .drawer .close-x{float:right}
    .sura-full-list{
      max-height:calc(100vh - 120px);
      overflow:auto;padding-right:4px;
    }
    .sura-full-item{
      padding:6px;border-radius:9px;margin-bottom:4px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.4);
      cursor:pointer;
    }
    .sura-full-item:hover{
      box-shadow:0 8px 20px rgba(0,0,0,0.7);
      transform:translateY(-1px);
    }

    .last-read{
      margin:6px 2px 4px;
      padding:5px 7px;
      border-radius:10px;
      background:linear-gradient(90deg,rgba(22,163,74,0.2),rgba(56,189,248,0.15));
      border:1px solid rgba(45,212,191,0.4);
      display:flex;justify-content:space-between;gap:6px;align-items:center;
      font-size:12px;
    }
    .last-read .actions{display:flex;gap:4px}

    .multi-bar{
      position:fixed;
      left:50%;transform:translateX(-50%);
      bottom:8px;
      background:radial-gradient(circle at top,rgba(15,23,42,0.96),rgba(15,23,42,0.98));
      border-radius:999px;
      border:1px solid var(--soft-border);
      padding:5px 8px;
      display:none;
      gap:6px;align-items:center;
      z-index:200;
      box-shadow:var(--shadow);
    }
    .multi-bar.show{display:flex}
    #multiCount{font-size:11px;color:var(--muted)}

    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,0.8);
      display:none;align-items:center;justify-content:center;
      z-index:220;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      background:var(--panel-soft);
      border-radius:12px;
      border:1px solid var(--soft-border);
      max-width:900px;width:96%;
      max-height:90vh;
      overflow:auto;
      padding:10px;
      box-shadow:var(--shadow);
    }
    textarea{
      background:#020617;
      color:var(--text);
      border-radius:10px;
      border:1px solid var(--soft-border);
    }

  </style>
</head>
<body>
  <div class="app">
    <!-- Top bar -->
    <div id="topbar" class="topbar visible">
      <div class="top-left">
        <button id="hamburger" class="hamburger" title="‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ">‚â°</button>
        <div class="app-title">
          <div class="app-main-title">Qur'an ‚Ä¢ Word-by-Word</div>
          <div id="topSuraName" class="app-sub-title">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
        </div>
      </div>
      <div class="top-right">
        <button id="openSettings" class="btn">‚öôÔ∏è Settings</button>
        <button id="openMore" class="btn">‚ãÆ More</button>
      </div>
    </div>

    <!-- main card: sura header + ayat list -->
    <div class="card">
      <div class="sura-header">
        <div>
          <div id="currentSuraTitle" class="sura-title">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
          <div id="currentSuraSub" class="sura-sub">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶¨‡ßá</div>
        </div>
        <div class="view-chips" id="viewButtons">
          <div class="chip" data-view="both">‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</div>
          <div class="chip" data-view="ar">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</div>
          <div class="chip" data-view="bn">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</div>
        </div>
      </div>

      <div id="lastReadContainer"></div>
      <div id="ayaList" class="aya-list"></div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawer" class="drawer">
    <button id="drawerClose" class="btn close-x">‚úï</button>
    <h3>‡¶∏‡ßÇ‡¶∞‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
    <input id="drawerSearch" placeholder="‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶æ‡¶Æ / ‡¶®‡¶Ç..." style="width:100%;padding:6px;border-radius:999px;border:1px solid var(--soft-border);margin-bottom:6px;background:rgba(15,23,42,0.8);color:var(--text);font-size:12px"/>
    <div id="drawerList" class="sura-full-list"></div>
  </div>

  <!-- Word popup -->
  <div id="wordPopup" class="word-popup">
    <div class="word-popup-header">
      <div>
        <div id="wpArabic" class="arabic"></div>
        <div id="wpMeaning" class="meaning"></div>
      </div>
      <button id="wpClose" class="word-popup-close" title="Close">‚úï</button>
    </div>
    <div id="wpNotes" class="notes"></div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div id="modalWindow" class="modal"></div>
  </div>

  <!-- Multi-bar -->
  <div id="multiBar" class="multi-bar">
    <div id="multiCount">0 ‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</div>
    <button id="multiCopyBtn" class="btn">üìã Copy</button>
    <button id="multiShareBtn" class="btn primary">üîó Share</button>
    <button id="multiClearBtn" class="btn">‚úñ Clear</button>
  </div>

  <!-- sura meta -->
  <script src="suras.js"></script>
  <script>
  (function(){
    if(!window.suras || !Array.isArray(window.suras)){
      alert('suras.js ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø ‡¶¨‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
      return;
    }

    const S = {
      get(k,def){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}},
      set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
    };

    const STATE = {
      curSuraIndex:0,
      curSurahData:null,
      view:S.get('q_view','both'),
      showOsmani:S.get('q_showOsmani',true),
      showTawjih:S.get('q_showTawjih',true),
      fontArabic:S.get('q_fontArabic',22),
      fontBanglaMain:S.get('q_fontBanglaMain',13),   // default translation
      fontOsmani:S.get('q_fontOsmani',12),
      fontTawjih:S.get('q_fontTawjih',12),
      fontGrammar:S.get('q_fontGrammar',12),
      fontPopupArabic:S.get('q_fontPopupArabic',22),
      lineHeight:S.get('q_lineHeight',1.7),
      pins:S.get('q_pins',[]),
      favs:S.get('q_favs',[]),
      lastRead:S.get('q_lastRead',null),
      selected:new Set(),
      multiMode:false,
      fullscreen:S.get('q_fullscreen',false)
    };

    const topbar = document.getElementById('topbar');
    const hamburger = document.getElementById('hamburger');
    const drawer = document.getElementById('drawer');
    const drawerClose = document.getElementById('drawerClose');
    const drawerList = document.getElementById('drawerList');
    const drawerSearch = document.getElementById('drawerSearch');
    const topSuraName = document.getElementById('topSuraName');

    const currentSuraTitle=document.getElementById('currentSuraTitle');
    const currentSuraSub=document.getElementById('currentSuraSub');
    const ayaListEl=document.getElementById('ayaList');
    const lastReadContainer=document.getElementById('lastReadContainer');

    const wordPopup=document.getElementById('wordPopup');
    const wpArabic=document.getElementById('wpArabic');
    const wpMeaning=document.getElementById('wpMeaning');
    const wpNotes=document.getElementById('wpNotes');
    const wpClose=document.getElementById('wpClose');

    const modalBackdrop=document.getElementById('modalBackdrop');
    const modalWindow=document.getElementById('modalWindow');

    const multiBar=document.getElementById('multiBar');
    const multiCount=document.getElementById('multiCount');

    // drawer
    hamburger.addEventListener('click',()=>{ drawer.classList.add('open'); });
    drawerClose.addEventListener('click',()=>{ drawer.classList.remove('open'); });
    drawerSearch.addEventListener('input',()=>renderDrawerList(drawerSearch.value));

    function renderDrawerList(filter=''){
      drawerList.innerHTML='';
      const ft=(filter||'').trim().toLowerCase();
      window.suras.forEach((s,idx)=>{
        const bn=s.nameBn||s.name_bn||s.name||'';
        const ar=s.nameAr||s.name_ar||'';
        const id=s.number||idx+1;
        if(ft && !(bn.toLowerCase().includes(ft) || ar.toLowerCase().includes(ft) || String(id)===ft)) return;
        const div=document.createElement('div');
        div.className='sura-full-item';
        div.innerHTML='<div style="font-weight:600;font-size:13px">'+id+'. '+bn+'</div><div style="font-size:11px;color:var(--muted)">'+ar+' ‚Ä¢ '+(s.ayahCount||(s.ayahs?s.ayahs.length:'?'))+' ‡¶Ü‡ßü‡¶æ‡¶§</div>';
        div.addEventListener('click',()=>{ setCurrentSura(idx); drawer.classList.remove('open'); });
        drawerList.appendChild(div);
      });
    }
    renderDrawerList();

    function keyOf(s,a){return s+':'+a}
    function findIndexByKey(arr,key){return arr.findIndex(x=>x.key===key)}
    function escapeHtml(s){if(!s) return '';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

    function extractTranslationsFromAyah(ayah){
      const main = ayah.bangla||ayah.bn||ayah.bangla_main||ayah.main_bn||ayah.translation||ayah.text_bn||ayah.meaning||'';
      let os='',tw='';
      if(ayah.translations && typeof ayah.translations==='object'){
        os = ayah.translations.osmani || ayah.translations.osman || ayah.translations.osmn || '';
        tw = ayah.translations.tawjih || ayah.translations.tawzeeh || ayah.translations.tawjihul || '';
      }
      os = os || ayah.bangla_osmani || ayah.bn_osmani || ayah.osmani || ayah.tafseer_osmani || '';
      tw = tw || ayah.bangla_tawzeeh || ayah.bn_tawzeeh || ayah.tawzeeh || ayah.taozeeh || '';
      return {main,os,tw};
    }

    async function setCurrentSura(idx){
      STATE.curSuraIndex=idx;
      const meta=window.suras[idx]||{};
      currentSuraTitle.textContent=(meta.number||idx+1)+'. '+(meta.nameBn||meta.name||'');
      currentSuraSub.textContent=(meta.nameAr||'')+' ‚Ä¢ '+(meta.revelationPlace||meta.type||'')+' ‚Ä¢ '+((meta.ayahCount)||(meta.ayahs?meta.ayahs.length:'?'))+' ‡¶Ü‡ßü‡¶æ‡¶§';
      topSuraName.textContent = meta.nameBn || meta.name || '‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';

      STATE.curSurahData=null;
      if(meta.file){
        try{
          const res = await fetch(meta.file);
          if(!res.ok) throw new Error('HTTP error');
          STATE.curSurahData = await res.json();
        }catch(e){
          console.error('surah load failed',e);
          STATE.curSurahData = meta;
        }
      }else STATE.curSurahData = meta;

      STATE.selected.clear();
      renderAyaList();
      renderLastRead();
      renderMultiBar();
    }

    function renderAyaList(){
      ayaListEl.innerHTML='';
      const data=STATE.curSurahData||{};
      const ayas=Array.isArray(data.ayahs)?data.ayahs:(data.ayas||[]);
      ayas.forEach((ayah,idx)=>{
        const row=document.createElement('div');
        row.className='aya-row';
        row.id='aya-'+STATE.curSuraIndex+'-'+idx;

        const chkCol=document.createElement('div');
        chkCol.className='aya-check-desktop';
        const cb=document.createElement('input');
        cb.type='checkbox';
        const k=keyOf(STATE.curSuraIndex,idx);
        cb.checked=STATE.selected.has(k);
        cb.addEventListener('change',()=>{
          if(cb.checked) STATE.selected.add(k); else STATE.selected.delete(k);
          renderMultiBar();
        });
        chkCol.appendChild(cb);

        const textCol=document.createElement('div'); textCol.className='aya-text';
        const metaRow=document.createElement('div'); metaRow.className='aya-meta';
        const num=document.createElement('div'); num.className='ayah-num'; num.textContent=(STATE.curSuraIndex+1)+':'+(idx+1);
        const tags=document.createElement('div'); tags.className='tags';
        if(findIndexByKey(STATE.pins,k)!==-1) tags.textContent+='üìå ';
        if(findIndexByKey(STATE.favs,k)!==-1) tags.textContent+='‚≠ê';
        metaRow.appendChild(num); metaRow.appendChild(tags);
        textCol.appendChild(metaRow);

        const arDiv=document.createElement('div'); arDiv.className='aya-ar';
        arDiv.style.fontSize=STATE.fontArabic+'px';
        arDiv.style.lineHeight=STATE.lineHeight;
        if(Array.isArray(ayah.words)&&ayah.words.length){
          ayah.words.forEach(w=>{
            const span=document.createElement('span');
            span.className='word-token';
            span.textContent=w.text||w.word||'';
            span.dataset.meaning=w.meaningBn||w.meaning||w.meaning_bn||w.meaning_en||'';
            span.dataset.notes=w.notes||w.note||w.grammar||ayah.grammar||'';
            span.addEventListener('click',(ev)=>openWordPopup(ev.currentTarget,ayah));
            arDiv.appendChild(span);
          });
        }else{
          arDiv.textContent=ayah.arabic||ayah.ar||ayah.text_ar||'';
        }
        if(STATE.view==='bn') arDiv.style.display='none';
        textCol.appendChild(arDiv);

        if(STATE.view!=='ar'){
          const blocks=extractTranslationsFromAyah(ayah);
          if(blocks.main){
            const b=document.createElement('div'); b.className='aya-bn-block';
            b.style.fontSize=STATE.fontBanglaMain+'px';
            b.innerHTML='<div class="aya-bn-text">'+escapeHtml(blocks.main)+'</div>';
            textCol.appendChild(b);
          }
          if(blocks.os&&STATE.showOsmani){
            const b=document.createElement('div'); b.className='aya-bn-block';
            b.innerHTML='<div class="aya-bn-label">‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ</div><div class="aya-bn-text" style="font-size:'+STATE.fontOsmani+'px">'+escapeHtml(blocks.os)+'</div>';
            textCol.appendChild(b);
          }
          if(blocks.tw&&STATE.showTawjih){
            const b=document.createElement('div'); b.className='aya-bn-block';
            b.innerHTML='<div class="aya-bn-label">‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®</div><div class="aya-bn-text" style="font-size:'+STATE.fontTawjih+'px">'+escapeHtml(blocks.tw)+'</div>';
            textCol.appendChild(b);
          }
          const g=ayah.grammar||ayah.grammarNotes||ayah.notes||'';
          if(g){
            const b=document.createElement('div'); b.className='aya-bn-block';
            b.innerHTML='<div class="aya-bn-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü</div><div class="aya-bn-text" style="font-size:'+STATE.fontGrammar+'px">'+escapeHtml(g)+'</div>';
            textCol.appendChild(b);
          }
        }

        textCol.addEventListener('click',(ev)=>{
          if(ev.target.classList.contains('word-token')) return;
          if(STATE.multiMode){
            const key=keyOf(STATE.curSuraIndex,idx);
            if(STATE.selected.has(key)) STATE.selected.delete(key);
            else STATE.selected.add(key);
            renderMultiBar();
            cb.checked = STATE.selected.has(key);
          }
        });

        const actCol=document.createElement('div'); actCol.className='aya-actions';
        const wrap=document.createElement('div'); wrap.style.position='relative';
        const dotsBtn=document.createElement('button'); dotsBtn.className='dots-btn'; dotsBtn.innerHTML='‚ãØ';
        const menu=document.createElement('div'); menu.className='mini-menu';
        const miPin=document.createElement('button'); miPin.textContent=(findIndexByKey(STATE.pins,k)!==-1?'Unpin üìç':'Pin üìå');
        const miFav=document.createElement('button'); miFav.textContent=(findIndexByKey(STATE.favs,k)!==-1?'Unfav ‚òÜ':'Favourite ‚≠ê');
        const miCopy=document.createElement('button'); miCopy.textContent='Copy üìã';
        const miShare=document.createElement('button'); miShare.textContent='Share üîó';
        const miLast=document.createElement('button'); miLast.textContent='Set Last Read ‚è±';

        [miPin,miFav,miCopy,miShare,miLast].forEach(btn=>menu.appendChild(btn));
        dotsBtn.addEventListener('click',(e)=>{
          e.stopPropagation();
          document.querySelectorAll('.mini-menu').forEach(m=>m.classList.remove('show'));
          menu.classList.toggle('show');
        });
        document.addEventListener('click',()=>{ menu.classList.remove('show'); });

        miPin.addEventListener('click',()=>{
          togglePin(k,STATE.curSuraIndex,idx); menu.classList.remove('show'); renderAyaList();
        });
        miFav.addEventListener('click',()=>{
          toggleFav(k,STATE.curSuraIndex,idx); menu.classList.remove('show'); renderAyaList();
        });
        miCopy.addEventListener('click',()=>{
          navigator.clipboard.writeText(formatAyaForCopy(STATE.curSuraIndex,idx,'both')).then(()=>alert('Copied'));
          menu.classList.remove('show');
        });
        miShare.addEventListener('click',()=>{
          doShare(formatAyaForCopy(STATE.curSuraIndex,idx,'both'));
          menu.classList.remove('show');
        });
        miLast.addEventListener('click',()=>{
          STATE.lastRead={surahIndex:STATE.curSuraIndex,ayaIndex:idx,time:Date.now()};
          S.set('q_lastRead',STATE.lastRead);
          renderLastRead();
          alert('Last read set');
          menu.classList.remove('show');
        });

        wrap.appendChild(dotsBtn); wrap.appendChild(menu);
        actCol.appendChild(wrap);

        row.appendChild(chkCol);
        row.appendChild(textCol);
        row.appendChild(actCol);
        ayaListEl.appendChild(row);
      });
    }

    function formatAyaForCopy(sIdx,aIdx,mode){
      const sura=window.suras[sIdx]||{};
      const data=(STATE.curSurahData && STATE.curSuraIndex===sIdx)?(STATE.curSurahData.ayahs||STATE.curSurahData.ayas||[]):(sura.ayahs||sura.ayas||[]);
      const aya=data[aIdx]||{};
      const ar=aya.arabic||aya.ar||aya.text_ar||'';
      const blocks=extractTranslationsFromAyah(aya);
      const bn=blocks.main||'';
      const head='['+(sura.nameBn||sura.name||'')+' '+(sIdx+1)+':'+(aIdx+1)+']';
      if(mode==='ar') return ar+'\n'+head;
      if(mode==='bn') return bn+'\n'+head;
      return (ar?ar+'\n':'')+(bn?bn+'\n':'')+head;
    }
    function formatMultipleSelection(mode){
      return Array.from(STATE.selected).map(k=>{
        const [s,a]=k.split(':').map(Number);
        return formatAyaForCopy(s,a,mode);
      }).join('\n\n');
    }

    function doShare(text){
      if(navigator.share) navigator.share({text}).catch(()=>{navigator.clipboard.writeText(text)});
      else navigator.clipboard.writeText(text).then(()=>alert('Copied to clipboard'));
    }

    function togglePin(key,sIdx,aIdx){
      const i=findIndexByKey(STATE.pins,key);
      if(i>=0) STATE.pins.splice(i,1);
      else STATE.pins.unshift({key,surahIndex:sIdx,ayahIndex:aIdx,note:'',time:Date.now()});
      S.set('q_pins',STATE.pins);
    }
    function toggleFav(key,sIdx,aIdx){
      const i=findIndexByKey(STATE.favs,key);
      if(i>=0) STATE.favs.splice(i,1);
      else STATE.favs.unshift({key,surahIndex:sIdx,ayahIndex:aIdx,note:'',time:Date.now()});
      S.set('q_favs',STATE.favs);
    }

    function renderLastRead(){
      lastReadContainer.innerHTML='';
      if(!STATE.lastRead) return;
      const lr=STATE.lastRead;
      const sura=window.suras[lr.surahIndex]||{};
      const el=document.createElement('div');
      el.className='last-read';
      el.innerHTML='<div><strong>‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ:</strong> '+(sura.nameBn||sura.name||'')+' '+(lr.surahIndex+1)+':'+(lr.ayaIndex+1)+'</div><div class="actions"><button id="goLast" class="btn primary">‚è± Continue</button><button id="clrLast" class="btn">Reset</button></div>';
      lastReadContainer.appendChild(el);
      document.getElementById('goLast').onclick=()=>{
        setCurrentSura(lr.surahIndex);
        setTimeout(()=>{
          const node=document.getElementById('aya-'+lr.surahIndex+'-'+lr.ayaIndex);
          if(node) node.scrollIntoView({behavior:'smooth',block:'center'});
        },200);
      };
      document.getElementById('clrLast').onclick=()=>{
        STATE.lastRead=null; S.set('q_lastRead',null); renderLastRead();
      };
    }

    function renderMultiBar(){
      const c=STATE.selected.size;
      if(c>0){multiCount.textContent=c+' ‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®';multiBar.classList.add('show');}
      else multiBar.classList.remove('show');
    }

    document.getElementById('multiCopyBtn').onclick=()=>{
      if(STATE.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø');
      const txt=formatMultipleSelection('both');
      openCopyModal(txt);
    };
    document.getElementById('multiShareBtn').onclick=()=>{
      if(STATE.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø');
      doShare(formatMultipleSelection('both'));
    };
    document.getElementById('multiClearBtn').onclick=()=>{
      STATE.selected.clear(); renderMultiBar(); renderAyaList();
    };

    function openCopyModal(prefill){
      modalWindow.innerHTML='<h3>Copy / Share</h3>'+
        '<div style="margin-top:6px;font-size:12px">'+
        '<label><input type="radio" name="fmt" value="both" checked> ‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label> &nbsp;'+
        '<label><input type="radio" name="fmt" value="ar"> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</label> &nbsp;'+
        '<label><input type="radio" name="fmt" value="bn"> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label>'+
        '</div>'+
        '<textarea id="copyPreview" style="width:100%;height:160px;margin-top:6px;padding:6px">'+(prefill||'')+'</textarea>'+
        '<div style="margin-top:6px;display:flex;justify-content:flex-end;gap:6px">'+
        '<button id="copyDo" class="btn primary">Copy</button>'+
        '<button id="shareDo" class="btn">Share</button>'+
        '<button id="copyClose" class="btn">Close</button>'+
        '</div>';
      modalBackdrop.classList.add('show');
      document.getElementById('copyDo').onclick=()=>{navigator.clipboard.writeText(document.getElementById('copyPreview').value||'').then(()=>alert('Copied'));};
      document.getElementById('shareDo').onclick=()=>{doShare(document.getElementById('copyPreview').value||'');};
      document.getElementById('copyClose').onclick=()=>{modalBackdrop.classList.remove('show');};
    }

    // Settings modal
    document.getElementById('openSettings').addEventListener('click',()=>{
      modalWindow.innerHTML=
        '<h3>Settings</h3>'+
        '<div style="margin-top:6px;font-size:13px">'+
          '<label><input type="checkbox" id="cOsmani"> ‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì</label><br>'+
          '<label><input type="checkbox" id="cTawjih"> ‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì</label><br>'+
          '<label><input type="checkbox" id="cFull"> Full screen reading (top bar auto hide)</label>'+
        '</div>'+
        '<div style="margin-top:8px;font-size:12px;line-height:1.8">'+
          '<div>Arabic font size (<span id="nArabic">'+STATE.fontArabic+'</span>)<br><input id="fArabic" type="range" min="18" max="32" value="'+STATE.fontArabic+'"></div>'+
          '<div style="margin-top:4px;">Default ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ (<span id="nBanglaMain">'+STATE.fontBanglaMain+'</span>)<br><input id="fBanglaMain" type="range" min="11" max="22" value="'+STATE.fontBanglaMain+'"></div>'+
          '<div style="margin-top:4px;">‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ (<span id="nOsmani">'+STATE.fontOsmani+'</span>)<br><input id="fOsmani" type="range" min="11" max="22" value="'+STATE.fontOsmani+'"></div>'+
          '<div style="margin-top:4px;">‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® (<span id="nTawjih">'+STATE.fontTawjih+'</span>)<br><input id="fTawjih" type="range" min="11" max="22" value="'+STATE.fontTawjih+'"></div>'+
          '<div style="margin-top:4px;">Grammar notes (<span id="nGrammar">'+STATE.fontGrammar+'</span>)<br><input id="fGrammar" type="range" min="11" max="22" value="'+STATE.fontGrammar+'"></div>'+
          '<div style="margin-top:4px;">Word popup Arabic (<span id="nPopupAr">'+STATE.fontPopupArabic+'</span>)<br><input id="fPopupAr" type="range" min="18" max="32" value="'+STATE.fontPopupArabic+'"></div>'+
        '</div>'+
        '<div style="margin-top:8px;display:flex;justify-content:flex-end;gap:6px">'+
          '<button id="saveSt" class="btn primary">Save</button>'+
          '<button id="closeSt" class="btn">Close</button>'+
        '</div>';
      modalBackdrop.classList.add('show');

      document.getElementById('cOsmani').checked=STATE.showOsmani;
      document.getElementById('cTawjih').checked=STATE.showTawjih;
      document.getElementById('cFull').checked=STATE.fullscreen;

      const bindRange=(idRange,idNum,prop)=>{
        const r=document.getElementById(idRange);
        const n=document.getElementById(idNum);
        r.addEventListener('input',()=>{n.textContent=r.value;});
      };
      bindRange('fArabic','nArabic');
      bindRange('fBanglaMain','nBanglaMain');
      bindRange('fOsmani','nOsmani');
      bindRange('fTawjih','nTawjih');
      bindRange('fGrammar','nGrammar');
      bindRange('fPopupAr','nPopupAr');

      document.getElementById('closeSt').onclick=()=>modalBackdrop.classList.remove('show');
      document.getElementById('saveSt').onclick=()=>{
        STATE.showOsmani=document.getElementById('cOsmani').checked;
        STATE.showTawjih=document.getElementById('cTawjih').checked;
        STATE.fullscreen=document.getElementById('cFull').checked;

        STATE.fontArabic=+document.getElementById('fArabic').value;
        STATE.fontBanglaMain=+document.getElementById('fBanglaMain').value;
        STATE.fontOsmani=+document.getElementById('fOsmani').value;
        STATE.fontTawjih=+document.getElementById('fTawjih').value;
        STATE.fontGrammar=+document.getElementById('fGrammar').value;
        STATE.fontPopupArabic=+document.getElementById('fPopupAr').value;

        S.set('q_showOsmani',STATE.showOsmani);
        S.set('q_showTawjih',STATE.showTawjih);
        S.set('q_fontArabic',STATE.fontArabic);
        S.set('q_fontBanglaMain',STATE.fontBanglaMain);
        S.set('q_fontOsmani',STATE.fontOsmani);
        S.set('q_fontTawjih',STATE.fontTawjih);
        S.set('q_fontGrammar',STATE.fontGrammar);
        S.set('q_fontPopupArabic',STATE.fontPopupArabic);
        S.set('q_fullscreen',STATE.fullscreen);

        modalBackdrop.classList.remove('show');
        applyFullscreenMode();
        renderAyaList();
      };
    });

    // More menu
    document.getElementById('openMore').addEventListener('click',()=>{
      modalWindow.innerHTML=
        '<h3>More</h3>'+
        '<div style="margin-top:6px;font-size:13px">'+
          '<p><label><input type="checkbox" id="cMultiMode"> Multi-select mode (tap ayah to select)</label></p>'+
          '<button id="openPins" class="btn">üìå Pins & Favourites</button>'+
        '</div>'+
        '<div style="margin-top:8px;display:flex;justify-content:flex-end"><button id="closeMore" class="btn">Close</button></div>';
      modalBackdrop.classList.add('show');
      document.getElementById('cMultiMode').checked=STATE.multiMode;
      document.getElementById('cMultiMode').onchange=(e)=>{
        STATE.multiMode=e.target.checked;
        if(!STATE.multiMode){STATE.selected.clear();renderMultiBar();renderAyaList();}
      };
      document.getElementById('openPins').onclick=()=>{openPinsModal();};
      document.getElementById('closeMore').onclick=()=>modalBackdrop.classList.remove('show');
    });

    function openPinsModal(){
      let html='<h3>Pins & Favourites</h3><div style="margin-top:6px">';
      const combo=[...STATE.pins.map(p=>({kind:'pin',...p})),...STATE.favs.map(f=>({kind:'fav',...f}))];
      if(combo.length===0) html+='<div style="color:var(--muted);font-size:12px">No pins or favourites.</div>';
      combo.forEach((it,i)=>{
        const s=window.suras[it.surahIndex]||{};
        const label=(it.kind==='pin'?'üìå ':'‚≠ê ')+(s.nameBn||s.name||'')+' '+(it.surahIndex+1)+':'+(it.ayahIndex+1);
        html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(148,163,184,0.3)">'+
          '<div style="font-size:12px"><strong>'+label+'</strong></div>'+
          '<div style="display:flex;gap:4px">'+
          '<button data-go="'+i+'" class="btn">Go</button>'+
          '<button data-copy="'+i+'" class="btn">üìã</button>'+
          '<button data-del="'+i+'" class="btn">üóë</button>'+
          '</div></div>';
      });
      html+='</div><div style="margin-top:6px;display:flex;justify-content:flex-end"><button id="closePinsModal" class="btn">Close</button></div>';
      modalWindow.innerHTML=html;
      modalWindow.querySelectorAll('[data-go]').forEach(btn=>{
        btn.onclick=()=>{
          const i=+btn.dataset.go;const it=combo[i];
          modalBackdrop.classList.remove('show');
          setCurrentSura(it.surahIndex);
          setTimeout(()=>{
            const el=document.getElementById('aya-'+it.surahIndex+'-'+it.ayahIndex);
            if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
          },200);
        };
      });
      modalWindow.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.onclick=()=>{
          const i=+btn.dataset.copy;const it=combo[i];
          navigator.clipboard.writeText(formatAyaForCopy(it.surahIndex,it.ayahIndex,'both')).then(()=>alert('Copied'));
        };
      });
      modalWindow.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick=()=>{
          const i=+btn.dataset.del;const it=combo[i];
          if(confirm('Delete?')){
            if(it.kind==='pin') STATE.pins=STATE.pins.filter(x=>x.key!==it.key);
            else STATE.favs=STATE.favs.filter(x=>x.key!==it.key);
            S.set('q_pins',STATE.pins); S.set('q_favs',STATE.favs);
            openPinsModal();
          }
        };
      });
      document.getElementById('closePinsModal').onclick=()=>modalBackdrop.classList.remove('show');
    }

    // word popup
    function openWordPopup(target,ayah){
      const meaning = target.dataset.meaning || '';
      const notes   = target.dataset.notes || ayah.grammar || ayah.notes || '';
      wpArabic.textContent=target.textContent||'';
      wpMeaning.textContent=meaning;
      wpNotes.textContent=notes;
      wpArabic.style.fontSize=STATE.fontPopupArabic+'px';

      const rect=target.getBoundingClientRect();
      let top=rect.bottom+window.scrollY+6;
      let left=rect.left+window.scrollX-20;
      if(left+320>window.innerWidth) left=window.innerWidth-330;
      if(left<6) left=6;
      wordPopup.style.top=top+'px';
      wordPopup.style.left=left+'px';
      wordPopup.style.display='block';
    }
    wpClose.onclick=()=>{wordPopup.style.display='none';};

    modalBackdrop.addEventListener('click',(e)=>{if(e.target===modalBackdrop) modalBackdrop.classList.remove('show');});

    // view
    document.querySelectorAll('#viewButtons .chip').forEach(ch=>{
      if(ch.dataset.view===STATE.view) ch.classList.add('active');
      ch.addEventListener('click',()=>{
        document.querySelectorAll('#viewButtons .chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        STATE.view=ch.dataset.view;
        S.set('q_view',STATE.view);
        renderAyaList();
      });
    });

    // fullscreen mode
    function applyFullscreenMode(){
      if(!STATE.fullscreen){
        topbar.classList.add('visible');
        topbar.classList.remove('hidden');
        document.body.onclick=null;
      }else{
        topbar.classList.add('visible');
        topbar.classList.remove('hidden');
        document.body.onclick=(e)=>{
          if(e.target.closest && (e.target.closest('.topbar') || e.target.closest('.drawer') || e.target.closest('.modal') || e.target.closest('.word-popup'))) return;
          if(topbar.classList.contains('hidden')){
            topbar.classList.remove('hidden');topbar.classList.add('visible');
          }else{
            topbar.classList.remove('visible');topbar.classList.add('hidden');
          }
        };
      }
    }
    applyFullscreenMode();

    // initial
    setCurrentSura(0);
    window.QAPP={STATE,setCurrentSura};
  })();
  </script>
</body>
</html>
