<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>AL-QUR'AN ‚Äî Word by Word</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* (CSS largely same as previous, a bit trimmed) */
    :root{
      --bg:#0f172a; --card:#0b1220; --muted:#9ca3af; --accent:#22c55e; --glass:rgba(15,23,42,0.95)
    }
    body{margin:0;font-family:system-ui,Segoe UI,Arial;background:var(--bg);color:#e5e7eb}
    .app{max-width:920px;margin:0 auto;min-height:100vh;padding-bottom:120px}
    header{position:sticky;top:0;z-index:60;background:var(--glass);backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,0.12)}
    .head-inner{display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;gap:.6rem}
    .brand{display:flex;flex-direction:column}
    .brand .main{font-weight:700;font-size:1rem;color: #bef264}
    .brand .sub{font-size:.78rem;color:var(--muted)}
    .head-actions{display:flex;gap:.45rem;align-items:center}
    button.btn{border-radius:999px;padding:.35rem .65rem;border:1px solid rgba(148,163,184,.15);background:transparent;color:#e5e7eb;cursor:pointer}
    button.ghost{background:transparent}
    .sticky-bar{display:flex;gap:.6rem;align-items:center}
    .sura-title-small{font-size:.9rem;font-weight:600}
    .sura-sub-small{font-size:.78rem;color:var(--muted)}
    main{padding:1rem}
    .card{background:linear-gradient(180deg,#071026,#061021);border-radius:12px;padding:14px;border:1px solid rgba(148,163,184,.06);box-shadow:0 14px 34px rgba(2,6,23,.6);margin-bottom:12px}
    select.select{width:100%;padding:.66rem;border-radius:8px;background:transparent;border:1px solid rgba(148,163,184,.12);color:#e5e7eb}
    .reader{display:none}
    .sura-header{display:flex;align-items:center;justify-content:space-between;gap:.6rem;margin-bottom:.6rem}
    .sura-info{display:flex;flex-direction:column}
    .bismillah{ text-align:center;margin:8px 0}
    .ayah{background:rgba(255,255,255,0.02);padding:.6rem;border-radius:8px;margin-bottom:.5rem;border:1px solid rgba(148,163,184,.05)}
    .ayah-ar{direction:rtl;text-align:right;font-family:"Scheherazade New",Amiri,serif;font-size:1.25rem;line-height:1.7}
    .ayah-bn{font-size:.92rem;color:#e5e7eb;margin-top:.36rem}
    .words-row{display:flex;flex-wrap:wrap;gap:.32rem;margin-top:.45rem}
    .word-pill{background:rgba(255,255,255,0.02);padding:.3rem .45rem;border-radius:6px;border:1px solid rgba(148,163,184,.06);cursor:pointer;min-width:68px;max-width:120px}
    .word-ar{font-family:"Scheherazade New",Amiri,serif;direction:rtl;text-align:left}
    .word-bn{font-size:.78rem;color:#e5e7eb;margin-top:.12rem;text-align:left}
    .word-detail{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,#042a2a,#021219);padding:.5rem;border-top:1px solid rgba(148,163,184,.08);display:none;z-index:70}
    .word-detail .inner{max-width:920px;margin:0 auto;display:flex;gap:.6rem;align-items:center;justify-content:space-between}
    .grammar-modal{position:fixed;inset:0;background:rgba(2,6,23,.7);display:none;align-items:center;justify-content:center;z-index:80;padding:12px}
    .modal-card{max-width:760px;width:100%;background:linear-gradient(180deg,#071026,#02101a);padding:14px;border-radius:12px;border:1px solid rgba(148,163,184,.07);max-height:80vh;overflow:auto}
    .settings-pane{position:fixed;left:0;right:0;bottom:0;background:var(--glass);padding:12px;border-top:1px solid rgba(148,163,184,.06);display:none;z-index:75}
    .row{display:flex;gap:.6rem;align-items:center}
    .grow{flex:1}
    .small{font-size:.8rem;color:var(--muted)}
    @media(max-width:640px){.head-inner{padding:.6rem .6rem}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="head-inner">
        <div style="display:flex;gap:.6rem;align-items:center">
          <div class="brand"><div class="main">AL-QUR'AN</div><div class="sub">Word-by-Word ‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π</div></div>
          <div class="sticky-bar">
            <div id="homeBtnWrap"><button id="btnHome" class="btn">üè† ‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</button></div>
            <div id="currentSuraTitle" style="display:none">
              <div class="sura-title-small" id="topSuraNameBn"></div>
              <div class="sura-sub-small" id="topSuraNameAr"></div>
            </div>
          </div>
        </div>

        <div class="head-actions">
          <div class="mode-toggle" id="modeToggleHeader">
            <button class="btn btn-mode active" data-mode="telawat">üìñ ‡¶§‡ßá‡¶≤‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶§</button>
            <button class="btn btn-mode" data-mode="wbw">üîç ‡¶∂‡¶¨‡ßç‡¶¶‡ßá-‡¶∂‡¶¨‡ßç‡¶¶‡ßá</button>
          </div>
          <button id="settingsOpen" class="btn">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç</button>
        </div>
      </div>
    </header>

    <main>
      <section class="card">
        <div style="display:flex;gap:.6rem;align-items:center;justify-content:space-between">
          <div><strong>‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</strong><div class="small">‡ßß‚Äì‡ßß‡ßß‡ß™ (‡¶Ø‡ßá ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏‡¶ó‡ßÅ‡¶≤‡ßã JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶∏‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶á ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá)</div></div>
        </div>
        <div style="margin-top:.8rem">
          <select id="suraSelect" class="select">
            <option value="">‚Äî ‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶® ‚Äî</option>
          </select>
        </div>
      </section>

      <section id="reader" class="card reader">
        <div class="sura-header">
          <div class="sura-info">
            <div id="suraNameBn" style="font-weight:700"></div>
            <div id="suraNameAr" class="small"></div>
          </div>
          <div style="display:flex;gap:.5rem;align-items:center">
            <div id="suraMeta" class="small"></div>
            <button id="backToListTop" class="btn">‚Üê ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶Ø‡¶º ‡¶´‡¶ø‡¶∞‡ßÅ‡¶®</button>
          </div>
        </div>

        <div id="bismillahBlock" class="bismillah"></div>

        <div id="ayahContainer"></div>
      </section>
    </main>

    <!-- bottom word detail -->
    <div id="wordDetail" class="word-detail">
      <div class="inner">
        <div style="display:flex;flex-direction:column">
          <div class="small" style="color:#bfead6">‡¶∂‡¶¨‡ßç‡¶¶‡ßá‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶•</div>
          <div id="detailAr" style="font-size:1.2rem;font-family:'Scheherazade New',Amiri,serif"></div>
          <div id="detailBn" class="small" style="margin-top:6px"></div>
        </div>
        <div style="display:flex;gap:.5rem;align-items:center">
          <button id="openGrammar" class="btn">üìò ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü</button>
          <button id="closeWord" class="btn">‚úï</button>
        </div>
      </div>
    </div>

    <!-- grammar modal -->
    <div id="grammarModal" class="grammar-modal">
      <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£‡¶ó‡¶§ ‡¶™‡¶∞‡¶ø‡¶ö‡¶ø‡¶§‡¶ø</div>
          <button id="closeGrammarModal" class="btn">‚úï</button>
        </div>
        <div id="grammarBody" class="small"></div>
      </div>
    </div>

    <!-- settings pane -->
    <div id="settingsPane" class="settings-pane">
      <div style="max-width:920px;margin:0 auto;display:flex;flex-direction:column;gap:.6rem">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">‡¶´‡¶®‡ßç‡¶ü & ‡¶≠‡¶ø‡¶â ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç</div>
          <div><button id="closeSettings" class="btn">‡¶¨‡¶®‡ßç‡¶ß</button></div>
        </div>

        <div style="display:flex;gap:.6rem;flex-wrap:wrap">
          <div style="flex:1;min-width:180px">
            <div class="small">‡¶Ü‡¶∞‡¶¨‡¶ø ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú <span id="arabicSizeShow"></span></div>
            <input id="arabicSize" type="range" min="1" max="2.5" step="0.05" value="1.25" />
          </div>
          <div style="flex:1;min-width:160px">
            <div class="small">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú <span id="banglaSizeShow"></span></div>
            <input id="banglaSize" type="range" min="0.7" max="1.6" step="0.05" value="0.92" />
          </div>
          <div style="flex:1;min-width:160px">
            <div class="small">‡¶®‡ßã‡¶ü ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú <span id="noteSizeShow"></span></div>
            <input id="noteSize" type="range" min="0.7" max="1.6" step="0.05" value="0.9" />
          </div>
        </div>

        <div style="display:flex;gap:.6rem;align-items:center">
          <div style="min-width:160px">
            <div class="small">‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶∏‡ßÇ‡¶∞‡¶æ-‡¶è ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶‡¶ï ‡¶•‡¶æ‡¶ï‡ßá)</div>
            <select id="translatorSelect" class="select"><option value="">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü</option></select>
          </div>
          <div class="grow small">Translator will override ayah-level bangla shown ‚Äî if available in <code>currentSura.translations[key]</code></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:.5rem">
          <button id="resetSettings" class="btn">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü</button>
        </div>
      </div>
    </div>
  </div>

  <!-- load suras list -->
  <script src="suras.js"></script>

  <script>
    // core state
    let currentSuraMeta = null;
    let currentSura = null;
    let currentMode = "telawat";
    let currentWord = null;
    let selectedTranslatorKey = "";

    // elements
    const suraSelect = document.getElementById("suraSelect");
    const reader = document.getElementById("reader");
    const ayahContainer = document.getElementById("ayahContainer");
    const bismillahBlock = document.getElementById("bismillahBlock");
    const suraNameBn = document.getElementById("suraNameBn");
    const suraNameAr = document.getElementById("suraNameAr");
    const suraMeta = document.getElementById("suraMeta");
    const topSuraNameBn = document.getElementById("topSuraNameBn");
    const topSuraNameAr = document.getElementById("topSuraNameAr");
    const currentSuraTitle = document.getElementById("currentSuraTitle");

    const wordDetail = document.getElementById("wordDetail");
    const detailAr = document.getElementById("detailAr");
    const detailBn = document.getElementById("detailBn");
    const openGrammar = document.getElementById("openGrammar");
    const closeWord = document.getElementById("closeWord");
    const grammarModal = document.getElementById("grammarModal");
    const grammarBody = document.getElementById("grammarBody");
    const closeGrammarModal = document.getElementById("closeGrammarModal");

    const settingsPane = document.getElementById("settingsPane");
    const settingsOpen = document.getElementById("settingsOpen");
    const closeSettings = document.getElementById("closeSettings");
    const translatorSelect = document.getElementById("translatorSelect");

    const arabicSize = document.getElementById("arabicSize");
    const banglaSize = document.getElementById("banglaSize");
    const noteSize = document.getElementById("noteSize");
    const arabicSizeShow = document.getElementById("arabicSizeShow");
    const banglaSizeShow = document.getElementById("banglaSizeShow");
    const noteSizeShow = document.getElementById("noteSizeShow");

    const modeToggleHeader = document.getElementById("modeToggleHeader");
    const btnHome = document.getElementById("btnHome");
    const backToListTop = document.getElementById("backToListTop");

    // populate sura list (suras variable comes from suras.js)
    function populateSuras() {
      if (typeof suras === "undefined") {
        console.error("suras.js missing or 'suras' not defined");
        return;
      }
      suras.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.number;
        const num = String(s.number).padStart(3,"0");
        opt.textContent = `${num} ‚Äî ${s.nameBn || s.name} (${s.nameAr || ''})`;
        suraSelect.appendChild(opt);
      });
    }

    // load chosen sura JSON
    async function loadSura(num) {
      if (!num) return;
      const meta = suras.find(x=> x.number === Number(num));
      if (!meta) return;
      currentSuraMeta = meta;
      try {
        const res = await fetch(meta.file + '?v=' + Date.now());
        if (!res.ok) throw new Error("JSON load failed");
        currentSura = await res.json();
        renderReader();
      } catch (e) {
        console.error(e);
        alert("‡¶∏‡ßÇ‡¶∞‡¶æ‡¶∞ JSON ‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: " + meta.file);
      }
    }

    function renderReader(){
      if (!currentSura) return;
      reader.style.display = "block";
      // header
      suraNameBn.textContent = currentSura.nameBn || currentSuraMeta.nameBn || "‡¶∏‡ßÇ‡¶∞‡¶æ " + currentSuraMeta.number;
      suraNameAr.textContent = currentSura.nameAr || currentSuraMeta.nameAr || "";
      topSuraNameBn.textContent = suraNameBn.textContent;
      topSuraNameAr.textContent = suraNameAr.textContent;
      currentSuraTitle.style.display = "flex";
      // meta
      suraMeta.textContent = `‡¶®‡¶Ç: ${currentSuraMeta.number} ¬∑ ‡¶Ü‡ßü‡¶æ‡¶§: ${currentSura.ayahs ? currentSura.ayahs.length : (currentSuraMeta.ayahCount||'?')}`;

      // bismillah
      bismillahBlock.innerHTML = "";
      if (currentSura.hasBismillah && currentSura.bismillah){
        const wrap = document.createElement("div");
        wrap.innerHTML = `<div class="bismillah-ar">${currentSura.bismillah.arabic||''}</div><div class="bismillah-bn small">${currentSura.bismillah.bangla||''}</div>`;
        bismillahBlock.appendChild(wrap);
      }

      // build ayahs
      ayahContainer.innerHTML = "";
      (currentSura.ayahs||[]).forEach(ayah=>{
        const a = document.createElement("div"); a.className='ayah';
        const header = document.createElement("div"); header.className='ayah-header';
        header.innerHTML = `<div class="ayah-num-pill">‡¶Ü‡ßü‡¶æ‡¶§ ${ayah.ayahNumber}</div><div></div>`;
        const ar = document.createElement("div"); ar.className='ayah-ar'; ar.textContent = ayah.arabic || '';
        const bn = document.createElement("div"); bn.className='ayah-bn';

        // choose translation text logic:
        let shownBangla = ayah.bangla || '';
        // if translator is selected and currentSura.translations exists, override shownBangla
        if (selectedTranslatorKey && currentSura.translations && currentSura.translations[selectedTranslatorKey]){
          const t = (currentSura.translations[selectedTranslatorKey].ayahs||[]).find(x=> x.ayahNumber === ayah.ayahNumber);
          if (t && t.text) shownBangla = t.text;
        }
        bn.textContent = shownBangla;

        a.appendChild(header);
        a.appendChild(ar);
        a.appendChild(bn);

        if (currentMode === 'wbw' && Array.isArray(ayah.words) && ayah.words.length){
          const wordsRow = document.createElement('div'); wordsRow.className='words-row';
          ayah.words.forEach(w=>{
            const pill = document.createElement('div'); pill.className='word-pill';
            pill.innerHTML = `<div class="word-ar">${w.text||''}</div><div class="word-bn">${w.meaningBn||''}</div>`;
            pill.addEventListener('click', ()=> {
              currentWord = w;
              showWordDetail(w);
            });
            wordsRow.appendChild(pill);
          });
          a.appendChild(wordsRow);
        }

        ayahContainer.appendChild(a);
      });

      // populate translatorSelect
      populateTranslatorSelect();

      // show home/back controls
      backToListTop.style.display = 'inline-flex';
    }

    function populateTranslatorSelect(){
      // clear options except default
      translatorSelect.innerHTML = '<option value="">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü</option>';
      if (currentSura && currentSura.translations){
        Object.keys(currentSura.translations).forEach(k=>{
          const t = currentSura.translations[k];
          const opt = document.createElement('option');
          opt.value = k;
          opt.textContent = (t.label || k);
          translatorSelect.appendChild(opt);
        });
      }
    }

    // word detail controls
    function showWordDetail(w){
      detailAr.textContent = w.text || '';
      detailBn.textContent = w.meaningBn || '';
      wordDetail.style.display = 'block';
    }
    function hideWordDetail(){ wordDetail.style.display = 'none'; currentWord = null; }

    openGrammar.addEventListener('click', ()=>{
      if (!currentWord || !currentWord.notes){ grammarBody.innerHTML = '<p>‡¶è‡¶á ‡¶∂‡¶¨‡ßç‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü ‡¶®‡ßá‡¶á‡•§</p>'; }
      else { grammarBody.innerHTML = '<pre style="white-space:pre-wrap">'+(currentWord.notes||'')+'</pre>'; }
      grammarModal.style.display = 'flex';
    });
    closeGrammarModal.addEventListener('click', ()=> grammarModal.style.display='none');
    closeWord.addEventListener('click', hideWordDetail);

    // settings open/close
    settingsOpen.addEventListener('click', ()=> settingsPane.style.display = 'block');
    closeSettings.addEventListener('click', ()=> settingsPane.style.display = 'none');

    // translator change
    translatorSelect.addEventListener('change', ()=>{
      selectedTranslatorKey = translatorSelect.value || '';
      renderReader(); // re-render ayah-bn overrides
    });

    // sizes
    function applyFontSizes(){
      const ar = arabicSize.value+'rem';
      const bn = banglaSize.value+'rem';
      const nt = noteSize.value+'rem';
      document.querySelectorAll('.ayah-ar').forEach(e=> e.style.fontSize = ar);
      document.querySelectorAll('.ayah-bn').forEach(e=> e.style.fontSize = bn);
      document.querySelectorAll('.word-ar, .word-main-ar').forEach(e=> e.style.fontSize = ar);
      document.querySelectorAll('.word-bn, .word-main-bn').forEach(e=> e.style.fontSize = bn);
      document.querySelectorAll('.modal-card, .small').forEach(e=> e.style.fontSize = nt);
      arabicSizeShow.textContent = ar; banglaSizeShow.textContent = bn; noteSizeShow.textContent = nt;
    }
    arabicSize.addEventListener('input', applyFontSizes);
    banglaSize.addEventListener('input', applyFontSizes);
    noteSize.addEventListener('input', applyFontSizes);

    // mode toggle
    modeToggleHeader.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-mode');
      if (!btn) return;
      document.querySelectorAll('.btn-mode').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      currentMode = btn.getAttribute('data-mode') || 'telawat';
      renderReader();
      if (currentMode === 'telawat') hideWordDetail();
    });

    // home button/back
    btnHome.addEventListener('click', ()=> {
      // go back to top selection
      reader.style.display = 'none';
      suraSelect.value = '';
      currentSura = null;
      currentSuraMeta = null;
      currentSuraTitle.style.display = 'none';
      hideWordDetail();
      window.scrollTo({top:0,behavior:'smooth'});
    });
    backToListTop.addEventListener('click', ()=> btnHome.click());

    // when select sura
    suraSelect.addEventListener('change', ()=> {
      const v = suraSelect.value;
      if (!v) return;
      loadSura(v);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    // initial population
    document.addEventListener('DOMContentLoaded', ()=>{
      populateSuras();
      applyFontSizes();
    });

  </script>
</body>
</html>
