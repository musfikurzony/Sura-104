<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Qur'an Reader ‚Äì Ayaat Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Basic CSS ‚Äì modern, card-based, responsive -->
  <style>
    :root {
      --bg-main: #f3f4f6;
      --bg-card: #ffffff;
      --bg-soft: #e5e7eb;
      --primary: #10b981;
      --primary-soft: #d1fae5;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border-soft: #e5e7eb;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.07);
      --radius-lg: 16px;
      --radius-xl: 22px;
      --transition-fast: 0.2s ease-in-out;
    }

    [data-theme="dark"] {
      --bg-main: #020617;
      --bg-card: #0b1120;
      --bg-soft: #111827;
      --primary: #22c55e;
      --primary-soft: #052e16;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: #1f2937;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.7);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Top bar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.7rem 1rem;
      background: var(--bg-card);
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      font-size: 1rem;
    }

    .app-title span.logo-circle {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: var(--primary-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: var(--primary);
      font-weight: 800;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .btn, .chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card);
      padding: 0.3rem 0.7rem;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .btn-primary {
      background: var(--primary);
      color: #ecfdf5;
      border-color: transparent;
    }

    .btn-icon {
      padding: 0.35rem 0.45rem;
      border-radius: 999px;
      min-width: 28px;
      justify-content: center;
    }

    .btn-ghost {
      background: transparent;
    }

    .btn-small {
      padding: 0.25rem 0.55rem;
      font-size: 0.7rem;
    }

    .chip {
      background: var(--bg-soft);
      color: var(--text-muted);
      border: none;
    }

    .chip.active {
      background: var(--primary-soft);
      color: var(--primary);
    }

    /* Layout */
    .main-layout {
      flex: 1;
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    /* Sidebar: Sura list */
    .sidebar {
      width: 280px;
      max-width: 100%;
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 0.75rem;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      height: calc(100vh - 70px - 1.5rem);
      position: sticky;
      top: 70px;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.3rem;
    }

    .sidebar-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .search-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 0.35rem 0.85rem;
      font-size: 0.75rem;
      background: var(--bg-main);
      color: var(--text-main);
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-soft);
      background: var(--bg-card);
    }

    .sura-list {
      margin-top: 0.3rem;
      overflow-y: auto;
      padding-right: 0.3rem;
    }

    .sura-item {
      border-radius: 999px;
      padding: 0.4rem 0.6rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.2rem;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast);
      font-size: 0.75rem;
    }

    .sura-item:hover {
      background: var(--bg-soft);
      transform: translateY(-1px);
    }

    .sura-item.active {
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
    }

    .sura-meta {
      display: flex;
      flex-direction: column;
    }

    .sura-name-en {
      font-weight: 600;
    }

    .sura-name-ar {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-align: right;
    }

    .badge {
      border-radius: 999px;
      background: var(--bg-soft);
      padding: 0.15rem 0.4rem;
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    /* Content area */
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
      min-width: 0;
    }

    .content-header {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 0.7rem 0.8rem;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .content-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .sura-heading {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .sura-heading-main {
      font-size: 1rem;
      font-weight: 700;
    }

    .sura-heading-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .tabs {
      display: inline-flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.1rem;
    }

    .tab {
      border-radius: 999px;
      background: var(--bg-soft);
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .tab.active {
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
      transform: translateY(-1px);
    }

    .content-toolbar {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .font-size-toggle {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
    }

    .font-size-toggle button {
      border: none;
      background: transparent;
      padding: 0.2rem 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: background var(--transition-fast), color var(--transition-fast);
    }

    .font-size-toggle button.active {
      background: var(--primary-soft);
      color: var(--primary);
    }

    /* Ayat list */
    .ayat-container {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 0.6rem 0.7rem;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      max-height: calc(100vh - 70px - 2.5rem);
      overflow-y: auto;
    }

    .ayat-item {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 0.55rem 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      position: relative;
      transition: box-shadow var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast), background var(--transition-fast);
    }

    .ayat-item:hover {
      box-shadow: var(--shadow-soft);
      border-color: var(--primary-soft);
      transform: translateY(-1px);
      background: rgba(16, 185, 129, 0.03);
    }

    .ayat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    .ayat-num-badge {
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      padding: 0.1rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .ayat-last-read {
      font-size: 0.65rem;
      color: var(--primary);
    }

    .ayat-checkbox {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .ayat-checkbox input {
      transform: scale(1.1);
    }

    .ayat-arabic {
      font-family: "Scheherazade New", "Amiri", "Traditional Arabic", system-ui;
      direction: rtl;
      font-size: 1.1rem;
      line-height: 1.8;
      text-align: right;
    }

    .font-size-sm .ayat-arabic {
      font-size: 0.95rem;
    }

    .font-size-lg .ayat-arabic {
      font-size: 1.35rem;
    }

    .ayat-translation {
      font-size: 0.8rem;
      color: var(--text-main);
      line-height: 1.5;
    }

    .font-size-sm .ayat-translation {
      font-size: 0.75rem;
    }

    .font-size-lg .ayat-translation {
      font-size: 0.9rem;
    }

    .ayat-actions {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin-top: 0.1rem;
    }

    .ayat-actions button {
      font-size: 0.7rem;
      padding: 0.2rem 0.45rem;
      border-radius: 999px;
    }

    .ayat-actions button span.icon {
      font-size: 0.8rem;
    }

    /* Selection toolbar */
    .selection-toolbar {
      position: sticky;
      bottom: 0.4rem;
      align-self: flex-end;
      margin-top: auto;
      z-index: 10;
    }

    .selection-toolbar-inner {
      background: var(--bg-card);
      border-radius: 999px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
      padding: 0.35rem 0.6rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      border: 1px solid var(--border-soft);
    }

    .selection-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-right: 0.2rem;
    }

    .selection-toolbar-inner button {
      font-size: 0.75rem;
      padding: 0.25rem 0.6rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: static;
      }
      .content-area {
        max-height: none;
      }
      .ayat-container {
        max-height: none;
      }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.4rem;
      }
    }

    @media (max-width: 500px) {
      .content-header {
        padding: 0.6rem;
      }
      .ayat-item {
        padding: 0.45rem 0.5rem;
      }
    }
  </style>
</head>
<body data-theme="light">
<div class="app-shell">

  <!-- Top bar -->
  <header class="topbar">
    <div class="app-title">
      <span class="logo-circle">Q</span>
      <div>
        Qur'an Reader
        <div style="font-size: 0.68rem; color: var(--text-muted);">
          Ayaat tools ¬∑ Pins ¬∑ Favourites ¬∑ Last Read
        </div>
      </div>
    </div>

    <div class="topbar-right">
      <button id="themeToggleBtn" class="btn btn-ghost btn-icon" title="Toggle light/dark">
        üåó
      </button>
      <button id="languageToggleBtn" class="btn btn-ghost btn-small" title="Toggle translation language">
        üåê BN / EN
      </button>
      <div class="font-size-toggle" id="fontSizeToggle">
        <button data-size="sm">A-</button>
        <button data-size="md" class="active">A</button>
        <button data-size="lg">A+</button>
      </div>
    </div>
  </header>

  <main class="main-layout">
    <!-- Sidebar: Sura list -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Sura List</div>
        <span class="badge" id="totalSuraBadge">-- Suras</span>
      </div>
      <input
        id="suraSearchInput"
        class="search-input"
        placeholder="Search by name or number..."
      />
      <div class="sura-list" id="suraList"></div>
    </aside>

    <!-- Main content area -->
    <section class="content-area">
      <div class="content-header">
        <div class="content-header-top">
          <div class="sura-heading">
            <div class="sura-heading-main" id="currentSuraTitle">Select a Sura</div>
            <div class="sura-heading-sub" id="currentSuraMeta">
              Choose a sura from the left panel to begin reading.
            </div>
          </div>

          <div class="content-toolbar">
            <button class="btn btn-small btn-ghost" id="scrollLastReadBtn" title="Go to last read ayaat">
              ‚è± Last Read
            </button>
          </div>
        </div>

        <div class="tabs" id="viewTabs">
          <div class="tab active" data-view="all">All Ayaat</div>
          <div class="tab" data-view="pins">üìå Pins</div>
          <div class="tab" data-view="favourites">‚≠ê Favourites</div>
          <div class="tab" data-view="last">‚è± Last Read</div>
        </div>
      </div>

      <div class="ayat-container font-size-md" id="ayatContainer">
        <!-- Ayaat will be rendered here -->
      </div>

      <div class="selection-toolbar" id="selectionToolbar" style="display:none;">
        <div class="selection-toolbar-inner">
          <div class="selection-count" id="selectionCount">0 selected</div>
          <button class="btn btn-small" id="btnSelectionCopy">üìã Copy</button>
          <button class="btn btn-small" id="btnSelectionShare">üîó Share</button>
          <button class="btn btn-small btn-ghost" id="btnSelectionClear">‚úñ Clear</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- suras.js must define window.suras -->
<script src="suras.js"></script>

<script>
  // ---- State ----
  const state = {
    suras: [],
    currentSuraId: null,
    currentView: "all", // all | pins | favourites | last
    fontSize: "md",
    theme: "light",
    translationLanguage: "bn", // 'bn' or 'en'
    selectedAyaat: new Set(), // keys: suraId:ayaNo
    pins: new Set(),
    favourites: new Set(),
    lastRead: null, // { suraId, ayaNo }
  };

  // ---- Local Storage Helpers ----
  const STORAGE_KEYS = {
    pins: "quran_pins",
    favourites: "quran_favourites",
    lastRead: "quran_last_read",
    settings: "quran_reader_settings_v1",
  };

  function loadLocalStorage() {
    try {
      const pins = JSON.parse(localStorage.getItem(STORAGE_KEYS.pins) || "[]");
      state.pins = new Set(pins);

      const fav = JSON.parse(localStorage.getItem(STORAGE_KEYS.favourites) || "[]");
      state.favourites = new Set(fav);

      const last = JSON.parse(localStorage.getItem(STORAGE_KEYS.lastRead) || "null");
      state.lastRead = last;

      const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.settings) || "null");
      if (settings) {
        if (settings.fontSize) state.fontSize = settings.fontSize;
        if (settings.theme) state.theme = settings.theme;
        if (settings.translationLanguage) state.translationLanguage = settings.translationLanguage;
      }
    } catch (e) {
      console.warn("Error loading localStorage:", e);
    }
  }

  function saveLocalStorage() {
    localStorage.setItem(STORAGE_KEYS.pins, JSON.stringify(Array.from(state.pins)));
    localStorage.setItem(STORAGE_KEYS.favourites, JSON.stringify(Array.from(state.favourites)));
    localStorage.setItem(STORAGE_KEYS.lastRead, JSON.stringify(state.lastRead));
    localStorage.setItem(
      STORAGE_KEYS.settings,
      JSON.stringify({
        fontSize: state.fontSize,
        theme: state.theme,
        translationLanguage: state.translationLanguage,
      })
    );
  }

  // ---- DOM refs ----
  const bodyEl = document.body;
  const suraListEl = document.getElementById("suraList");
  const suraSearchInput = document.getElementById("suraSearchInput");
  const totalSuraBadge = document.getElementById("totalSuraBadge");

  const currentSuraTitleEl = document.getElementById("currentSuraTitle");
  const currentSuraMetaEl = document.getElementById("currentSuraMeta");
  const ayatContainerEl = document.getElementById("ayatContainer");

  const selectionToolbarEl = document.getElementById("selectionToolbar");
  const selectionCountEl = document.getElementById("selectionCount");
  const btnSelectionCopy = document.getElementById("btnSelectionCopy");
  const btnSelectionShare = document.getElementById("btnSelectionShare");
  const btnSelectionClear = document.getElementById("btnSelectionClear");
  const scrollLastReadBtn = document.getElementById("scrollLastReadBtn");

  const themeToggleBtn = document.getElementById("themeToggleBtn");
  const languageToggleBtn = document.getElementById("languageToggleBtn");
  const fontSizeToggleEl = document.getElementById("fontSizeToggle");
  const viewTabsEl = document.getElementById("viewTabs");

  // ---- Init ----
  function init() {
    loadLocalStorage();

    // Load suras from global variable
    if (Array.isArray(window.suras)) {
      state.suras = window.suras;
    } else {
      console.error("suras.js did not define window.suras as an array");
      state.suras = [];
    }

    // Display sura count
    totalSuraBadge.textContent = state.suras.length + " Suras";

    // Apply theme & font size
    applyTheme();
    applyFontSize();

    // Render sura list
    renderSuraList();

    // Event bindings
    bindEvents();

    // If there is a lastRead, pre-select that sura
    if (state.lastRead && state.lastRead.suraId != null) {
      selectSura(state.lastRead.suraId);
      setActiveViewTab("last");
    }
  }

  // ---- Rendering ----

  function renderSuraList(filterText = "") {
    suraListEl.innerHTML = "";

    const normalizedFilter = filterText.trim().toLowerCase();

    state.suras.forEach((sura, index) => {
      const suraId = sura.id ?? (index + 1); // fallback if no id field

      const nameEn = sura.name || ("Sura " + suraId);
      const nameAr = sura.arabicName || "";
      const ayaCount = Array.isArray(sura.ayaat || sura.ayahs)
        ? (sura.ayaat || sura.ayahs).length
        : (sura.ayahCount || "");

      const searchSource = (suraId + " " + nameEn + " " + nameAr).toLowerCase();
      if (normalizedFilter && !searchSource.includes(normalizedFilter)) {
        return;
      }

      const item = document.createElement("div");
      item.className = "sura-item";
      if (state.currentSuraId === suraId) {
        item.classList.add("active");
      }

      item.dataset.suraId = suraId;

      const metaDiv = document.createElement("div");
      metaDiv.className = "sura-meta";

      const nameEnSpan = document.createElement("div");
      nameEnSpan.className = "sura-name-en";
      nameEnSpan.textContent = suraId + ". " + nameEn;

      const nameArSpan = document.createElement("div");
      nameArSpan.className = "sura-name-ar";
      nameArSpan.textContent = nameAr;

      metaDiv.appendChild(nameEnSpan);
      metaDiv.appendChild(nameArSpan);

      const right = document.createElement("div");
      right.className = "sura-meta-right";
      const ayaBadge = document.createElement("span");
      ayaBadge.className = "badge";
      ayaBadge.textContent = ayaCount ? (ayaCount + " Ayat") : "";
      right.appendChild(ayaBadge);

      item.appendChild(metaDiv);
      item.appendChild(right);

      item.addEventListener("click", () => {
        selectSura(suraId);
      });

      suraListEl.appendChild(item);
    });
  }

  function selectSura(suraId) {
    state.currentSuraId = suraId;
    state.selectedAyaat.clear();

    // Update active in list
    Array.from(suraListEl.querySelectorAll(".sura-item")).forEach((el) => {
      el.classList.toggle("active", Number(el.dataset.suraId) === Number(suraId));
    });

    // Update header
    const sura = state.suras.find(s => (s.id ?? null) === suraId) ||
                 state.suras[suraId - 1] ||
                 null;

    if (!sura) {
      currentSuraTitleEl.textContent = "Sura " + suraId;
      currentSuraMetaEl.textContent = "";
      ayatContainerEl.innerHTML = "<p>Unable to load this sura.</p>";
      updateSelectionToolbar();
      return;
    }

    const ayaCount = Array.isArray(sura.ayaat || sura.ayahs)
      ? (sura.ayaat || sura.ayahs).length
      : (sura.ayahCount || "");

    currentSuraTitleEl.textContent = (sura.name || ("Sura " + suraId)) + " ¬∑ " + (sura.arabicName || "");
    currentSuraMetaEl.textContent = "Sura " + suraId + " ¬∑ " + ayaCount + " Ayaat";

    // Keep current view (all/pins/favourites/last) when switching sura
    renderAyaat();

    // If current view is "last" and lastRead belongs to this sura, scroll to that aya
    if (state.currentView === "last" && state.lastRead && Number(state.lastRead.suraId) === Number(suraId)) {
      setTimeout(scrollToLastRead, 200);
    }
  }

  function renderAyaat() {
    ayatContainerEl.innerHTML = "";

    if (!state.currentSuraId) {
      ayatContainerEl.innerHTML = "<p>Please select a sura from the left list.</p>";
      updateSelectionToolbar();
      return;
    }

    const suraIndex = (state.suras.findIndex(s => (s.id ?? null) === state.currentSuraId));
    const sura = (suraIndex >= 0) ? state.suras[suraIndex] : state.suras[state.currentSuraId - 1];

    if (!sura) {
      ayatContainerEl.innerHTML = "<p>Sura data not found.</p>";
      updateSelectionToolbar();
      return;
    }

    const ayaatArray = sura.ayaat || sura.ayahs || [];
    if (!Array.isArray(ayaatArray) || ayaatArray.length === 0) {
      ayatContainerEl.innerHTML = "<p>No ayaat found in suras.js for this sura.</p>";
      updateSelectionToolbar();
      return;
    }

    // Filter based on view
    let ayaFilter = ayaatArray;
    if (state.currentView === "pins") {
      ayaFilter = ayaatArray.filter(a => {
        const no = a.aayatNo || a.aya || a.no || a.index;
        const key = getAyaKey(state.currentSuraId, no);
        return state.pins.has(key);
      });
    } else if (state.currentView === "favourites") {
      ayaFilter = ayaatArray.filter(a => {
        const no = a.aayatNo || a.aya || a.no || a.index;
        const key = getAyaKey(state.currentSuraId, no);
        return state.favourites.has(key);
      });
    } else if (state.currentView === "last") {
      if (!state.lastRead || Number(state.lastRead.suraId) !== Number(state.currentSuraId)) {
        ayatContainerEl.innerHTML = "<p>No last read ayaat stored for this sura.</p>";
        updateSelectionToolbar();
        return;
      }
      ayaFilter = ayaatArray.filter(a => {
        const no = a.aayatNo || a.aya || a.no || a.index;
        return Number(no) === Number(state.lastRead.ayaNo);
      });
    }

    if (ayaFilter.length === 0) {
      ayatContainerEl.innerHTML = "<p>No ayaat to show for this view.</p>";
      updateSelectionToolbar();
      return;
    }

    ayaFilter.forEach((ayatObj) => {
      const no = ayatObj.aayatNo || ayatObj.aya || ayatObj.no || ayatObj.index;
      const arabic = ayatObj.arabic || ayatObj.ar || "";
      const bangla = ayatObj.bangla || ayatObj.bn || "";
      const english = ayatObj.english || ayatObj.en || "";
      const key = getAyaKey(state.currentSuraId, no);

      const isLastRead =
        state.lastRead &&
        Number(state.lastRead.suraId) === Number(state.currentSuraId) &&
        Number(state.lastRead.ayaNo) === Number(no);

      const item = document.createElement("div");
      item.className = "ayat-item";
      item.dataset.ayaKey = key;
      item.id = "aya-" + key.replace(":", "-");

      // Header row
      const header = document.createElement("div");
      header.className = "ayat-header";

      const leftHeader = document.createElement("div");
      leftHeader.style.display = "flex";
      leftHeader.style.alignItems = "center";
      leftHeader.style.gap = "0.3rem";

      const numBadge = document.createElement("span");
      numBadge.className = "ayat-num-badge";
      numBadge.innerHTML = `<span>#${no}</span>`;

      leftHeader.appendChild(numBadge);

      if (isLastRead) {
        const lr = document.createElement("span");
        lr.className = "ayat-last-read";
        lr.textContent = "Last read";
        leftHeader.appendChild(lr);
      }

      const rightHeader = document.createElement("label");
      rightHeader.className = "ayat-checkbox";
      rightHeader.innerHTML = `<input type="checkbox" /> Sel`;

      header.appendChild(leftHeader);
      header.appendChild(rightHeader);

      // Arabic
      const arabicDiv = document.createElement("div");
      arabicDiv.className = "ayat-arabic";
      arabicDiv.textContent = arabic || "";

      // Translation
      const transDiv = document.createElement("div");
      transDiv.className = "ayat-translation";
      transDiv.textContent = state.translationLanguage === "bn" ? (bangla || english) : (english || bangla);

      // Actions row
      const actions = document.createElement("div");
      actions.className = "ayat-actions";
      actions.innerHTML = `
        <button class="btn btn-small btn-ghost" data-action="pin"><span class="icon">üìå</span> Pin</button>
        <button class="btn btn-small btn-ghost" data-action="fav"><span class="icon">‚≠ê</span> Fav</button>
        <button class="btn btn-small btn-ghost" data-action="copy"><span class="icon">üìã</span> Copy</button>
        <button class="btn btn-small btn-ghost" data-action="share"><span class="icon">üîó</span> Share</button>
        <button class="btn btn-small btn-ghost" data-action="last"><span class="icon">‚è±</span> Last</button>
      `;

      // Attach
      item.appendChild(header);
      item.appendChild(arabicDiv);
      item.appendChild(transDiv);
      item.appendChild(actions);

      // Checkbox behaviour
      const checkbox = rightHeader.querySelector("input");
      checkbox.checked = state.selectedAyaat.has(key);
      checkbox.addEventListener("change", (e) => {
        if (e.target.checked) {
          state.selectedAyaat.add(key);
        } else {
          state.selectedAyaat.delete(key);
        }
        updateSelectionToolbar();
      });

      // Button handlers
      actions.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.dataset.action;
          handleAyaAction(action, key, {
            suraId: state.currentSuraId,
            ayaNo: no,
            arabic,
            bangla,
            english,
          });
        });
      });

      ayatContainerEl.appendChild(item);
    });

    updateSelectionToolbar();
  }

  function getAyaKey(suraId, ayaNo) {
    return String(suraId) + ":" + String(ayaNo);
  }

  // ---- Actions ----
  function handleAyaAction(action, key, payload) {
    switch (action) {
      case "pin":
        toggleSetEntry(state.pins, key);
        saveLocalStorage();
        renderAyaat(); // to update view if in pins tab
        break;
      case "fav":
        toggleSetEntry(state.favourites, key);
        saveLocalStorage();
        renderAyaat(); // to update view if in favourites tab
        break;
      case "copy":
        copyAyaText(payload);
        break;
      case "share":
        shareAyaText(payload);
        break;
      case "last":
        state.lastRead = { suraId: payload.suraId, ayaNo: payload.ayaNo };
        saveLocalStorage();
        renderAyaat();
        alert("Last read updated to Sura " + payload.suraId + ", Aya " + payload.ayaNo);
        break;
    }
  }

  function toggleSetEntry(setObj, value) {
    if (setObj.has(value)) {
      setObj.delete(value);
    } else {
      setObj.add(value);
    }
  }

  function composeAyatTextForCopy(payload) {
    const line1 = `Sura ${payload.suraId}, Aya ${payload.ayaNo}`;
    const line2 = payload.arabic || "";
    const trans = state.translationLanguage === "bn"
      ? (payload.bangla || payload.english || "")
      : (payload.english || payload.bangla || "");
    const line3 = trans;
    return [line1, line2, line3].filter(Boolean).join("\n");
  }

  function copyAyaText(payload) {
    const text = composeAyatTextForCopy(payload);
    navigator.clipboard.writeText(text).then(() => {
      alert("Ayat copied to clipboard.");
    }).catch(() => {
      alert("Unable to copy. Your browser blocked clipboard access.");
    });
  }

  function shareAyaText(payload) {
    const text = composeAyatTextForCopy(payload);
    if (navigator.share) {
      navigator.share({
        title: "Qur'an Ayaat",
        text,
      }).catch(() => {});
    } else {
      navigator.clipboard.writeText(text).then(() => {
        alert("Share not supported. Text copied. Paste it in WhatsApp, Messenger, etc.");
      });
    }
  }

  // ---- Multi-selection toolbar ----
  function updateSelectionToolbar() {
    const count = state.selectedAyaat.size;
    if (count === 0) {
      selectionToolbarEl.style.display = "none";
    } else {
      selectionToolbarEl.style.display = "block";
      selectionCountEl.textContent = count + " selected";
    }
  }

  function getSelectedAyatPayloads() {
    const result = [];
    state.selectedAyaat.forEach(key => {
      const [suraIdStr, ayaNoStr] = key.split(":");
      const suraId = Number(suraIdStr);
      const ayaNo = Number(ayaNoStr);

      const suraIndex = state.suras.findIndex(s => (s.id ?? null) === suraId);
      const sura = (suraIndex >= 0) ? state.suras[suraIndex] : state.suras[suraId - 1];
      if (!sura) return;

      const ayaArr = sura.ayaat || sura.ayahs || [];
      const ayaObj = ayaArr.find(a =>
        Number(a.aayatNo || a.aya || a.no || a.index) === ayaNo
      );
      if (!ayaObj) return;

      result.push({
        suraId,
        ayaNo,
        arabic: ayaObj.arabic || ayaObj.ar || "",
        bangla: ayaObj.bangla || ayaObj.bn || "",
        english: ayaObj.english || ayaObj.en || "",
      });
    });
    return result;
  }

  function copySelection() {
    const payloads = getSelectedAyatPayloads();
    if (payloads.length === 0) {
      alert("No ayaat selected.");
      return;
    }
    const combined = payloads.map(p => composeAyatTextForCopy(p)).join("\n\n");
    navigator.clipboard.writeText(combined).then(() => {
      alert("Selected ayaat copied to clipboard.");
    }).catch(() => {
      alert("Unable to copy selection.");
    });
  }

  function shareSelection() {
    const payloads = getSelectedAyatPayloads();
    if (payloads.length === 0) {
      alert("No ayaat selected.");
      return;
    }
    const combined = payloads.map(p => composeAyatTextForCopy(p)).join("\n\n");
    if (navigator.share) {
      navigator.share({
        title: "Qur'an Ayaat",
        text: combined,
      }).catch(() => {});
    } else {
      navigator.clipboard.writeText(combined).then(() => {
        alert("Share not supported. Text copied. Paste it in your app.");
      });
    }
  }

  function clearSelection() {
    state.selectedAyaat.clear();
    renderAyaat();
  }

  // ---- Theme, font size, language ----
  function applyTheme() {
    bodyEl.setAttribute("data-theme", state.theme);
  }

  function applyFontSize() {
    ayatContainerEl.classList.remove("font-size-sm", "font-size-md", "font-size-lg");
    ayatContainerEl.classList.add("font-size-" + state.fontSize);

    fontSizeToggleEl.querySelectorAll("button").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.size === state.fontSize);
    });
  }

  function toggleTheme() {
    state.theme = (state.theme === "light") ? "dark" : "light";
    applyTheme();
    saveLocalStorage();
  }

  function toggleLanguage() {
    state.translationLanguage = (state.translationLanguage === "bn") ? "en" : "bn";
    languageToggleBtn.textContent = state.translationLanguage === "bn" ? "üåê BN / EN" : "üåê EN / BN";
    saveLocalStorage();
    if (state.currentSuraId) {
      renderAyaat();
    }
  }

  // ---- View Tabs ----
  function setActiveViewTab(view) {
    state.currentView = view;
    viewTabsEl.querySelectorAll(".tab").forEach(tab => {
      tab.classList.toggle("active", tab.dataset.view === view);
    });
    if (state.currentSuraId) {
      renderAyaat();
      if (view === "last") {
        setTimeout(scrollToLastRead, 200);
      }
    }
  }

  function scrollToLastRead() {
    if (!state.lastRead) {
      alert("No last read ayaat stored yet.");
      return;
    }
    if (Number(state.lastRead.suraId) !== Number(state.currentSuraId)) {
      // Select that sura first
      selectSura(state.lastRead.suraId);
      setActiveViewTab("last");
      return;
    }

    const key = getAyaKey(state.lastRead.suraId, state.lastRead.ayaNo);
    const el = document.getElementById("aya-" + key.replace(":", "-"));
    if (el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
    } else {
      alert("Last read ayaat not found in the current view.");
    }
  }

  // ---- Events ----
  function bindEvents() {
    // Search sura
    suraSearchInput.addEventListener("input", (e) => {
      renderSuraList(e.target.value);
    });

    // Selection toolbar
    btnSelectionCopy.addEventListener("click", copySelection);
    btnSelectionShare.addEventListener("click", shareSelection);
    btnSelectionClear.addEventListener("click", clearSelection);

    scrollLastReadBtn.addEventListener("click", scrollToLastRead);

    // Theme & language
    themeToggleBtn.addEventListener("click", toggleTheme);
    languageToggleBtn.addEventListener("click", toggleLanguage);

    // Font size
    fontSizeToggleEl.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        state.fontSize = btn.dataset.size;
        applyFontSize();
        saveLocalStorage();
      });
    });

    // View tabs
    viewTabsEl.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        const view = tab.dataset.view;
        setActiveViewTab(view);
      });
    });
  }

  // ---- Start ----
  document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
