<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Qur'an ‚Ä¢ Word-by-Word ‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#05090f; --panel:#071026; --muted:#98a6b6; --text:#e6eef8;
      --accent:#22c55e; --gold:#f59e0b; --soft-border:rgba(148,163,184,0.18);
      --radius:12px; --shadow:0 12px 30px rgba(0,0,0,0.6);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans Bengali",sans-serif;background:var(--bg);color:var(--text)}
    button{font-family:inherit;cursor:pointer}
    a{color:inherit}
    /* layout */
    .app {
      max-width:1200px;margin:10px auto;padding:8px;display:grid;grid-template-columns:1fr;gap:10px;
    }
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:12px;
      background:linear-gradient(90deg,var(--panel),#041029);border:1px solid var(--soft-border);box-shadow:var(--shadow);
    }
    .left-controls{display:flex;align-items:center;gap:8px}
    .hamburger{font-size:20px;padding:6px;border-radius:10px;border:1px solid var(--soft-border);background:transparent}
    .title{font-weight:700;font-size:15px}
    .top-actions{display:flex;gap:6px;align-items:center}
    .btn{padding:6px 9px;border-radius:999px;border:1px solid var(--soft-border);background:transparent;color:var(--text)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#10b981);border:none;color:#042014;font-weight:700}
    /* container for main content and drawer */
    .layout{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:6px}
    @media(max-width:980px){.layout{grid-template-columns:1fr}}
    /* drawer (hidden by default, slides in) */
    .drawer {
      position:fixed;left:-340px;top:0;height:100vh;width:320px;padding:12px;background:var(--panel);z-index:120;
      box-shadow: 8px 0 30px rgba(0,0,0,0.6);transition:left .25s ease;border-right:1px solid var(--soft-border);
    }
    .drawer.open{left:6px}
    .drawer .close-x{float:right}
    .drawer h3{margin:4px 0 8px;font-size:14px}
    .drawer .sura-full-list{max-height:calc(100vh - 140px);overflow:auto;padding-right:6px}
    .sura-full-item{padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border);cursor:pointer}
    .sura-full-item:hover{box-shadow:0 8px 20px rgba(0,0,0,0.6);transform:translateY(-2px)}
    /* main header */
    .main-header{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px;border-radius:12px;background:linear-gradient(90deg,#061122,#031026);border:1px solid var(--soft-border)}
    .sura-title{font-size:18px;font-weight:700}
    .sura-sub{font-size:12px;color:var(--muted)}
    /* aya list card */
    .card{margin-top:8px;padding:10px;border-radius:12px;background:linear-gradient(180deg,#041025,#02101f);border:1px solid var(--soft-border);box-shadow:var(--shadow)}
    .aya-list{max-height:calc(100vh - 260px);overflow:auto;padding-right:6px}
    .aya-row{display:grid;grid-template-columns:36px 1fr 52px;gap:8px;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);align-items:start}
    @media(max-width:980px){.aya-row{grid-template-columns:28px 1fr;gap:8px}}
    .aya-check{display:flex;align-items:flex-start;justify-content:center;padding-top:4px}
    .aya-check input{width:16px;height:16px;accent-color:var(--accent)}
    .aya-text{overflow:hidden}
    .aya-meta{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .ayah-num{font-size:11px;padding:4px 6px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted)}
    .tags{font-size:11px;color:var(--gold)}
    .aya-ar{font-family:"Scheherazade New","Amiri",serif;text-align:right;direction:rtl;margin-bottom:6px}
    .word-token{display:inline-block;padding:2px 6px;margin:0 2px;border-radius:999px;cursor:pointer}
    .word-token:hover{background:rgba(34,197,94,0.08)}
    .aya-bn-block{margin-top:6px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--soft-border)}
    .aya-bn-label{font-size:11px;color:var(--muted);margin-bottom:4px}
    .aya-bn-text{font-size:13px;line-height:1.6}
    .aya-actions{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
    /* three-dot menu style */
    .dots-btn{background:transparent;border:none;color:var(--muted);font-size:18px;padding:4px;border-radius:6px}
    .mini-menu{position:absolute;right:10px;top:36px;min-width:160px;background:var(--panel);border:1px solid var(--soft-border);border-radius:8px;padding:6px;box-shadow:var(--shadow);display:none;z-index:140}
    .mini-menu.show{display:block}
    .mini-menu button{display:block;width:100%;text-align:left;padding:6px;border-radius:6px;background:transparent;border:none;color:var(--text);font-size:13px}
    .mini-menu button:hover{background:rgba(255,255,255,0.02)}
    /* word popup */
    .word-popup{position:fixed;z-index:200;min-width:220px;background:var(--panel);border:1px solid var(--soft-border);border-radius:10px;padding:8px;display:none}
    .word-popup .arabic{font-family:"Scheherazade New","Amiri",serif;text-align:right}
    .word-popup .meaning{margin-top:6px}
    .word-popup .notes{margin-top:6px;font-size:12px;color:var(--muted);max-height:140px;overflow:auto}
    /* last read compact */
    .last-read{margin-top:8px;padding:8px;border-radius:10px;background:linear-gradient(90deg,rgba(34,197,94,0.06),rgba(56,189,248,0.04));border:1px solid var(--soft-border);display:flex;align-items:center;justify-content:space-between;gap:8px}
    .last-read .info{font-size:13px}
    .last-read .actions{display:flex;gap:6px}
    /* multi bar */
    .multi-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:10px;background:linear-gradient(90deg,#021526,#04102a);border:1px solid var(--soft-border);padding:8px;border-radius:999px;display:none;gap:8px;z-index:210}
    .multi-bar.show{display:flex}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:300}
    .modal-backdrop.show{display:flex}
    .modal{background:var(--panel);border:1px solid var(--soft-border);border-radius:10px;max-width:900px;width:96%;max-height:90vh;overflow:auto;padding:10px}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="left-controls">
        <button id="hamburger" class="hamburger" title="‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ">‚â°</button>
        <div class="title">Qur'an ‚Ä¢ Word-by-Word</div>
      </div>
      <div class="top-actions">
        <button id="openSettings" class="btn">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
        <button id="openPins" class="btn">üìå ‡¶™‡¶ø‡¶®/‡¶´‡ßá‡¶≠‡¶æ‡¶∞‡¶ø‡¶ü</button>
        <button id="openCopy" class="btn primary">üìã ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø</button>
      </div>
    </div>

    <div class="layout">
      <!-- left column placeholder (kept for wide screens but drawer used) -->
      <div style="display:none"></div>

      <div>
        <div class="main-header card">
          <div>
            <div id="currentSuraTitle" class="sura-title">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            <div id="currentSuraSub" class="sura-sub">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ñ‡¶¨‡ßá</div>
          </div>
          <div>
            <div style="display:flex;gap:8px;align-items:center">
              <div id="viewButtons" style="display:flex;gap:6px">
                <button class="btn" data-view="both">‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
                <button class="btn" data-view="ar">‡¶Ü‡¶∞‡¶¨‡¶ø</button>
                <button class="btn" data-view="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
              </div>
              <button id="settingsQuick" class="btn">‚öôÔ∏è</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">‡¶Ü‡ßü‡¶æ‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
            <div id="ayaCount" style="color:var(--muted)"></div>
          </div>

          <div id="ayaList" class="aya-list"></div>
        </div>

        <div id="multiBar" class="multi-bar">
          <div id="multiCount" style="font-size:13px;color:var(--muted)">0 ‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</div>
          <button id="multiCopyBtn" class="btn">üìã ‡¶ï‡¶™‡¶ø</button>
          <button id="multiShareBtn" class="btn primary">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
          <button id="multiClearBtn" class="btn">‚úñ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DRAWER (sura list full single column) -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <button id="drawerClose" class="close-x btn">‚úï</button>
    <h3>‡¶∏‡ßÇ‡¶∞‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
    <input id="drawerSearch" placeholder="‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶æ‡¶Æ / ‡¶®‡¶Ç..." style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--soft-border);margin-bottom:8px;background:transparent;color:var(--text)" />
    <div id="drawerList" class="sura-full-list"></div>
  </div>

  <!-- WORD POPUP -->
  <div id="wordPopup" class="word-popup">
    <div class="arabic" id="wpArabic"></div>
    <div class="meaning" id="wpMeaning"></div>
    <div class="notes" id="wpNotes"></div>
    <div style="text-align:right;margin-top:6px"><button id="wpClose" class="btn">Close</button></div>
  </div>

  <!-- MODALS -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div id="modalWindow" class="modal"></div>
  </div>

  <!-- load suras -->
  <script src="suras.js"></script>

  <script>
  (function(){
    if(!window.suras || !Array.isArray(window.suras)){
      alert('suras.js ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø ‡¶¨‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
      return;
    }

    // storage helper
    const S = { get(k,def){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){} } };

    // state
    const STATE = {
      curSuraIndex:0,
      curSurahData:null,
      view:S.get('q_view','both'),
      showOsmani:S.get('q_showOsmani',true),
      showTawjih:S.get('q_showTawjih',true),
      fontArabic:S.get('q_fontArabic',20),
      fontBangla:S.get('q_fontBangla',13),
      fontOsmani:S.get('q_fontOsmani',12),
      fontTawjih:S.get('q_fontTawjih',12),
      lineHeight:S.get('q_lineHeight',1.6),
      pins:S.get('q_pins',[]),
      favs:S.get('q_favs',[]),
      lastRead:S.get('q_lastRead',null),
      selected:new Set()
    };

    // elements
    const drawer=document.getElementById('drawer');
    const hamburger=document.getElementById('hamburger');
    const drawerClose=document.getElementById('drawerClose');
    const drawerList=document.getElementById('drawerList');
    const drawerSearch=document.getElementById('drawerSearch');

    const currentSuraTitle=document.getElementById('currentSuraTitle');
    const currentSuraSub=document.getElementById('currentSuraSub');
    const ayaListEl=document.getElementById('ayaList');
    const ayaCountEl=document.getElementById('ayaCount');

    const wordPopup=document.getElementById('wordPopup');
    const wpArabic=document.getElementById('wpArabic');
    const wpMeaning=document.getElementById('wpMeaning');
    const wpNotes=document.getElementById('wpNotes');
    const wpClose=document.getElementById('wpClose');

    const modalBackdrop=document.getElementById('modalBackdrop');
    const modalWindow=document.getElementById('modalWindow');

    const multiBar=document.getElementById('multiBar');
    const multiCount=document.getElementById('multiCount');

    // open/close drawer
    hamburger.addEventListener('click',()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); });
    drawerClose.addEventListener('click',()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); });
    drawerSearch.addEventListener('input',()=>renderDrawerList(drawerSearch.value));

    // populate drawer list single column
    function renderDrawerList(filter=''){
      drawerList.innerHTML='';
      const ft=(filter||'').trim().toLowerCase();
      window.suras.forEach((s,idx)=>{
        const bn = s.nameBn || s.name_bn || s.name || '';
        const ar = s.nameAr || s.name_ar || '';
        const id = s.number || (idx+1);
        if(ft && !(bn.toLowerCase().includes(ft) || ar.toLowerCase().includes(ft) || String(id)===ft)) return;
        const div=document.createElement('div');
        div.className='sura-full-item';
        div.innerHTML = '<div style="font-weight:700">'+id+'. '+bn+'</div><div style="font-size:12px;color:var(--muted)">'+ar+' ‚Ä¢ '+(s.ayahCount|| (s.ayahs?s.ayahs.length:'?'))+' ‡¶Ü‡ßü‡¶æ‡¶§</div>';
        div.addEventListener('click',()=>{ setCurrentSura(idx); drawer.classList.remove('open'); });
        drawerList.appendChild(div);
      });
    }

    // initial drawer list
    renderDrawerList();

    // set current sura (load JSON if file provided)
    async function setCurrentSura(idx){
      STATE.curSuraIndex = idx;
      const meta = window.suras[idx] || {};
      currentSuraTitle.textContent = (meta.number||idx+1)+'. '+(meta.nameBn||meta.name||'');
      currentSuraSub.textContent = (meta.nameAr||'') + ' ‚Ä¢ ' + (meta.revelationPlace||meta.type||'') + ' ‚Ä¢ ' + ((meta.ayahCount)||(meta.ayahs?meta.ayahs.length:'?')) + ' ‡¶Ü‡ßü‡¶æ‡¶§';

      // load surah JSON if file property exists
      STATE.curSurahData = null;
      if(meta.file){
        try{
          const res = await fetch(meta.file);
          if(!res.ok) throw new Error('fetch failed');
          STATE.curSurahData = await res.json();
        }catch(e){
          console.error('Failed loading surah file',e);
          STATE.curSurahData = meta; // fallback
        }
      } else {
        STATE.curSurahData = meta;
      }

      // reset selection
      STATE.selected.clear();
      renderAyaList();
      renderMultiBar();
    }

    // utility: ayah key
    function keyOf(s,a){ return `${s}:${a}`; }
    function findIndexByKey(arr,key){ return arr.findIndex(x=>x.key===key); }

    // detect translations in ayah robustly, returns { osmani: '', tawjih: '', mainBangla: '' }
    function extractTranslationsFromAyah(ayah){
      // main bangla text
      const main = ayah.bangla || ayah.bn || ayah.bangla_main || ayah.main_bn || ayah.translation || ayah.text_bn || ayah.meaning || '';
      // translations object maybe present
      let os = '';
      let tw = '';
      if(ayah.translations && typeof ayah.translations === 'object'){
        os = ayah.translations.osmani || ayah.translations.osman || ayah.translations.osmn || '';
        tw = ayah.translations.tawjih || ayah.translations.tawzeeh || ayah.translations.tawjih || ayah.translations.tawjihul || ayah.translations.tawjih || ayah.translations.tawjih || '';
      }
      // also check common alternative keys
      os = os || ayah.bangla_osmani || ayah.bn_osmani || ayah.osmani || ayah.tafseer_osmani || '';
      tw = tw || ayah.bangla_tawzeeh || ayah.bn_tawzeeh || ayah.tawzeeh || ayah.taozeeh || '';
      return { main, os, tw };
    }

    // render aya list
    function renderAyaList(){
      ayaListEl.innerHTML = '';
      const data = STATE.curSurahData || {};
      const ayas = Array.isArray(data.ayahs)? data.ayahs : (data.ayas||[]);
      ayaCountEl.textContent = (ayas.length || 0) + ' ‡¶Ü‡ßü‡¶æ‡¶§';

      ayas.forEach((ayah, idx) => {
        const row = document.createElement('div');
        row.className = 'aya-row';
        row.id = `aya-${STATE.curSuraIndex}-${idx}`;

        // checkbox
        const chkCol = document.createElement('div'); chkCol.className='aya-check';
        const cb = document.createElement('input'); cb.type='checkbox';
        const k = keyOf(STATE.curSuraIndex, idx);
        cb.checked = STATE.selected.has(k);
        cb.addEventListener('change', ()=>{ if(cb.checked) STATE.selected.add(k); else STATE.selected.delete(k); renderMultiBar(); });
        chkCol.appendChild(cb);

        // text column
        const textCol = document.createElement('div'); textCol.className='aya-text';
        const metaRow = document.createElement('div'); metaRow.className='aya-meta';
        const num = document.createElement('div'); num.className='ayah-num'; num.textContent = (STATE.curSuraIndex+1)+':'+(idx+1);
        const tags = document.createElement('div'); tags.className='tags';
        if(findIndexByKey(STATE.pins, k) !== -1) tags.textContent += 'üìå ';
        if(findIndexByKey(STATE.favs, k) !== -1) tags.textContent += '‚≠ê';
        metaRow.appendChild(num); metaRow.appendChild(tags);
        textCol.appendChild(metaRow);

        // Arabic line (word tokens if present)
        const arDiv = document.createElement('div'); arDiv.className='aya-ar';
        arDiv.style.fontSize = STATE.fontArabic + 'px';
        arDiv.style.lineHeight = STATE.lineHeight;
        if(Array.isArray(ayah.words) && ayah.words.length){
          ayah.words.forEach(w=>{
            const span = document.createElement('span');
            span.className = 'word-token';
            span.textContent = w.text || w.word || '';
            // store meaning/notes on dataset
            span.dataset.meaning = w.meaningBn || w.meaning || w.meaning_bn || w.meaning_en || '';
            span.dataset.notes = w.notes || w.note || w.grammar || ayah.grammar || '';
            span.addEventListener('click', (ev)=> openWordPopup(ev.currentTarget, ayah));
            span.style.fontSize = STATE.fontArabic + 'px';
            arDiv.appendChild(span);
          });
        } else {
          arDiv.textContent = ayah.arabic || ayah.ar || ayah.text_ar || '';
        }
        if(STATE.view === 'bn') arDiv.style.display = 'none';
        textCol.appendChild(arDiv);

        // Bangla blocks: main, osmani, tawjih, grammar
        if(STATE.view !== 'ar'){
          const blocks = extractTranslationsFromAyah(ayah);
          if(blocks.main){
            const mainDiv = document.createElement('div');
            mainDiv.className = 'aya-bn-block';
            mainDiv.style.fontSize = STATE.fontBangla + 'px';
            mainDiv.innerHTML = '<div class="aya-bn-text">'+escapeHtml(blocks.main)+'</div>';
            textCol.appendChild(mainDiv);
          }
          if(blocks.os && STATE.showOsmani){
            const b = document.createElement('div'); b.className='aya-bn-block';
            b.innerHTML = '<div class="aya-bn-label">‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ</div><div class="aya-bn-text" style="font-size:'+STATE.fontOsmani+'px">'+escapeHtml(blocks.os)+'</div>';
            textCol.appendChild(b);
          }
          if(blocks.tw && STATE.showTawjih){
            const b = document.createElement('div'); b.className='aya-bn-block';
            b.innerHTML = '<div class="aya-bn-label">‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®</div><div class="aya-bn-text" style="font-size:'+STATE.fontTawjih+'px">'+escapeHtml(blocks.tw)+'</div>';
            textCol.appendChild(b);
          }
          // grammar (if present at ayah level)
          const g = ayah.grammar || ayah.grammarNotes || ayah.notes || '';
          if(g){
            const b = document.createElement('div'); b.className='aya-bn-block';
            b.innerHTML = '<div class="aya-bn-label">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü</div><div class="aya-bn-text" style="font-size:'+STATE.fontTawjih+'px">'+escapeHtml(g)+'</div>';
            textCol.appendChild(b);
          }
        }

        // actions column with three-dot menu
        const actCol = document.createElement('div'); actCol.className='aya-actions';
        // three-dot button
        const dotsWrap = document.createElement('div'); dotsWrap.style.position='relative';
        const dotsBtn = document.createElement('button'); dotsBtn.className='dots-btn'; dotsBtn.innerHTML = '‚ãØ';
        const miniMenu = document.createElement('div'); miniMenu.className='mini-menu';
        // menu items: pin, fav, copy, share, set last
        const miPin = document.createElement('button'); miPin.textContent = (findIndexByKey(STATE.pins,k)!==-1?'Unpin üìç':'Pin üìå');
        const miFav = document.createElement('button'); miFav.textContent = (findIndexByKey(STATE.favs,k)!==-1?'Unfav ‚òÜ':'Favourite ‚≠ê');
        const miCopy = document.createElement('button'); miCopy.textContent = 'Copy üìã';
        const miShare = document.createElement('button'); miShare.textContent = 'Share üîó';
        const miLast = document.createElement('button'); miLast.textContent = 'Set as Last Read ‚è±';
        miniMenu.appendChild(miPin); miniMenu.appendChild(miFav); miniMenu.appendChild(miCopy); miniMenu.appendChild(miShare); miniMenu.appendChild(miLast);
        // hook actions
        miPin.addEventListener('click',()=>{ togglePin(k,STATE.curSuraIndex,idx); miniMenu.classList.remove('show'); renderAyaList(); renderMiniPins(); });
        miFav.addEventListener('click',()=>{ toggleFav(k,STATE.curSuraIndex,idx); miniMenu.classList.remove('show'); renderAyaList(); renderMiniPins(); });
        miCopy.addEventListener('click',()=>{ navigator.clipboard.writeText(formatAyaForCopy(STATE.curSuraIndex,idx,'both')).then(()=>alert('Copied')) ; miniMenu.classList.remove('show'); });
        miShare.addEventListener('click',()=>{ doShare(formatAyaForCopy(STATE.curSuraIndex,idx,'both')); miniMenu.classList.remove('show'); });
        miLast.addEventListener('click',()=>{ STATE.lastRead={surahIndex:STATE.curSuraIndex,ayaIndex:idx,time:Date.now()}; S.set('q_lastRead',STATE.lastRead); renderLastRead(); miniMenu.classList.remove('show'); alert('Last read set'); });

        dotsBtn.addEventListener('click',(e)=>{ e.stopPropagation(); document.querySelectorAll('.mini-menu').forEach(m=>m.classList.remove('show')); miniMenu.classList.toggle('show'); });

        // close mini-menus on outside click
        document.addEventListener('click',()=>{ document.querySelectorAll('.mini-menu').forEach(m=>m.classList.remove('show')); });

        dotsWrap.appendChild(dotsBtn); dotsWrap.appendChild(miniMenu);
        actCol.appendChild(dotsWrap);

        // append columns to row
        row.appendChild(chkCol); row.appendChild(textCol); row.appendChild(actCol);
        ayaListEl.appendChild(row);
      });

      renderLastRead();
      renderMiniPins();
      renderMultiBar();
    }

    // format functions
    function formatAyaForCopy(sIdx,aIdx,mode){
      const sura = window.suras[sIdx] || {};
      const data = (STATE.curSurahData && (STATE.curSuraIndex===sIdx)) ? (STATE.curSurahData.ayahs||STATE.curSurahData.ayas||[]) : (sura.ayahs||sura.ayas||[]);
      const aya = (data[aIdx]||{});
      const ar = aya.arabic || aya.ar || aya.text_ar || '';
      const blocks = extractTranslationsFromAyah(aya);
      const bn = blocks.main || '';
      const head = '['+(sura.nameBn||sura.name||'')+' '+(sIdx+1)+':'+(aIdx+1)+']';
      if(mode==='ar') return ar + '\n' + head;
      if(mode==='bn') return bn + '\n' + head;
      return (ar ? ar + '\n' : '') + (bn ? bn + '\n' : '') + head;
    }
    function formatMultipleSelection(mode){
      return Array.from(STATE.selected).map(k=>{
        const [s,a] = k.split(':').map(Number);
        return formatAyaForCopy(s,a,mode);
      }).join('\n\n');
    }

    // sharing/copy
    function doShare(text){
      if(navigator.share) navigator.share({text}).catch(()=>{ navigator.clipboard.writeText(text).then(()=>alert('Copied to clipboard')); });
      else navigator.clipboard.writeText(text).then(()=>alert('Copied to clipboard'));
    }

    // pin/fav toggles
    function togglePin(key,sIdx,aIdx){
      const i = findIndexByKey(STATE.pins,key);
      if(i>=0) STATE.pins.splice(i,1);
      else STATE.pins.unshift({key,surahIndex:sIdx,ayahIndex:aIdx,note:'',time:Date.now()});
      S.set('q_pins',STATE.pins);
    }
    function toggleFav(key,sIdx,aIdx){
      const i = findIndexByKey(STATE.favs,key);
      if(i>=0) STATE.favs.splice(i,1);
      else STATE.favs.unshift({key,surahIndex:sIdx,ayahIndex:aIdx,note:'',time:Date.now()});
      S.set('q_favs',STATE.favs);
    }

    // render mini pins list (top-right small list or side)
    function renderMiniPins(){
      // simple quick list in console or could add to UI ‚Äî for now update drawer header count
      // (we will show in pins modal)
    }

    // Last read render (compact)
    function renderLastRead(){
      // find or update a compact element above aya list ‚Äî implementing minimal in-page small banner
      // We'll put a small banner at top of aya list if lastRead exists
      const existing = document.querySelector('.last-read');
      if(existing) existing.remove();
      if(!STATE.lastRead) return;
      const lr = STATE.lastRead;
      const sura = window.suras[lr.surahIndex] || {};
      const el = document.createElement('div'); el.className='last-read';
      el.innerHTML = '<div class="info"><strong>‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ:</strong> '+ (sura.nameBn||sura.name||'') +' ‚Äî '+ (lr.surahIndex+1)+':'+(lr.ayaIndex+1) +'</div><div class="actions"><button id="goLastBtn" class="btn primary">‚è± Continue</button><button id="clearLastBtn" class="btn">Reset</button></div>';
      const parentCard = document.querySelector('.card');
      if(parentCard) parentCard.parentNode.insertBefore(el, parentCard);
      document.getElementById('goLastBtn').addEventListener('click', ()=>{
        setCurrentSura(lr.surahIndex);
        setTimeout(()=>{ const node = document.getElementById('aya-'+lr.surahIndex+'-'+lr.ayaIndex); if(node) node.scrollIntoView({behavior:'smooth',block:'center'}); },150);
      });
      document.getElementById('clearLastBtn').addEventListener('click', ()=>{
        STATE.lastRead = null; S.set('q_lastRead',null); el.remove();
      });
    }

    // multiBar handling
    function renderMultiBar(){
      const c = STATE.selected.size;
      if(c>0){ multiCount.textContent = c + ' ‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®'; multiBar.classList.add('show'); }
      else multiBar.classList.remove('show');
    }
    document.getElementById('multiCopyBtn').addEventListener('click', ()=> {
      if(STATE.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø');
      const txt = formatMultipleSelection('both');
      openCopyModal(txt);
    });
    document.getElementById('multiShareBtn').addEventListener('click', ()=> {
      if(STATE.selected.size===0) return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø');
      const txt = formatMultipleSelection('both'); doShare(txt);
    });
    document.getElementById('multiClearBtn').addEventListener('click', ()=> { STATE.selected.clear(); renderAyaList(); renderMultiBar(); });

    // open copy modal
    function openCopyModal(prefill){
      modalWindow.innerHTML = '<h3>‡¶ï‡¶™‡¶ø / ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</h3><div style="margin-top:8px"><label><input type="radio" name="fmt" value="both" checked> ‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label> &nbsp; <label><input type="radio" name="fmt" value="ar"> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</label> &nbsp; <label><input type="radio" name="fmt" value="bn"> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label></div><textarea id="copyPreview" style="width:100%;height:160px;margin-top:8px;padding:8px">'+(prefill||'')+'</textarea><div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end"><button id="copyDo" class="btn primary">Copy</button><button id="shareDo" class="btn">Share</button><button id="copyClose" class="btn">Close</button></div>';
      modalBackdrop.classList.add('show');
      document.getElementById('copyDo').onclick = ()=>{ navigator.clipboard.writeText(document.getElementById('copyPreview').value||'').then(()=>alert('Copied')); };
      document.getElementById('shareDo').onclick = ()=>{ doShare(document.getElementById('copyPreview').value||''); };
      document.getElementById('copyClose').onclick = ()=>{ modalBackdrop.classList.remove('show'); };
    }

    // settings modal (quick)
    document.getElementById('openSettings').addEventListener('click', openSettingsModal);
    function openSettingsModal(){
      modalWindow.innerHTML = '<h3>Settings</h3><div style="margin-top:8px"><label><input type="checkbox" id="cOsmani"> Show ‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ</label><br><label><input type="checkbox" id="cTawjih"> Show ‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®</label></div><div style="margin-top:8px"><label>Arabic font <input id="fArabic" type="range" min="14" max="34" value="'+STATE.fontArabic+'"></label><div style="font-size:12px;color:var(--muted)">Bangla font <input id="fBangla" type="range" min="11" max="20" value="'+STATE.fontBangla+'"></div></div><div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px"><button id="saveSt" class="btn primary">Save</button><button id="closeSt" class="btn">Close</button></div>';
      modalBackdrop.classList.add('show');
      document.getElementById('cOsmani').checked = STATE.showOsmani;
      document.getElementById('cTawjih').checked = STATE.showTawjih;
      document.getElementById('closeSt').onclick = ()=> modalBackdrop.classList.remove('show');
      document.getElementById('saveSt').onclick = ()=>{
        STATE.showOsmani = document.getElementById('cOsmani').checked;
        STATE.showTawjih = document.getElementById('cTawjih').checked;
        STATE.fontArabic = +document.getElementById('fArabic').value;
        STATE.fontBangla = +document.getElementById('fBangla').value;
        S.set('q_showOsmani',STATE.showOsmani); S.set('q_showTawjih',STATE.showTawjih);
        S.set('q_fontArabic',STATE.fontArabic); S.set('q_fontBangla',STATE.fontBangla);
        modalBackdrop.classList.remove('show'); renderAyaList();
      };
    }

    // pins modal
    document.getElementById('openPins').addEventListener('click', ()=> {
      // build simple list of pins and favs with go/copy/delete
      let body = '<h3>Pins & Favourites</h3><div style="margin-top:8px">';
      const combo = [...STATE.pins.map(p=>({kind:'pin',...p})), ...STATE.favs.map(f=>({kind:'fav',...f}))];
      if(combo.length===0) body += '<div style="color:var(--muted)">No pins or favourites</div>';
      combo.forEach(it=>{
        const s = window.suras[it.surahIndex]||{};
        const label = (it.kind==='pin'?'üìå ':'‚≠ê ')+ (s.nameBn||s.name||'') + ' ' + (it.surahIndex+1)+':'+(it.ayahIndex+1);
        body += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid var(--soft-border)"><div><strong>'+label+'</strong><div style="font-size:12px;color:var(--muted)">'+(it.note||'')+'</div></div><div style="display:flex;gap:6px"><button data-go class="btn">Go</button><button data-copy class="btn">üìã</button><button data-del class="btn">üóë</button></div></div>';
      });
      body += '</div><div style="margin-top:8px;display:flex;justify-content:flex-end"><button id="closePinsModal" class="btn">Close</button></div>';
      modalWindow.innerHTML = body;
      modalBackdrop.classList.add('show');
      modalWindow.querySelectorAll('[data-go]').forEach((b,i)=>b.addEventListener('click',()=>{ const it = combo[i]; modalBackdrop.classList.remove('show'); setCurrentSura(it.surahIndex); setTimeout(()=>{ const el=document.getElementById('aya-'+it.surahIndex+'-'+it.ayahIndex); if(el) el.scrollIntoView({behavior:'smooth',block:'center'}); },150); }));
      modalWindow.querySelectorAll('[data-copy]').forEach((b,i)=>b.addEventListener('click',()=>{ const it = combo[i]; navigator.clipboard.writeText(formatAyaForCopy(it.surahIndex,it.ayahIndex,'both')).then(()=>alert('Copied')); }));
      modalWindow.querySelectorAll('[data-del]').forEach((b,i)=>b.addEventListener('click',()=>{ const it = combo[i]; if(confirm('Delete?')){ if(it.kind==='pin'){ STATE.pins = STATE.pins.filter(x=>x.key!==it.key); S.set('q_pins',STATE.pins);} else { STATE.favs = STATE.favs.filter(x=>x.key!==it.key); S.set('q_favs',STATE.favs);} renderAyaList(); modalBackdrop.classList.remove('show'); } }));
      document.getElementById('closePinsModal').onclick = ()=> modalBackdrop.classList.remove('show');
    });

    // word popup
    function openWordPopup(target, ayah){
      const meaning = target.dataset.meaning || target.textContent || '';
      const notes = target.dataset.notes || ayah.grammar || ayah.notes || '';
      wpArabic.textContent = target.textContent || '';
      wpMeaning.textContent = meaning;
      wpNotes.textContent = notes;
      // position
      const rect = target.getBoundingClientRect();
      let top = rect.bottom + window.scrollY + 6;
      let left = rect.left + window.scrollX - 20;
      if(left + 300 > window.innerWidth) left = window.innerWidth - 320;
      if(left < 6) left = 6;
      wordPopup.style.top = top + 'px'; wordPopup.style.left = left + 'px';
      wordPopup.style.display = 'block';
    }
    wpClose.addEventListener('click', ()=> wordPopup.style.display='none');

    // close modal on backdrop click
    modalBackdrop.addEventListener('click',(ev)=>{ if(ev.target===modalBackdrop) modalBackdrop.classList.remove('show'); });

    // helper escape
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // init: set first sura
    setCurrentSura(0);

    // helper: when page loads render full drawer list for quick nav
    renderDrawerList();

    // small improvements: view toggle
    document.querySelectorAll('#viewButtons button').forEach(b=>{
      if(b.dataset.view === STATE.view) b.classList.add('primary');
      b.addEventListener('click', ()=>{ document.querySelectorAll('#viewButtons button').forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); STATE.view = b.dataset.view; S.set('q_view',STATE.view); renderAyaList(); });
    });

    // expose for debugging
    window.QAPP = { STATE, setCurrentSura };
  })();
  </script>
</body>
</html>
