<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quran WBW Viewer</title>
  <style>
    :root{
      --bg: #071226;
      --card: #071827;
      --muted: #9fb1c9;
      --accent: #56b5ff;
      --accent-soft: rgba(86,181,255,0.18);
      --accent-text: #e9f6ff;
      --arabic-size: 2.0rem;
      --bangla-size: 1.0rem;
      --notes-size: 1.02rem;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      width:100%;
      overflow-x:hidden;
    }
    body{
      font-family:"Noto Sans Bengali",system-ui,sans-serif;
      background:linear-gradient(180deg,#081226,#02101a);
      color:#e6f0fb;
      padding:12px;
    }
    .wrap{
      max-width:940px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .brand{font-weight:700;font-size:1rem}
    .right-head{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .select-sura{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);
      color:inherit;
      max-width:180px;
    }
    .settings{
      display:flex;
      gap:8px;
      align-items:center;
      background:rgba(255,255,255,0.02);
      padding:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.03);
      flex-wrap:wrap;
    }
    .settings label{
      font-size:0.9rem;
      display:flex;
      align-items:center;
      gap:6px;
    }
    input[type="checkbox"]{width:16px;height:16px}

    /* view mode button – more contrast */
    .view-mode-btn{
      border-radius:999px;
      border:1px solid var(--accent-soft);
      background:rgba(9,41,70,0.9);
      padding:7px 14px;
      font-size:0.9rem;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      color:var(--accent-text);
      box-shadow:0 4px 14px rgba(0,0,0,0.4);
    }
    .view-mode-btn span.icon{
      width:20px;height:20px;
      border-radius:999px;
      border:2px solid var(--accent);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.75rem;
      font-weight:700;
      background:rgba(11,68,110,0.9);
    }
    #viewModeText{
      font-weight:600;
      letter-spacing:0.02em;
    }

    .sliders{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:8px;
    }

    main{margin-top:4px}

    .bismillah{
      padding:10px;
      border-radius:10px;
      background:linear-gradient(180deg,#071726,#041224);
      border:1px solid rgba(120,150,190,0.06);
      text-align:center;
      margin-bottom:10px;
    }
    .bismillah .ar{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:1.25rem;
      direction:rtl;
      text-align:center;
      line-height:1.7;
    }
    .bismillah .bn{
      color:var(--muted);
      margin-top:4px;
    }

    .ayah{
      background:linear-gradient(180deg,#071226,#041018);
      padding:12px;
      border-radius:12px;
      margin-bottom:10px;
      border:1px solid rgba(120,150,190,0.04);
    }
    .ayah-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:8px;
    }
    .ayah-no{
      background:rgba(255,255,255,0.02);
      padding:6px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:0.95rem;
    }
    .ayah-mode{
      color:var(--muted);
      font-size:0.9rem;
      text-align:right;
      flex:1;
    }

    .ayah-line{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:var(--arabic-size);
      direction:rtl;
      text-align:right;
      line-height:1.6;
      margin-bottom:8px;
      word-wrap:break-word;
      overflow-wrap:break-word;
    }

    .translation{
      font-size:var(--bangla-size);
      color:var(--muted);
      margin-top:4px;
      margin-bottom:4px;
      text-align:right;
      line-height:1.6;
    }

    .words-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      justify-content:flex-end;
      direction:rtl;
      margin-bottom:4px;
    }
    .word-block{
      min-width:76px;
      max-width:180px;
      padding:8px;
      border-radius:10px;
      background:rgba(255,255,255,0.01);
      border:1px solid rgba(255,255,255,0.03);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      direction:rtl;
    }
    .word-ar{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:1.25rem;
      text-align:right;
      line-height:1.4;
      word-wrap:break-word;
    }
    .word-bn{
      font-size:0.95rem;
      color:var(--muted);
      text-align:right;
      margin-top:6px;
      line-height:1.4;
      word-wrap:break-word;
    }
    .word-block.active{
      border-color:var(--accent);
      box-shadow:0 6px 20px rgba(86,181,255,0.18);
      transform:translateY(-2px);
    }

    /* BIG fixed bottom bar for selected word */
    .selected-bar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index:15;
    }
    .selected-inner{
      pointer-events:auto;
      max-width:940px;
      width:calc(100% - 24px);
      margin-bottom:10px;
      background:#020d18;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,0.18);
      display:flex;
      align-items:flex-start;
      gap:12px;
      box-shadow:0 -8px 24px rgba(0,0,0,0.65);
    }
    .sel-text{
      text-align:right;
      flex:1;
    }
    .sel-ar{
      font-family:"Scheherazade New","Amiri",serif;
      direction:rtl;
      text-align:right;
      font-size:1.4rem;
      line-height:1.5;
      word-wrap:break-word;
    }
    .sel-bn{
      font-size:1rem;
      color:var(--muted);
      margin-top:4px;
      line-height:1.5;
      word-wrap:break-word;
    }
    .sel-btns{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      min-width:90px;
    }
    .btn-small{
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.22);
      background:rgba(255,255,255,0.06);
      padding:7px 12px;
      font-size:0.9rem;
      color:var(--accent-text);
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-small.secondary{
      background:rgba(10,25,40,0.9);
      color:var(--muted);
    }

    /* grammar modal – center fixed */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:30;
    }
    .modal{
      max-width:900px;
      width:calc(100% - 28px);
      max-height:80vh;
      background:#021426;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(255,255,255,0.18);
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow:0 18px 50px rgba(0,0,0,0.7);
    }
    .modal-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .modal-word{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:1.6rem;
      direction:rtl;
      text-align:right;
      line-height:1.6;
    }
    .modal-meaning{
      font-size:1rem;
      color:var(--muted);
      text-align:right;
      margin-top:3px;
    }
    .modal-close{
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(255,255,255,0.04);
      padding:7px 12px;
      font-size:0.9rem;
      color:var(--accent-text);
      cursor:pointer;
      white-space:nowrap;
    }
    .modal-notes{
      font-size:var(--notes-size);
      color:#e6f0fb;
      background:#021726;
      padding:8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.05);
      max-height:60vh;
      overflow:auto;
      line-height:1.7;
      word-wrap:break-word;
      overflow-wrap:break-word;
      text-align:right;
      direction:rtl;
    }

    .hidden{display:none}

    @media(max-width:640px){
      header{flex-direction:column;align-items:flex-start}
      .right-head{justify-content:space-between;width:100%}
      .word-block{min-width:60px}
      .bismillah .ar{font-size:1.1rem}
      .selected-inner{
        flex-direction:column;
        align-items:flex-end;
      }
      .sel-btns{
        flex-direction:row;
        justify-content:flex-end;
        width:100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">Quran Word-by-Word — Preview</div>
      <div class="right-head">
        <button id="viewModeBtn" class="view-mode-btn">
          <span class="icon">⯈</span>
          <span id="viewModeText">তেলাওয়াত মোড</span>
        </button>
        <select id="suraSelect" class="select-sura"></select>
        <div class="settings">
          <label><input type="checkbox" id="cbTranslation" /> বাংলা অনুবাদ</label>
          <label><input type="checkbox" id="cbGrammar" /> Grammar on click</label>
        </div>
      </div>
    </header>

    <div class="sliders">
      <div>
        <label style="font-size:0.85rem;color:var(--muted)">আরবি ফন্ট: <span id="arabicLabel">2.0rem</span></label><br>
        <input id="arabicSlider" type="range" min="1.2" max="3.0" step="0.1" value="2.0" />
      </div>
      <div>
        <label style="font-size:0.85rem;color:var(--muted)">বাংলা ফন্ট: <span id="banglaLabel">1.0rem</span></label><br>
        <input id="banglaSlider" type="range" min="0.8" max="1.8" step="0.05" value="1.0" />
      </div>
      <div>
        <label style="font-size:0.85rem;color:var(--muted)">নোট ফন্ট: <span id="notesLabel">1.02rem</span></label><br>
        <input id="notesSlider" type="range" min="0.8" max="1.6" step="0.02" value="1.02" />
      </div>
    </div>

    <main id="content">
      <section class="bismillah" id="bismillah">
        <div class="ar" id="bismillahAr"></div>
        <div class="bn" id="bismillahBn"></div>
      </section>

      <div id="ayahContainer"></div>
    </main>
  </div>

  <!-- BIG fixed bottom selected word bar -->
  <div id="selectedBar" class="selected-bar hidden">
    <div class="selected-inner">
      <div class="sel-text">
        <div id="selAr" class="sel-ar">—</div>
        <div id="selBn" class="sel-bn">—</div>
      </div>
      <div class="sel-btns">
        <button id="btnGrammar" class="btn-small">Grammar</button>
        <button id="btnClearSel" class="btn-small secondary">Clear</button>
      </div>
    </div>
  </div>

  <!-- grammar modal -->
  <div id="modalBackdrop" class="modal-backdrop hidden">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <div>
          <div id="mWord" class="modal-word">—</div>
          <div id="mMeaning" class="modal-meaning">—</div>
        </div>
        <button id="modalClose" class="modal-close">Close ✕</button>
      </div>
      <div id="mNotes" class="modal-notes">
        নোট এখানে দেখাবে।
      </div>
    </div>
  </div>

  <script>
    const TOTAL_SURA = 114;

    const suraSelect = document.getElementById('suraSelect');
    const cbTranslation = document.getElementById('cbTranslation');
    const cbGrammar = document.getElementById('cbGrammar');

    const viewModeBtn = document.getElementById('viewModeBtn');
    const viewModeText = document.getElementById('viewModeText');

    const arabicSlider = document.getElementById('arabicSlider');
    const banglaSlider = document.getElementById('banglaSlider');
    const notesSlider = document.getElementById('notesSlider');
    const arabicLabel = document.getElementById('arabicLabel');
    const banglaLabel = document.getElementById('banglaLabel');
    const notesLabel = document.getElementById('notesLabel');

    const bismillahAr = document.getElementById('bismillahAr');
    const bismillahBn = document.getElementById('bismillahBn');
    const ayahContainer = document.getElementById('ayahContainer');

    const selectedBar = document.getElementById('selectedBar');
    const selAr = document.getElementById('selAr');
    const selBn = document.getElementById('selBn');
    const btnGrammar = document.getElementById('btnGrammar');
    const btnClearSel = document.getElementById('btnClearSel');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalClose = document.getElementById('modalClose');
    const mWord = document.getElementById('mWord');
    const mMeaning = document.getElementById('mMeaning');
    const mNotes = document.getElementById('mNotes');

    let currentSurah = 104;
    let currentData = null;
    let modeWBW = false; // false = telawat, true = word-by-word
    let currentSelectedWord = null;

    function buildSuraList(){
      for(let i=1;i<=TOTAL_SURA;i++){
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `সূরা ${i}`;
        suraSelect.appendChild(opt);
      }
      suraSelect.value = currentSurah;
    }
    buildSuraList();

    function updateViewModeUI(){
      if(modeWBW){
        viewModeText.textContent = 'শব্দে-শব্দে মোড';
      }else{
        viewModeText.textContent = 'তেলাওয়াত মোড';
      }
      const icon = viewModeBtn.querySelector('.icon');
      icon.textContent = modeWBW ? '▢' : '⯈';
    }

    viewModeBtn.addEventListener('click', ()=>{
      modeWBW = !modeWBW;
      saveViewState();
      clearSelection();
      renderCurrent();
      updateViewModeUI();
    });

    function applyFontSizes(){
      const a = parseFloat(arabicSlider.value);
      const b = parseFloat(banglaSlider.value);
      const n = parseFloat(notesSlider.value);
      document.documentElement.style.setProperty('--arabic-size', a+'rem');
      document.documentElement.style.setProperty('--bangla-size', b+'rem');
      document.documentElement.style.setProperty('--notes-size', n+'rem');
      arabicLabel.textContent = a.toFixed(2)+'rem';
      banglaLabel.textContent = b.toFixed(2)+'rem';
      notesLabel.textContent = n.toFixed(2)+'rem';
      localStorage.setItem('quran_font', JSON.stringify({a,b,n}));
    }
    [arabicSlider,banglaSlider,notesSlider].forEach(sl=>{
      sl.addEventListener('input', applyFontSizes);
    });

    (function loadFonts(){
      try{
        const raw = localStorage.getItem('quran_font');
        if(raw){
          const o = JSON.parse(raw);
          if(o.a) arabicSlider.value = o.a;
          if(o.b) banglaSlider.value = o.b;
          if(o.n) notesSlider.value = o.n;
        }
      }catch(e){}
      applyFontSizes();
    })();

    function loadViewState(){
      try{
        const raw = localStorage.getItem('quran_view2');
        if(raw){
          const o = JSON.parse(raw);
          cbTranslation.checked = !!o.trans;
          cbGrammar.checked = !!o.grammar;
          modeWBW = !!o.wbw;
        }else{
          cbTranslation.checked = false;
          cbGrammar.checked = true;
          modeWBW = false;
        }
      }catch(e){}
      updateViewModeUI();
    }
    loadViewState();

    function saveViewState(){
      localStorage.setItem('quran_view2', JSON.stringify({
        trans: cbTranslation.checked,
        grammar: cbGrammar.checked,
        wbw: modeWBW
      }));
    }

    [cbTranslation,cbGrammar].forEach(cb=>{
      cb.addEventListener('change', ()=>{
        saveViewState();
        clearSelection();
        renderCurrent();
      });
    });

    suraSelect.addEventListener('change', ()=>{
      const val = parseInt(suraSelect.value,10) || 1;
      currentSurah = val;
      clearSelection();
      loadSurah(val);
    });

    function loadSurah(num){
      const path = `surah_${num}.json`;
      ayahContainer.innerHTML = '';
      bismillahAr.textContent = '';
      bismillahBn.textContent = '';
      currentData = null;

      fetch(path).then(r=>{
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      }).then(data=>{
        currentData = data;
        if(data.hasBismillah && data.bismillah){
          bismillahAr.textContent = data.bismillah.arabic || '';
          bismillahBn.textContent = data.bismillah.bangla || '';
        }else{
          bismillahAr.textContent = '';
          bismillahBn.textContent = '';
        }
        renderCurrent();
      }).catch(err=>{
        console.error('load surah error', err);
        ayahContainer.innerHTML =
          `<div style="padding:14px;background:#081722;border-radius:10px;border:1px solid #21323f;color:#f8d7da">
             সুরা ডাটা লোড করা যায়নি: ${path}
           </div>`;
      });
    }

    function renderCurrent(){
      if(!currentData) return;
      ayahContainer.innerHTML = '';
      selectedBar.classList.add('hidden');
      modalBackdrop.classList.add('hidden');
      currentSelectedWord = null;

      const showTrans = cbTranslation.checked;

      currentData.ayahs.forEach(ayah=>{
        const card = document.createElement('div');
        card.className = 'ayah';

        const head = document.createElement('div');
        head.className = 'ayah-head';
        const no = document.createElement('div');
        no.className = 'ayah-no';
        no.textContent = ayah.ayahNumber;
        const mode = document.createElement('div');
        mode.className = 'ayah-mode';
        mode.textContent = modeWBW
          ? (showTrans ? 'শব্দে-শব্দে + বাংলা' : 'শব্দে-শব্দে (শুধু আরবি)')
          : (showTrans ? 'তেলাওয়াত + বাংলা' : 'শুধু তেলাওয়াত (আরবি)');

        head.appendChild(no);
        head.appendChild(mode);
        card.appendChild(head);

        if(!modeWBW){
          const line = document.createElement('div');
          line.className = 'ayah-line';
          line.textContent = ayah.arabic || '';
          card.appendChild(line);
        }else{
          const grid = document.createElement('div');
          grid.className = 'words-grid';

          const words = Array.isArray(ayah.words) && ayah.words.length
            ? ayah.words
            : parseFallbackWords(ayah.arabic);

          words.forEach(w=>{
            const blk = document.createElement('div');
            blk.className = 'word-block';

            const ar = document.createElement('div');
            ar.className = 'word-ar';
            ar.textContent = w.text || '';

            const bn = document.createElement('div');
            bn.className = 'word-bn';
            bn.textContent = w.meaningBn || '';
            if(!showTrans) bn.style.display='none';

            blk.appendChild(ar);
            blk.appendChild(bn);

            blk.addEventListener('click', ()=>{
              document.querySelectorAll('.word-block').forEach(el=>el.classList.remove('active'));
              blk.classList.add('active');
              currentSelectedWord = w;
              updateSelectedBar();
            });

            grid.appendChild(blk);
          });

          card.appendChild(grid);
        }

        const trans = document.createElement('div');
        trans.className = 'translation';
        trans.textContent = ayah.bangla || '';
        if(!showTrans) trans.style.display='none';
        card.appendChild(trans);

        ayahContainer.appendChild(card);
      });
    }

    function parseFallbackWords(line){
      if(!line) return [];
      return line.split(/\s+/).filter(Boolean).map(p=>({text:p,meaningBn:'',notes:''}));
    }

    function updateSelectedBar(){
      if(!currentSelectedWord){
        selectedBar.classList.add('hidden');
        return;
      }
      selAr.textContent = currentSelectedWord.text || '';
      selBn.textContent = currentSelectedWord.meaningBn || '';
      selectedBar.classList.remove('hidden');
    }

    function clearSelection(){
      currentSelectedWord = null;
      selectedBar.classList.add('hidden');
      document.querySelectorAll('.word-block').forEach(el=>el.classList.remove('active'));
    }

    btnClearSel.addEventListener('click', clearSelection);

    btnGrammar.addEventListener('click', ()=>{
      if(!currentSelectedWord) return;
      if(!cbGrammar.checked) return;
      openGrammarModal(currentSelectedWord);
    });

    function openGrammarModal(word){
      mWord.textContent = word.text || '';
      mMeaning.textContent = word.meaningBn || '';
      mNotes.textContent = word.notes || word.meaningBn || 'কোনো নোট নেই।';
      modalBackdrop.classList.remove('hidden');
    }

    function closeModal(){
      modalBackdrop.classList.add('hidden');
    }

    modalClose.addEventListener('click', closeModal);

    modalBackdrop.addEventListener('click', (e)=>{
      if(e.target === modalBackdrop){
        closeModal();
      }
    });

    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape'){
        closeModal();
      }
    });

    (function init(){
      loadSurah(currentSurah);
    })();
  </script>
</body>
</html>
