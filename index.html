<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Qur'an ‚Ä¢ Word-by-Word ‚Ä¢ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∏‡¶π</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#05090f;
      --bg-alt:#0b1220;
      --bg-panel:#020617;
      --muted:#a5b4c4;
      --accent:#22c55e;
      --accent2:#38bdf8;
      --text:#e5f0ff;
      --text-soft:#cbd5f5;
      --border-soft:rgba(148,163,184,0.35);
      --danger:#fb7185;
      --gold:#fbbf24;
      --radius:14px;
      --shadow-soft:0 18px 40px rgba(0,0,0,0.65);
    }
    body.theme-dark{
      --bg:#05090f;
      --bg-alt:#0b1220;
      --bg-panel:#020617;
      --text:#e5f0ff;
      --text-soft:#cbd5f5;
    }
    body.theme-green{
      --bg:#022c22;
      --bg-alt:#064e3b;
      --bg-panel:#022c22;
      --text:#ecfdf5;
      --text-soft:#d1fae5;
    }
    body.theme-sepia{
      --bg:#f3e8d8;
      --bg-alt:#fef3c7;
      --bg-panel:#fef9c3;
      --text:#1f2933;
      --text-soft:#4b5563;
    }

    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans Bengali",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    button{font-family:inherit;cursor:pointer}

    .container{
      max-width:1140px;
      margin:10px auto;
      padding:8px;
      display:grid;
      grid-template-columns:310px 1fr;
      gap:12px;
      align-items:start;
    }

    .sidebar{
      background:var(--bg-panel);
      border-radius:12px;
      padding:10px;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
      height:calc(100vh - 40px);
      overflow:auto;
    }
    .logo{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .logo .dot{
      width:40px;height:40px;
      border-radius:12px;
      background:radial-gradient(circle at 30% 20%,#bbf7d0 0,#22c55e 35%,#16a34a 70%,#0f766e 100%);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;color:#022c22;
      box-shadow:0 6px 18px rgba(22,163,74,0.8);
    }
    .logo .title{font-weight:700;font-size:15px}
    .logo-sub{font-size:12px;color:var(--muted)}
    .panel-title{
      font-size:11px;
      color:var(--muted);
      margin-bottom:4px;
      letter-spacing:0.05em;
      text-transform:uppercase;
    }

    .search{position:relative;margin-bottom:6px}
    .search input{
      width:100%;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(15,23,42,0.8);
      color:var(--text);
      font-size:12px;
    }
    body.theme-sepia .search input{
      background:#fefce8;
      color:#111827;
    }
    .search input::placeholder{color:#64748b}

    .sura-list{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px;
    }
    .sura-item{
      padding:5px 6px;
      border-radius:10px;
      display:flex;
      flex-direction:column;
      gap:1px;
      background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(15,23,42,0.85));
      border:1px solid var(--border-soft);
      cursor:pointer;
      color:var(--text-soft);
      box-shadow:0 4px 12px rgba(15,23,42,0.7);
      transition:transform 0.1s,box-shadow 0.1s,border-color 0.1s,background 0.1s;
    }
    body.theme-sepia .sura-item{
      background:#fef3c7;
      border-color:#fcd34d;
      color:#1f2933;
    }
    .sura-item:hover{
      transform:translateY(-1px);
      border-color:var(--accent);
      box-shadow:0 6px 18px rgba(34,197,94,0.4);
    }
    .sura-item.active{
      background:linear-gradient(135deg,#22c55e,#0f172a);
      border-color:#bbf7d0;
      color:#ecfdf5;
      box-shadow:0 7px 22px rgba(34,197,94,0.6);
    }
    .sura-item .bn{font-weight:600;font-size:12px}
    .sura-item .meta{font-size:11px;color:#cbd5f5}
    .sura-item .ar{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:15px;
      text-align:right;
      color:#f9fafb;
    }

    .last-read-box{
      margin-top:6px;
      padding:7px 8px;
      border-radius:10px;
      background:linear-gradient(120deg,rgba(34,197,94,0.1),rgba(56,189,248,0.08));
      border:1px solid var(--border-soft);
      color:var(--text-soft);
      font-size:12px;
    }
    .mini-list{margin-top:8px;display:flex;flex-direction:column;gap:5px}
    .mini-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:5px 7px;
      border-radius:9px;
      background:rgba(15,23,42,0.92);
      border:1px solid var(--border-soft);
      font-size:11px;
      color:var(--text-soft);
    }
    body.theme-sepia .mini-item{
      background:#fdf4e3;
      border-color:#facc15;
      color:#1f2933;
    }

    .main{min-height:80vh}
    .header-card{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding:10px;
      border-radius:14px;
      background:linear-gradient(135deg,#0f172a,#020617);
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
    }
    body.theme-sepia .header-card{
      background:linear-gradient(135deg,#fef3c7,#fde68a);
      border-color:#fbbf24;
    }
    .sura-meta{display:flex;flex-direction:column;gap:3px}
    .sura-name{font-size:17px;font-weight:700}
    .sura-info{font-size:12px;color:var(--muted)}
    .writer-badge{
      font-size:11px;
      color:var(--text-soft);
      margin-top:2px;
    }
    .writer-badge span{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      margin-right:4px;
      font-size:11px;
    }

    .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .btn{
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(15,23,42,0.9);
      color:var(--text);
      font-size:11px;
    }
    body.theme-sepia .btn{
      background:#fefce8;
      color:#111827;
    }
    .btn.primary{
      background:linear-gradient(90deg,#22c55e,#14b8a6);
      border:none;
      color:#022c22;
      font-weight:600;
      box-shadow:0 6px 16px rgba(34,197,94,0.6);
    }
    .btn.danger{
      background:rgba(248,113,113,0.15);
      border-color:#fecaca;
      color:#fecaca;
    }

    .view-toggle{
      display:inline-flex;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--border-soft);
      background:rgba(15,23,42,0.9);
    }
    body.theme-sepia .view-toggle{
      background:#fefce8;
    }
    .view-toggle button{
      padding:5px 9px;
      background:transparent;
      border:none;
      color:#9ca3af;
      font-size:11px;
    }
    .view-toggle button.active{
      background:linear-gradient(90deg,#22c55e,#16a34a);
      color:#022c22;
      font-weight:600;
    }

    .aya-card{
      margin-top:10px;
      padding:8px;
      border-radius:14px;
      background:var(--bg-alt);
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
    }
    body.theme-sepia .aya-card{
      background:#fef3c7;
      border-color:#fbbf24;
    }
    .aya-card-header{
      display:flex;justify-content:space-between;align-items:center;font-size:12px;
    }
    .aya-list{
      margin-top:8px;
      border-radius:10px;
      overflow:auto;
      max-height:calc(100vh - 240px);
      padding-bottom:50px;
    }

    .aya-row{
      display:grid;
      grid-template-columns:38px 1fr 132px;
      gap:8px;
      padding:7px 8px;
      border-bottom:1px dashed rgba(55,65,81,0.7);
      background:rgba(15,23,42,0.9);
    }
    .aya-row:nth-child(even){background:rgba(17,24,39,0.9)}
    body.theme-sepia .aya-row{
      background:#fdf4e3;
      border-color:#fbbf24;
    }
    .aya-row:last-child{border-bottom:none}

    .aya-check{
      display:flex;align-items:flex-start;justify-content:center;padding-top:6px;
    }
    .aya-check input{width:14px;height:14px;accent-color:#22c55e}

    .aya-text{overflow:hidden}
    .aya-text-meta{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;
    }
    .aya-number{
      font-size:10px;
      color:#e5e7eb;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(15,23,42,0.95);
      border:1px solid var(--border-soft);
    }
    body.theme-sepia .aya-number{
      background:#fef9c3;
      color:#1f2933;
    }
    .aya-tags{font-size:10px;color:#facc15;display:flex;gap:5px}

    .aya-ar{
      font-family:"Scheherazade New","Amiri",serif;
      direction:rtl;
      text-align:right;
      margin-bottom:4px;
      color:#fefce8;
    }
    body.theme-sepia .aya-ar{color:#111827}

    .word-token{
      display:inline-block;
      padding:2px 5px;
      margin:0 2px;
      border-radius:999px;
      cursor:pointer;
      border:1px solid transparent;
    }
    .word-token:hover{
      background:rgba(34,197,94,0.08);
      border-color:rgba(34,197,94,0.4);
    }

    .aya-bn-main{margin-bottom:3px;}
    .aya-bn-block{
      margin-top:2px;
      padding:3px 6px;
      border-radius:6px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(148,163,184,0.4);
      font-size:12px;
    }
    body.theme-sepia .aya-bn-block{
      background:#fef9c3;
      border-color:#fcd34d;
    }
    .aya-bn-label{
      font-size:10px;
      opacity:0.8;
      margin-bottom:1px;
    }
    .aya-bn-text{
      line-height:1.7;
    }

    .aya-actions{
      display:flex;flex-direction:column;gap:5px;align-items:flex-end;font-size:11px;
    }
    .action-row{display:flex;gap:5px;flex-wrap:wrap;justify-content:flex-end}
    .icon-chip{
      padding:4px 6px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:rgba(15,23,42,0.95);
      color:var(--text-soft);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      font-size:11px;
    }
    .icon-chip.active{
      background:radial-gradient(circle at top,#fef9c3,#facc15);
      color:#422006;
      border-color:#fbbf24;
    }
    .icon-chip.fav{
      background:radial-gradient(circle at top,#fef2f2,#fecaca);
      color:#7f1d1d;
      border-color:#fecaca;
    }
    .icon-chip.main{
      background:radial-gradient(circle at top left,#22c55e,#16a34a);
      color:#022c22;
      border-color:#bbf7d0;
      font-weight:600;
    }

    .multi-bar{
      position:fixed;
      left:50%;transform:translateX(-50%);
      bottom:10px;
      padding:7px 10px;
      border-radius:999px;
      background:var(--bg-panel);
      border:1px solid var(--border-soft);
      display:none;
      gap:6px;
      z-index:60;
      align-items:center;
      box-shadow:var(--shadow-soft);
      font-size:11px;
    }
    .multi-bar.show{display:flex}
    .multi-bar .count{margin-right:4px;color:var(--text-soft)}

    .modal-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,0.82);
      display:none;
      align-items:center;justify-content:center;
      z-index:70;
      backdrop-filter:blur(8px);
    }
    .modal-backdrop.show{display:flex}
    .modal{
      background:var(--bg-panel);
      color:var(--text);
      border-radius:14px;
      max-width:900px;
      width:96%;
      max-height:90vh;
      overflow:auto;
      box-shadow:var(--shadow-soft);
      border:1px solid var(--border-soft);
    }
    .modal-header{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 12px;
      border-bottom:1px solid var(--border-soft);
    }
    .modal-title{font-weight:600;font-size:13px}
    .modal-body{padding:8px 12px;font-size:12px}
    .modal-footer{
      padding:8px 12px;
      border-top:1px solid var(--border-soft);
      display:flex;justify-content:flex-end;gap:6px;
      background:var(--bg-panel);
    }

    .word-popup{
      position:fixed;
      z-index:80;
      min-width:260px;
      max-width:320px;
      background:var(--bg-panel);
      border-radius:12px;
      padding:8px;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
      display:none;
      font-size:12px;
    }
    .word-popup .arabic{
      font-family:"Scheherazade New","Amiri",serif;
      font-size:20px;
      text-align:right;
    }
    .word-popup .meaning{margin-top:4px;font-size:13px}
    .word-popup .notes{
      margin-top:6px;
      max-height:150px;
      overflow:auto;
      font-size:11px;
      color:var(--text-soft);
    }

    textarea{
      background:var(--bg);
      color:var(--text-soft);
      border-radius:10px;
      border:1px solid var(--border-soft);
    }

    @media (max-width:980px){
      .container{grid-template-columns:1fr;padding:6px}
      .sidebar{order:2;height:auto;max-height:45vh}
      .main{order:1}
      .aya-list{max-height:none}
      .aya-row{grid-template-columns:32px 1fr}
      .aya-actions{flex-direction:row;justify-content:flex-start;align-items:flex-start;margin-top:4px}
    }
  </style>
</head>
<body class="theme-dark">
  <div class="container">
    <aside class="sidebar">
      <div class="logo">
        <div class="dot">ŸÇ</div>
        <div>
          <div class="title">Qur'an ‚Ä¢ Word-by-Word</div>
          <div class="logo-sub">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶∞‡ßç‡¶• ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü</div>
        </div>
      </div>

      <div class="panel-title">‡¶∏‡ßÇ‡¶∞‡¶æ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</div>
      <div class="search">
        <input id="suraSearch" placeholder="‡¶®‡¶æ‡¶Æ / ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." />
      </div>
      <div id="suraList" class="sura-list"></div>

      <div style="margin-top:8px" class="panel-title">‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ</div>
      <div id="lastReadBox" class="last-read-box">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§‡¶ï‡ßá ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</div>

      <div style="margin-top:8px" class="panel-title">‡¶™‡¶ø‡¶® / ‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶∂‡¶∞‡ßç‡¶ü‡¶ï‡¶æ‡¶ü</div>
      <div id="miniPins" class="mini-list"></div>
    </aside>

    <main class="main">
      <div class="header-card">
        <div class="sura-meta">
          <div class="sura-name" id="currentSuraName">‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‚Ä¶</div>
          <div class="sura-info" id="currentSuraInfo">‚Äî</div>
          <div class="writer-badge">
            <span id="wb-osmani">‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ ‚úì</span>
            <span id="wb-tawzeeh">‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‚úì</span>
          </div>
        </div>
        <div class="controls">
          <div class="view-toggle" id="viewToggle">
            <button data-view="both" class="active">‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
            <button data-view="ar">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</button>
            <button data-view="bn">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>
          </div>
          <button id="openSettings" class="btn">‚öôÔ∏è ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
          <button id="openPinsModal" class="btn">üìå ‡¶™‡¶ø‡¶® / ‚≠ê ‡¶™‡ßç‡¶∞‡¶ø‡ßü</button>
        </div>
      </div>

      <section class="aya-card">
        <div class="aya-card-header">
          <span>‡¶Ü‡ßü‡¶æ‡¶§ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</span>
          <span id="ayaCount"></span>
        </div>
        <div id="ayaList" class="aya-list"></div>
      </section>
    </main>
  </div>

  <div id="multiBar" class="multi-bar">
    <div class="count" id="multiCount">0 ‡¶ü‡¶ø ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§</div>
    <button id="multiCopy" class="btn">üìã ‡¶ï‡¶™‡¶ø</button>
    <button id="multiShare" class="btn primary">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button>
    <button id="multiClear" class="btn">‚úñ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞</button>
  </div>

  <div id="wordPopup" class="word-popup">
    <div class="arabic" id="wpArabic"></div>
    <div class="meaning" id="wpMeaning"></div>
    <div class="notes" id="wpNotes"></div>
    <div style="text-align:right;margin-top:6px">
      <button id="wpClose" class="btn">‚úï</button>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop">
    <div id="modalWindow" class="modal">
      <div class="modal-header">
        <div id="modalTitle" class="modal-title">Title</div>
        <button id="modalClose" class="btn">‚úï</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>

  <script src="suras.js"></script>

  <script>
  (function(){
    if(!window.suras || !Array.isArray(window.suras)){
      document.getElementById('currentSuraName').textContent='suras.js ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá ‡¶®‡¶æ';
      return;
    }

    const storage={
      get(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch(e){return f}},
      set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
    };

    const STATE={
      currentSuraIndex:0,
      currentSurahData:null,
      view:storage.get('q_view','both'),
      theme:storage.get('q_theme','dark'),
      showOsmani:storage.get('q_showOsmani',true),
      showTawzeeh:storage.get('q_showTawzeeh',true),
      fontArabic:storage.get('q_fontArabic',22),
      fontBanglaMain:storage.get('q_fontBanglaMain',14),
      fontOsmani:storage.get('q_fontOsmani',13),
      fontTawzeeh:storage.get('q_fontTawzeeh',13),
      fontWordMeaning:storage.get('q_fontWordMeaning',13),
      fontGrammar:storage.get('q_fontGrammar',12),
      lineHeight:storage.get('q_lineHeight',1.8),
      pins:storage.get('q_pins',[]),
      favs:storage.get('q_favs',[]),
      lastRead:storage.get('q_lastRead',null),
      selected:new Set()
    };

    applyTheme();

    const suraListEl=document.getElementById('suraList');
    const suraSearchEl=document.getElementById('suraSearch');
    const currentSuraNameEl=document.getElementById('currentSuraName');
    const currentSuraInfoEl=document.getElementById('currentSuraInfo');
    const ayaListEl=document.getElementById('ayaList');
    const ayaCountEl=document.getElementById('ayaCount');
    const miniPinsEl=document.getElementById('miniPins');
    const lastReadBoxEl=document.getElementById('lastReadBox');
    const viewToggle=document.getElementById('viewToggle');

    const wbOsmani=document.getElementById('wb-osmani');
    const wbTawzeeh=document.getElementById('wb-tawzeeh');

    const multiBar=document.getElementById('multiBar');
    const multiCount=document.getElementById('multiCount');

    const modalBackdrop=document.getElementById('modalBackdrop');
    const modalTitle=document.getElementById('modalTitle');
    const modalBody=document.getElementById('modalBody');
    const modalFooter=document.getElementById('modalFooter');

    const wordPopup=document.getElementById('wordPopup');
    const wpArabic=document.getElementById('wpArabic');
    const wpMeaning=document.getElementById('wpMeaning');
    const wpNotes=document.getElementById('wpNotes');

    function applyTheme(){
      document.body.classList.remove('theme-dark','theme-green','theme-sepia');
      if(STATE.theme==='green')document.body.classList.add('theme-green');
      else if(STATE.theme==='sepia')document.body.classList.add('theme-sepia');
      else document.body.classList.add('theme-dark');
      storage.set('q_theme',STATE.theme);
    }

    function ayahKey(s,a){return s+':'+a;}
    function findIdx(list,key){return list.findIndex(i=>i.key===key);}
    function isPinned(s,a){return findIdx(STATE.pins,ayahKey(s,a))!==-1;}
    function isFav(s,a){return findIdx(STATE.favs,ayahKey(s,a))!==-1;}
    const savePins=()=>storage.set('q_pins',STATE.pins);
    const saveFavs=()=>storage.set('q_favs',STATE.favs);

    function renderSuraList(filter=''){
      const ft=filter.trim().toLowerCase();
      suraListEl.innerHTML='';
      window.suras.forEach((s,idx)=>{
        const bn=s.nameBn||s.name_bn||s.name||'';
        const ar=s.nameAr||s.name_ar||'';
        const id=String(s.number||idx+1);
        const count=s.ayahCount||(s.ayahs?s.ayahs.length:'?');
        if(ft && !(bn.toLowerCase().includes(ft)||ar.toLowerCase().includes(ft)||id===ft))return;
        const btn=document.createElement('button');
        btn.className='sura-item'+(idx===STATE.currentSuraIndex?' active':'');
        btn.dataset.index=idx;
        btn.innerHTML='<div class="bn">'+id+'. '+bn+'</div><div class="meta">'+count+' ‡¶Ü‡ßü‡¶æ‡¶§</div><div class="ar">'+ar+'</div>';
        btn.addEventListener('click',()=>setCurrentSura(idx));
        suraListEl.appendChild(btn);
      });
    }
    suraSearchEl.addEventListener('input',()=>renderSuraList(suraSearchEl.value));

    async function setCurrentSura(idx){
      STATE.currentSuraIndex=idx;
      renderSuraList(suraSearchEl.value||'');
      const meta=window.suras[idx];
      currentSuraNameEl.textContent=(meta.number||idx+1)+'. '+(meta.nameBn||meta.name||'')+' ('+(meta.nameAr||'')+')';
      currentSuraInfoEl.textContent=(meta.revelationPlace||meta.type||'')+' ‚Ä¢ '+(meta.ayahCount||(meta.ayahs?meta.ayahs.length:'?'))+' ‡¶Ü‡ßü‡¶æ‡¶§';

      if(meta.file){
        try{
          const res=await fetch(meta.file);
          if(!res.ok)throw new Error('not ok');
          STATE.currentSurahData=await res.json();
        }catch(e){
          console.error(e);
          STATE.currentSurahData=null;
        }
      }else{
        STATE.currentSurahData=meta;
      }
      renderAyaList();
    }

    function renderAyaList(){
      ayaListEl.innerHTML='';
      const sdata=STATE.currentSurahData||{};
      const ayas=Array.isArray(sdata.ayahs)?sdata.ayahs:(sdata.ayas||[]);
      ayaCountEl.textContent=ayas.length+' ‡¶Ü‡ßü‡¶æ‡¶§';

      wbOsmani.style.opacity=STATE.showOsmani?1:0.4;
      wbTawzeeh.style.opacity=STATE.showTawzeeh?1:0.4;

      ayas.forEach((aya,idx)=>{
        const row=document.createElement('div');
        row.className='aya-row';
        row.id='aya-'+STATE.currentSuraIndex+'-'+idx;

        const checkCol=document.createElement('div');
        checkCol.className='aya-check';
        const cb=document.createElement('input');
        cb.type='checkbox';
        const key=ayahKey(STATE.currentSuraIndex,idx);
        cb.checked=STATE.selected.has(key);
        cb.addEventListener('change',()=>{
          if(cb.checked)STATE.selected.add(key);else STATE.selected.delete(key);
          updateMultiBar();
        });
        checkCol.appendChild(cb);

        const tcol=document.createElement('div');
        tcol.className='aya-text';

        const meta=document.createElement('div');
        meta.className='aya-text-meta';
        const num=document.createElement('div');
        num.className='aya-number';
        num.textContent=(STATE.currentSuraIndex+1)+':'+(idx+1);
        meta.appendChild(num);
        const tags=document.createElement('div');tags.className='aya-tags';
        if(isPinned(STATE.currentSuraIndex,idx)){const t=document.createElement('span');t.textContent='üìå';tags.appendChild(t);}
        if(isFav(STATE.currentSuraIndex,idx)){const t=document.createElement('span');t.textContent='‚≠ê';tags.appendChild(t);}
        meta.appendChild(tags);
        tcol.appendChild(meta);

        const ar=document.createElement('div');
        ar.className='aya-ar';
        ar.style.fontSize=STATE.fontArabic+'px';
        ar.style.lineHeight=STATE.lineHeight;
        if(STATE.view==='bn')ar.style.display='none';

        if(Array.isArray(aya.words)&&aya.words.length){
          aya.words.forEach(w=>{
            const span=document.createElement('span');
            span.className='word-token';
            span.textContent=w.text||w.word||'';
            span.dataset.meaning=w.meaningBn||w.meaning||'';
            span.dataset.notes=w.notes||aya.grammar||aya.grammarNotes||'';
            span.addEventListener('click',(ev)=>openWordPopup(ev.currentTarget,w,aya));
            span.style.fontSize=STATE.fontArabic+'px';
            ar.appendChild(span);
          });
        }else{
          ar.textContent=aya.arabic||aya.ar||aya.text_ar||'';
        }
        tcol.appendChild(ar);

        // Bangla sections
        if(STATE.view!=='ar'){
          const bnWrap=document.createElement('div');
          bnWrap.style.marginTop='3px';

          const mainBn=aya.bangla||aya.bn||aya.bangla_main||'';
          if(mainBn){
            const main=document.createElement('div');
            main.className='aya-bn-main';
            main.style.fontSize=STATE.fontBanglaMain+'px';
            main.style.lineHeight=STATE.lineHeight;
            main.textContent=mainBn;
            bnWrap.appendChild(main);
          }

          const os=aya.bangla_osmani||aya.osmani||aya.bn_osmani||'';
          if(os && STATE.showOsmani){
            const block=document.createElement('div');
            block.className='aya-bn-block';
            const label=document.createElement('div');
            label.className='aya-bn-label';
            label.textContent='‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ';
            const txt=document.createElement('div');
            txt.className='aya-bn-text';
            txt.style.fontSize=STATE.fontOsmani+'px';
            txt.style.lineHeight=STATE.lineHeight;
            txt.textContent=os;
            block.appendChild(label);block.appendChild(txt);
            bnWrap.appendChild(block);
          }

          const tw=aya.bangla_tawzeeh||aya.tawzeeh||aya.bn_tawzeeh||'';
          if(tw && STATE.showTawzeeh){
            const block=document.createElement('div');
            block.className='aya-bn-block';
            const label=document.createElement('div');
            label.className='aya-bn-label';
            label.textContent='‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®';
            const txt=document.createElement('div');
            txt.className='aya-bn-text';
            txt.style.fontSize=STATE.fontTawzeeh+'px';
            txt.style.lineHeight=STATE.lineHeight;
            txt.textContent=tw;
            block.appendChild(label);block.appendChild(txt);
            bnWrap.appendChild(block);
          }

          const gm=aya.grammar||aya.grammarNotes||'';
          if(gm){
            const block=document.createElement('div');
            block.className='aya-bn-block';
            const label=document.createElement('div');
            label.className='aya-bn-label';
            label.textContent='‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶∞‡¶£ ‡¶®‡ßã‡¶ü';
            const txt=document.createElement('div');
            txt.className='aya-bn-text';
            txt.style.fontSize=STATE.fontGrammar+'px';
            txt.style.lineHeight=STATE.lineHeight;
            txt.textContent=gm;
            block.appendChild(label);block.appendChild(txt);
            bnWrap.appendChild(block);
          }

          tcol.appendChild(bnWrap);
        }

        const acol=document.createElement('div');
        acol.className='aya-actions';
        const top=document.createElement('div');
        top.className='action-row';

        const pinBtn=document.createElement('button');
        pinBtn.className='icon-chip';
        pinBtn.textContent='üìå';
        if(isPinned(STATE.currentSuraIndex,idx))pinBtn.classList.add('active');
        pinBtn.addEventListener('click',()=>{
          togglePin(STATE.currentSuraIndex,idx);
          renderAyaList();renderMiniPins();
        });
        top.appendChild(pinBtn);

        const favBtn=document.createElement('button');
        favBtn.className='icon-chip';
        favBtn.textContent='‚≠ê';
        if(isFav(STATE.currentSuraIndex,idx))favBtn.classList.add('fav');
        favBtn.addEventListener('click',()=>{
          toggleFav(STATE.currentSuraIndex,idx);
          renderAyaList();renderMiniPins();
        });
        top.appendChild(favBtn);

        const copyBtn=document.createElement('button');
        copyBtn.className='icon-chip';
        copyBtn.textContent='üìã';
        copyBtn.addEventListener('click',()=>{
          const text=formatAyaForCopy(STATE.currentSuraIndex,idx,'both');
          navigator.clipboard.writeText(text).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
        });
        top.appendChild(copyBtn);

        const shareBtn=document.createElement('button');
        shareBtn.className='icon-chip';
        shareBtn.textContent='üîó';
        shareBtn.addEventListener('click',()=>{
          const text=formatAyaForCopy(STATE.currentSuraIndex,idx,'both');
          doShare(text);
        });
        top.appendChild(shareBtn);

        acol.appendChild(top);

        const lastBtn=document.createElement('button');
        lastBtn.className='icon-chip main';
        lastBtn.textContent='‚è± ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ';
        lastBtn.addEventListener('click',()=>{
          STATE.lastRead={surahIndex:STATE.currentSuraIndex,ayaIndex:idx,time:Date.now()};
          storage.set('q_lastRead',STATE.lastRead);
          renderLastRead();
          alert('‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡¶≤‡ßã');
        });
        acol.appendChild(lastBtn);

        row.appendChild(checkCol);
        row.appendChild(tcol);
        row.appendChild(acol);
        ayaListEl.appendChild(row);
      });

      updateMultiBar();
      renderMiniPins();
    }

    function openWordPopup(target,w,aya){
      const rect=target.getBoundingClientRect();
      wpArabic.textContent=w.text||target.textContent||'';
      wpMeaning.textContent=w.meaningBn||w.meaning||'‚Äî';
      wpNotes.textContent=w.notes||aya.grammar||aya.grammarNotes||'‚Äî';
      let top=rect.bottom+window.scrollY+6;
      let left=rect.left+window.scrollX-40;
      if(left+320>window.innerWidth)left=window.innerWidth-330;
      if(left<6)left=6;
      wordPopup.style.top=top+'px';
      wordPopup.style.left=left+'px';
      wordPopup.style.display='block';
    }
    document.getElementById('wpClose').onclick=()=>{wordPopup.style.display='none';};
    document.addEventListener('click',ev=>{
      if(wordPopup.style.display==='block' && !wordPopup.contains(ev.target) && !ev.target.classList.contains('word-token')){
        wordPopup.style.display='none';
      }
    });

    function togglePin(s,a){
      const key=ayahKey(s,a);
      const i=findIdx(STATE.pins,key);
      if(i>=0)STATE.pins.splice(i,1);
      else{
        const m=window.suras[s]||{};
        STATE.pins.unshift({key,surahIndex:s,ayahIndex:a,note:'',name:m.nameBn||m.name||'',createdAt:Date.now()});
      }
      savePins();
    }
    function toggleFav(s,a){
      const key=ayahKey(s,a);
      const i=findIdx(STATE.favs,key);
      if(i>=0)STATE.favs.splice(i,1);
      else{
        const m=window.suras[s]||{};
        STATE.favs.unshift({key,surahIndex:s,ayahIndex:a,note:'',name:m.nameBn||m.name||'',createdAt:Date.now()});
      }
      saveFavs();
    }

    function renderMiniPins(){
      miniPinsEl.innerHTML='';
      const combined=[...STATE.pins.map(p=>({...p,kind:'pin'})),...STATE.favs.map(f=>({...f,kind:'fav'}))].slice(0,10);
      if(!combined.length){
        miniPinsEl.innerHTML='<div style="font-size:11px;color:#9ca3af">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶ø‡¶® ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶®‡ßá‡¶á‡•§</div>';
        return;
      }
      combined.forEach(it=>{
        const s=window.suras[it.surahIndex]||{};
        const div=document.createElement('div');
        div.className='mini-item';
        div.innerHTML='<div><strong>'+(it.kind==='pin'?'üìå ':'‚≠ê ')+(s.nameBn||s.name||'')+' '+(it.surahIndex+1)+':'+(it.ayahIndex+1)+'</strong><div style="font-size:10px;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+(it.note||'')+'</div></div>';
        const right=document.createElement('div');
        const go=document.createElement('button');go.className='btn';go.textContent='‡¶Ø‡¶æ‡¶®';
        go.onclick=()=>{
          setCurrentSura(it.surahIndex);
          setTimeout(()=>{
            const el=document.getElementById('aya-'+it.surahIndex+'-'+it.ayahIndex);
            if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
          },150);
        };
        const del=document.createElement('button');del.className='btn';del.textContent='üóë';
        del.onclick=()=>{
          if(it.kind==='pin'){STATE.pins=STATE.pins.filter(x=>x.key!==it.key);savePins();}
          else{STATE.favs=STATE.favs.filter(x=>x.key!==it.key);saveFavs();}
          renderMiniPins();renderAyaList();
        };
        right.appendChild(go);right.appendChild(del);
        div.appendChild(right);
        miniPinsEl.appendChild(div);
      });
    }

    function renderLastRead(){
      if(!STATE.lastRead){
        lastReadBoxEl.textContent='‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§‡¶ï‡ßá ‡¶∂‡ßá‡¶∑ ‡¶™‡ßú‡¶æ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§';
        return;
      }
      const s=window.suras[STATE.lastRead.surahIndex]||{};
      lastReadBoxEl.innerHTML='<div style="font-weight:600">'+(s.nameBn||s.name||'')+' ‚Äî '+(STATE.lastRead.surahIndex+1)+':'+(STATE.lastRead.ayaIndex+1)+'</div><div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap"><button id="goLast" class="btn primary">‚è± ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶æ‡¶≤‡ßÅ</button><button id="clrLast" class="btn">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button></div>';
      document.getElementById('goLast').onclick=()=>{
        setCurrentSura(STATE.lastRead.surahIndex);
        setTimeout(()=>{
          const el=document.getElementById('aya-'+STATE.lastRead.surahIndex+'-'+STATE.lastRead.ayaIndex);
          if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
        },150);
      };
      document.getElementById('clrLast').onclick=()=>{
        STATE.lastRead=null;storage.set('q_lastRead',null);renderLastRead();
      };
    }

    function updateMultiBar(){
      const c=STATE.selected.size;
      if(c>0){
        multiCount.textContent=c+' ‡¶ü‡¶ø ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§';
        multiBar.classList.add('show');
      }else{
        multiBar.classList.remove('show');
      }
    }
    document.getElementById('multiCopy').onclick=()=>{
      if(!STATE.selected.size)return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶π‡ßü‡¶®‡¶ø');
      const txt=formatMultipleForCopy(Array.from(STATE.selected),'both');
      openCopyModal(txt);
    };
    document.getElementById('multiShare').onclick=()=>{
      if(!STATE.selected.size)return alert('‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡ßü‡¶æ‡¶§ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶π‡ßü‡¶®‡¶ø');
      const txt=formatMultipleForCopy(Array.from(STATE.selected),'both');
      doShare(txt);
    };
    document.getElementById('multiClear').onclick=()=>{
      STATE.selected.clear();renderAyaList();updateMultiBar();
    };

    function formatAyaForCopy(sIdx,aIdx,mode){
      const sdata=window.suras[sIdx]||{};
      let ayaData=null;
      if(STATE.currentSurahData && STATE.currentSuraIndex===sIdx){
        const arr=(STATE.currentSurahData.ayahs||STATE.currentSurahData.ayas||[]);
        ayaData=arr[aIdx]||{};
      }else{
        const entry=window.suras[sIdx]||{};
        const arr=entry.ayahs||entry.ayas||[];
        ayaData=arr[aIdx]||{};
      }
      const ar=ayaData.arabic||ayaData.ar||ayaData.text_ar||'';
      const bn=ayaData.bangla||ayaData.bn||ayaData.bangla_main||'';
      const head='['+(sdata.nameBn||sdata.name||'')+' '+(sIdx+1)+':'+(aIdx+1)+']';
      if(mode==='ar')return ar+'\\n'+head;
      if(mode==='bn')return bn+'\\n'+head;
      return ar+'\\n'+bn+'\\n'+head;
    }
    function formatMultipleForCopy(keys,mode){
      return keys.map(k=>{
        const [s,a]=k.split(':').map(Number);
        return formatAyaForCopy(s,a,mode);
      }).join('\\n\\n');
    }
    function doShare(text){
      if(navigator.share){
        navigator.share({text}).catch(()=>{
          navigator.clipboard.writeText(text).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
        });
      }else{
        navigator.clipboard.writeText(text).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
      }
    }

    function openModal(title,bodyHtml,footerHtml){
      modalTitle.innerHTML=title;
      modalBody.innerHTML=bodyHtml||'';
      modalFooter.innerHTML=footerHtml||'';
      modalBackdrop.classList.add('show');
    }
    function closeModal(){modalBackdrop.classList.remove('show');}
    document.getElementById('modalClose').onclick=closeModal;
    modalBackdrop.addEventListener('click',ev=>{if(ev.target===modalBackdrop)closeModal();});

    function openCopyModal(prefill){
      const body='<div style="margin-bottom:6px"><label style="font-weight:600;font-size:12px">‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</label><div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap"><label><input type="radio" name="copyFormat" value="both" checked> ‡¶Ü‡¶∞‡¶¨‡¶ø+‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label><label><input type="radio" name="copyFormat" value="ar"> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Ü‡¶∞‡¶¨‡¶ø</label><label><input type="radio" name="copyFormat" value="bn"> ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</label></div></div><textarea id="copyPreview" style="width:100%;min-height:130px;padding:6px;font-size:12px">'+(prefill||'')+'</textarea>';
      const footer='<button id="copyDo" class="btn primary">üìã ‡¶ï‡¶™‡¶ø</button><button id="shareDo" class="btn">üîó ‡¶∂‡ßá‡ßü‡¶æ‡¶∞</button><button id="copyClose" class="btn">‡¶¨‡¶®‡ßç‡¶ß</button>';
      openModal('‡¶ï‡¶™‡¶ø / ‡¶∂‡ßá‡ßü‡¶æ‡¶∞',body,footer);
      setTimeout(()=>{
        document.getElementById('copyDo').onclick=()=>{
          const t=document.getElementById('copyPreview').value;
          navigator.clipboard.writeText(t).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
        };
        document.getElementById('shareDo').onclick=()=>{
          const t=document.getElementById('copyPreview').value;
          doShare(t);
        };
        document.getElementById('copyClose').onclick=closeModal;
      },20);
    }

    document.getElementById('openPinsModal').onclick=()=>{
      const body='<div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap"><button id="pinsTab" class="btn primary">üìå ‡¶™‡¶ø‡¶®</button><button id="favsTab" class="btn">‚≠ê ‡¶™‡ßç‡¶∞‡¶ø‡ßü</button><input id="pinsFilter" placeholder="‡¶®‡¶æ‡¶Æ / ‡¶®‡ßã‡¶ü ‡¶¶‡¶ø‡ßü‡ßá ‡¶ñ‡ßã‡¶Å‡¶ú‡ßÅ‡¶®..." style="flex:1;min-width:120px;padding:5px 7px;border-radius:999px;border:1px solid rgba(148,163,184,0.4);background:transparent;color:inherit;font-size:11px" /></div><div id="pinsListFull"></div>';
      const footer='<button id="clearAllPins" class="btn danger">‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button><button id="closePins" class="btn">‡¶¨‡¶®‡ßç‡¶ß</button>';
      openModal('‡¶™‡¶ø‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞',body,footer);
      setTimeout(()=>{
        let tab='pins';
        const filterInput=document.getElementById('pinsFilter');
        const listDiv=document.getElementById('pinsListFull');
        document.getElementById('pinsTab').onclick=()=>{tab='pins';renderList();};
        document.getElementById('favsTab').onclick=()=>{tab='favs';renderList();};
        document.getElementById('closePins').onclick=closeModal;
        document.getElementById('clearAllPins').onclick=()=>{
          if(!confirm('‡¶∏‡¶¨ ‡¶™‡¶ø‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡ßü ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?'))return;
          STATE.pins=[];STATE.favs=[];savePins();saveFavs();renderList();renderAyaList();renderMiniPins();
        };
        filterInput.oninput=renderList;
        function renderList(){
          listDiv.innerHTML='';
          const arr=(tab==='pins'?STATE.pins:STATE.favs);
          const ft=(filterInput.value||'').trim().toLowerCase();
          const filtered=arr.filter(item=>{
            const s=window.suras[item.surahIndex]||{};
            const name=(s.nameBn||s.name||'').toLowerCase();
            return !ft||name.includes(ft)||(item.note||'').toLowerCase().includes(ft);
          });
          if(!filtered.length){
            listDiv.innerHTML='<div style="font-size:12px;color:#9ca3af">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡ßá‡¶á‡•§</div>';
            return;
          }
          filtered.forEach(item=>{
            const s=window.suras[item.surahIndex]||{};
            const wrap=document.createElement('div');
            wrap.style.padding='6px 0';
            wrap.style.borderBottom='1px solid rgba(148,163,184,0.4)';
            wrap.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;gap:6px"><div><strong>'+(s.nameBn||s.name||'')+' '+(item.surahIndex+1)+':'+(item.ayahIndex+1)+'</strong><div style="font-size:11px;color:#9ca3af">'+(item.note||'')+'</div></div><div style="display:flex;gap:4px;flex-wrap:wrap"><button class="btn" data-go>‡¶Ø‡¶æ‡¶®</button><button class="btn" data-copy>üìã</button><button class="btn" data-edit>‚úè</button><button class="btn danger" data-del>üóë</button></div></div>';
            listDiv.appendChild(wrap);
            wrap.querySelector('[data-go]').onclick=()=>{
              setCurrentSura(item.surahIndex);closeModal();
              setTimeout(()=>{
                const el=document.getElementById('aya-'+item.surahIndex+'-'+item.ayahIndex);
                if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
              },150);
            };
            wrap.querySelector('[data-copy]').onclick=()=>{
              const text=formatAyaForCopy(item.surahIndex,item.ayahIndex,'both');
              navigator.clipboard.writeText(text).then(()=>alert('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'));
            };
            wrap.querySelector('[data-del]').onclick=()=>{
              if(!confirm('‡¶è‡¶á ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Æ‡ßÅ‡¶õ‡¶¨‡ßá‡¶®?'))return;
              if(tab==='pins'){STATE.pins=STATE.pins.filter(x=>x.key!==item.key);savePins();}
              else{STATE.favs=STATE.favs.filter(x=>x.key!==item.key);saveFavs();}
              renderList();renderMiniPins();renderAyaList();
            };
            wrap.querySelector('[data-edit]').onclick=()=>{
              const n=prompt('‡¶®‡ßã‡¶ü/‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:',item.note||'');
              if(n!==null){item.note=n;if(tab==='pins')savePins();else saveFavs();renderList();renderMiniPins();}
            };
          });
        }
        renderList();
      },20);
    };

    // SETTINGS MODAL
    document.getElementById('openSettings').onclick=()=>{
      const body=
        '<div style="display:flex;flex-direction:column;gap:8px">' +
        '<div><div style="font-weight:600;font-size:12px;margin-bottom:3px">‡¶≤‡ßá‡¶ñ‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</div>' +
        '<label style="font-size:12px;display:block;margin-bottom:2px"><input type="checkbox" id="stOsmani"> ‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ‡¶∞ ‡¶≠‡¶æ‡¶¨‡¶æ‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</label>' +
        '<label style="font-size:12px;display:block"><input type="checkbox" id="stTawzeeh"> ‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</label></div>' +

        '<div><div style="font-weight:600;font-size:12px;margin-bottom:3px">‡¶•‡¶ø‡¶Æ</div>' +
        '<label style="font-size:12px;margin-right:6px"><input type="radio" name="themeSel" value="dark"> ‡¶°‡¶æ‡¶∞‡ßç‡¶ï</label>' +
        '<label style="font-size:12px;margin-right:6px"><input type="radio" name="themeSel" value="green"> ‡¶ó‡ßç‡¶∞‡ßÄ‡¶®</label>' +
        '<label style="font-size:12px"><input type="radio" name="themeSel" value="sepia"> ‡¶∏‡ßá‡¶™‡¶ø‡ßü‡¶æ</label></div>' +

        '<hr style="border-color:rgba(148,163,184,0.4)">' +
        '<div><div style="font-weight:600;font-size:12px;margin-bottom:3px">‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú</div>' +
        sliderBlock("Arabic word","stFontArabic",STATE.fontArabic,16,32) +
        sliderBlock("‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Æ‡ßÇ‡¶≤ ‡¶Ö‡¶∞‡ßç‡¶•","stFontBanglaMain",STATE.fontBanglaMain,12,20) +
        sliderBlock("‡¶§‡¶æ‡¶´‡¶∏‡ßÄ‡¶∞‡ßá ‡¶ì‡¶∏‡¶Æ‡¶æ‡¶®‡ßÄ","stFontOsmani",STATE.fontOsmani,11,20) +
        sliderBlock("‡¶§‡¶æ‡¶ì‡¶Ø‡ßÄ‡¶π‡ßÅ‡¶≤ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®","stFontTawzeeh",STATE.fontTawzeeh,11,20) +
        sliderBlock("‡¶∂‡¶¨‡ßç‡¶¶‡¶æ‡¶∞‡ßç‡¶•","stFontWordMeaning",STATE.fontWordMeaning,11,20) +
        sliderBlock("Grammar notes","stFontGrammar",STATE.fontGrammar,10,18) +
        sliderBlock("‡¶≤‡¶æ‡¶á‡¶® ‡¶π‡¶æ‡¶á‡¶ü","stLineHeight",Math.round(STATE.lineHeight*10),16,22,true) +
        '</div></div>';

      const footer='<button id="stSave" class="btn primary">‡¶∏‡ßá‡¶≠</button><button id="stCancel" class="btn">‡¶¨‡¶®‡ßç‡¶ß</button>';
      openModal('‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶ì ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏',body,footer);

      setTimeout(()=>{
        document.getElementById('stOsmani').checked=STATE.showOsmani;
        document.getElementById('stTawzeeh').checked=STATE.showTawzeeh;
        document.querySelectorAll('input[name="themeSel"]').forEach(r=>{
          if(r.value===STATE.theme)r.checked=true;
        });

        document.getElementById('stSave').onclick=()=>{
          STATE.showOsmani=document.getElementById('stOsmani').checked;
          STATE.showTawzeeh=document.getElementById('stTawzeeh').checked;
          storage.set('q_showOsmani',STATE.showOsmani);
          storage.set('q_showTawzeeh',STATE.showTawzeeh);

          const thSel=document.querySelector('input[name="themeSel"]:checked');
          if(thSel)STATE.theme=thSel.value;
          applyTheme();

          STATE.fontArabic=+document.getElementById('stFontArabic').value;
          STATE.fontBanglaMain=+document.getElementById('stFontBanglaMain').value;
          STATE.fontOsmani=+document.getElementById('stFontOsmani').value;
          STATE.fontTawzeeh=+document.getElementById('stFontTawzeeh').value;
          STATE.fontWordMeaning=+document.getElementById('stFontWordMeaning').value;
          STATE.fontGrammar=+document.getElementById('stFontGrammar').value;
          STATE.lineHeight=(+document.getElementById('stLineHeight').value)/10;

          storage.set('q_fontArabic',STATE.fontArabic);
          storage.set('q_fontBanglaMain',STATE.fontBanglaMain);
          storage.set('q_fontOsmani',STATE.fontOsmani);
          storage.set('q_fontTawzeeh',STATE.fontTawzeeh);
          storage.set('q_fontWordMeaning',STATE.fontWordMeaning);
          storage.set('q_fontGrammar',STATE.fontGrammar);
          storage.set('q_lineHeight',STATE.lineHeight);

          renderAyaList();
          closeModal();
        };
        document.getElementById('stCancel').onclick=closeModal;
      },20);
    };

    function sliderBlock(label,id,val,min,max,isLH){
      return '<div style="margin-top:4px"><div style="font-size:11px;margin-bottom:2px">'+label+
        ' <span id="'+id+'Val" style="opacity:0.7">'+(isLH?(val/10).toFixed(1):val)+'px</span></div>'+
        '<input type="range" id="'+id+'" min="'+min+'" max="'+max+'" value="'+val+'" style="width:100%"></div>';
    }

    viewToggle.querySelectorAll('button').forEach(btn=>{
      if(btn.dataset.view===STATE.view)btn.classList.add('active');
      btn.onclick=()=>{
        viewToggle.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        STATE.view=btn.dataset.view;
        storage.set('q_view',STATE.view);
        renderAyaList();
      };
    });

    document.getElementById('multiCount'); // just to avoid unused

    renderSuraList();
    setCurrentSura(0);
    STATE.lastRead=storage.get('q_lastRead',null);
    renderLastRead();
    renderMiniPins();

    window.QURAN_APP={STATE,setCurrentSura,renderAyaList};

  })();
  </script>
</body>
</html>
